<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>RockRunner â€” Dispatch Board</title>
<link rel="manifest" href="manifest.json">
<style>
:root {
  --navy: #001F3F;
  --navy-light: #0a2d52;
  --navy-dark: #001530;
  --orange: #C65D2A;
  --orange-dim: rgba(198,93,42,0.15);
  --green: #22c55e;
  --green-dim: rgba(34,197,94,0.12);
  --yellow: #eab308;
  --yellow-dim: rgba(234,179,8,0.12);
  --blue: #3b82f6;
  --blue-dim: rgba(59,130,246,0.12);
  --red: #ef4444;
  --red-dim: rgba(239,68,68,0.12);
  --purple: #a855f7;
  --purple-dim: rgba(168,85,247,0.12);
  --surface: #0f1923;
  --surface2: #162230;
  --border: #1e3347;
  --text: #e4e8ef;
  --text-dim: #7a8da0;
  --text-muted: #4a5d73;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
  background: var(--navy-dark);
  color: var(--text);
  overflow-x: hidden;
}

/* â”€â”€â”€ TOP BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.topbar {
  background: var(--navy);
  border-bottom: 1px solid var(--border);
  padding: 12px 20px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  position: sticky;
  top: 0;
  z-index: 100;
}
.topbar-left {
  display: flex;
  align-items: center;
  gap: 14px;
}
.topbar-logo {
  height: 36px;
  border-radius: 6px;
}
.topbar-title {
  font-size: 18px;
  font-weight: 700;
  color: var(--orange);
  letter-spacing: -0.3px;
}
.topbar-sub {
  font-size: 12px;
  color: var(--text-dim);
}
.topbar-right {
  display: flex;
  align-items: center;
  gap: 12px;
}

/* â”€â”€â”€ DATE NAV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.date-nav {
  display: flex;
  align-items: center;
  gap: 8px;
}
.date-nav button {
  background: var(--surface2);
  border: 1px solid var(--border);
  color: var(--text);
  width: 34px;
  height: 34px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: background 0.15s;
}
.date-nav button:hover { background: var(--navy-light); }
.date-label {
  font-size: 15px;
  font-weight: 600;
  min-width: 180px;
  text-align: center;
  cursor: pointer;
}
.date-label:hover { color: var(--orange); }
.today-btn {
  background: var(--orange) !important;
  border-color: var(--orange) !important;
  color: #fff !important;
  font-size: 12px !important;
  font-weight: 600;
  width: auto !important;
  padding: 0 12px;
}

/* â”€â”€â”€ ACTION BUTTONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.btn {
  padding: 8px 16px;
  border-radius: 8px;
  border: 1px solid var(--border);
  background: var(--surface2);
  color: var(--text);
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.15s;
  display: flex;
  align-items: center;
  gap: 6px;
}
.btn:hover { background: var(--navy-light); border-color: var(--text-muted); }
.btn-primary { background: var(--orange); border-color: var(--orange); color: #fff; }
.btn-primary:hover { background: #d4693a; }
.btn-success { background: var(--green); border-color: var(--green); color: #fff; }
.btn-success:hover { background: #1aaf52; }
.btn-danger { background: var(--red); border-color: var(--red); color: #fff; }

/* â”€â”€â”€ LAYOUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.main-layout {
  display: grid;
  grid-template-columns: 320px 1fr;
  height: calc(100vh - 61px);
}

/* â”€â”€â”€ LEFT PANEL â€” UNASSIGNED QUEUE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.queue-panel {
  background: var(--surface);
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  overflow: hidden;
}
.queue-header {
  padding: 16px 18px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.queue-header h2 {
  font-size: 14px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.8px;
  color: var(--text-dim);
}
.queue-count {
  background: var(--orange);
  color: #fff;
  font-size: 12px;
  font-weight: 700;
  padding: 2px 8px;
  border-radius: 10px;
  min-width: 24px;
  text-align: center;
}
.queue-list {
  flex: 1;
  overflow-y: auto;
  padding: 12px;
  display: flex;
  flex-direction: column;
  gap: 8px;
}
.queue-empty {
  text-align: center;
  padding: 40px 20px;
  color: var(--text-muted);
  font-size: 14px;
}

/* â”€â”€â”€ DELIVERY CARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.delivery-card {
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 12px 14px;
  cursor: grab;
  transition: all 0.15s;
  position: relative;
}
.delivery-card:active { cursor: grabbing; }
.delivery-card:hover { border-color: var(--orange); }
.delivery-card.dragging {
  opacity: 0.5;
  transform: scale(0.96);
}
.delivery-card .source-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  display: inline-block;
  margin-right: 6px;
}
.source-tgr { background: var(--green); }
.source-yard { background: var(--yellow); }
.source-tc { background: var(--blue); }
.delivery-card .card-customer {
  font-size: 14px;
  font-weight: 600;
  margin-bottom: 4px;
  display: flex;
  align-items: center;
}
.delivery-card .card-material {
  font-size: 12px;
  color: var(--text-dim);
  margin-bottom: 4px;
}
.delivery-card .card-address {
  font-size: 11px;
  color: var(--text-muted);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.delivery-card .card-tons {
  position: absolute;
  top: 12px;
  right: 14px;
  font-size: 13px;
  font-weight: 700;
  color: var(--orange);
}

/* Scheduled card (inside truck lane) */
.delivery-card.scheduled {
  border-left: 3px solid var(--blue);
}
.delivery-card.en-route {
  border-left: 3px solid var(--purple);
}
.delivery-card.delivered {
  border-left: 3px solid var(--green);
  opacity: 0.7;
}

/* â”€â”€â”€ RIGHT PANEL â€” TRUCK LANES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.board-panel {
  overflow-x: auto;
  overflow-y: auto;
  padding: 16px;
}
.board-panel-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 16px;
}
.board-panel-header h2 {
  font-size: 14px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.8px;
  color: var(--text-dim);
}

.truck-lanes {
  display: flex;
  gap: 14px;
  min-height: calc(100vh - 160px);
}

.truck-lane {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  min-width: 280px;
  width: 280px;
  flex-shrink: 0;
  display: flex;
  flex-direction: column;
}
.lane-header {
  padding: 14px 16px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.lane-truck-info {
  display: flex;
  align-items: center;
  gap: 10px;
}
.lane-truck-icon {
  width: 36px;
  height: 36px;
  border-radius: 8px;
  background: var(--orange-dim);
  color: var(--orange);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
}
.lane-truck-name {
  font-size: 15px;
  font-weight: 700;
}
.lane-truck-cap {
  font-size: 11px;
  color: var(--text-dim);
}
.lane-truck-load {
  font-size: 12px;
  font-weight: 600;
}
.lane-load-ok { color: var(--green); }
.lane-load-warn { color: var(--yellow); }
.lane-load-over { color: var(--red); }

.lane-body {
  flex: 1;
  padding: 10px;
  display: flex;
  flex-direction: column;
  gap: 8px;
  min-height: 200px;
  transition: background 0.15s;
}
.lane-body.drag-over {
  background: rgba(198,93,42,0.06);
  border-radius: 0 0 12px 12px;
}
.lane-empty {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--text-muted);
  font-size: 13px;
  border: 2px dashed var(--border);
  border-radius: 8px;
  padding: 30px;
  text-align: center;
}

/* â”€â”€â”€ ADD TRUCK LANE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.add-truck-lane {
  min-width: 200px;
  width: 200px;
  border: 2px dashed var(--border);
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.15s;
  color: var(--text-muted);
  font-size: 14px;
  flex-shrink: 0;
}
.add-truck-lane:hover {
  border-color: var(--orange);
  color: var(--orange);
}

/* â”€â”€â”€ MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.7);
  z-index: 1000;
  display: none;
  align-items: center;
  justify-content: center;
  padding: 20px;
}
.modal-overlay.active { display: flex; }
.modal {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 14px;
  width: 100%;
  max-width: 480px;
  max-height: 90vh;
  overflow-y: auto;
}
.modal-header {
  padding: 18px 22px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.modal-header h3 { font-size: 17px; font-weight: 700; }
.modal-close {
  background: none;
  border: none;
  color: var(--text-dim);
  font-size: 22px;
  cursor: pointer;
}
.modal-body { padding: 20px 22px; }
.modal-footer {
  padding: 14px 22px;
  border-top: 1px solid var(--border);
  display: flex;
  justify-content: flex-end;
  gap: 10px;
}

/* â”€â”€â”€ FORM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.form-group { margin-bottom: 16px; }
.form-label {
  display: block;
  font-size: 12px;
  font-weight: 600;
  color: var(--text-dim);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 6px;
}
.form-input, .form-select {
  width: 100%;
  padding: 10px 14px;
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 8px;
  color: var(--text);
  font-size: 14px;
  font-family: inherit;
  transition: border-color 0.15s;
}
.form-input:focus, .form-select:focus {
  outline: none;
  border-color: var(--orange);
}
.form-select { cursor: pointer; }
.form-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
}

/* â”€â”€â”€ STATS BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.stats-bar {
  display: flex;
  gap: 16px;
  padding: 10px 20px;
  background: var(--surface);
  border-bottom: 1px solid var(--border);
}
.stat-item {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 13px;
}
.stat-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
}
.stat-num {
  font-weight: 700;
  color: var(--text);
}
.stat-label { color: var(--text-dim); }

/* â”€â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.toast {
  position: fixed;
  bottom: 24px;
  right: 24px;
  background: var(--green);
  color: #fff;
  padding: 12px 20px;
  border-radius: 10px;
  font-size: 14px;
  font-weight: 600;
  z-index: 2000;
  transform: translateY(100px);
  opacity: 0;
  transition: all 0.3s;
}
.toast.show { transform: translateY(0); opacity: 1; }
.toast.error { background: var(--red); }

/* â”€â”€â”€ SCROLLBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

@media (max-width: 768px) {
  .main-layout { grid-template-columns: 1fr; }
  .queue-panel { max-height: 40vh; }
  .stats-bar { flex-wrap: wrap; gap: 10px; }
}
</style>
</head>
<body>

<!-- â•â•â• TOP BAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="topbar">
  <div class="topbar-left">
    <img src="logo.jpg" alt="RockRunner" class="topbar-logo">
    <div>
      <div class="topbar-title">RockRunner Logistics</div>
      <div class="topbar-sub">Dispatch Board</div>
    </div>
  </div>
  <div class="topbar-right">
    <div class="date-nav">
      <button onclick="changeDate(-1)">â€¹</button>
      <button class="today-btn" onclick="goToday()">Today</button>
      <span class="date-label" id="dateLabel" onclick="pickDate()"></span>
      <button onclick="changeDate(1)">â€º</button>
    </div>
    <button class="btn btn-primary" onclick="openAddDelivery()">+ Delivery</button>
    <button class="btn btn-success" id="finalizeBtn" onclick="finalizeSchedule()">ðŸ“¤ Finalize &amp; Notify</button>
  </div>
</div>

<!-- â•â•â• STATS BAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="stats-bar">
  <div class="stat-item"><div class="stat-dot" style="background:var(--orange)"></div><span class="stat-num" id="statUnassigned">0</span><span class="stat-label">Unassigned</span></div>
  <div class="stat-item"><div class="stat-dot" style="background:var(--blue)"></div><span class="stat-num" id="statScheduled">0</span><span class="stat-label">Scheduled</span></div>
  <div class="stat-item"><div class="stat-dot" style="background:var(--purple)"></div><span class="stat-num" id="statEnRoute">0</span><span class="stat-label">En Route</span></div>
  <div class="stat-item"><div class="stat-dot" style="background:var(--green)"></div><span class="stat-num" id="statDelivered">0</span><span class="stat-label">Delivered</span></div>
  <div class="stat-item" style="margin-left:auto;"><span class="stat-num" id="statTons">0</span><span class="stat-label">Total Tons</span></div>
</div>

<!-- â•â•â• MAIN LAYOUT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="main-layout">

  <!-- LEFT: Unassigned Queue -->
  <div class="queue-panel">
    <div class="queue-header">
      <h2>Unassigned</h2>
      <span class="queue-count" id="queueCount">0</span>
    </div>
    <div class="queue-list" id="queueList">
      <div class="queue-empty">No unassigned deliveries<br><small>Add one with + Delivery</small></div>
    </div>
  </div>

  <!-- RIGHT: Truck Lanes -->
  <div class="board-panel">
    <div id="truckLanes" class="truck-lanes">
      <!-- Truck lanes render here -->
      <div class="add-truck-lane" onclick="openAddTruck()">
        + Add Truck
      </div>
    </div>
  </div>

</div>

<!-- â•â•â• ADD DELIVERY MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-overlay" id="deliveryModal">
  <div class="modal">
    <div class="modal-header">
      <h3>New Delivery</h3>
      <button class="modal-close" onclick="closeModal('deliveryModal')">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">Source</label>
        <select class="form-select" id="delSource">
          <option value="Yard Sale">Yard Sale</option>
          <option value="Texas Got Rocks">Texas Got Rocks</option>
          <option value="T&C Materials">T&C Materials</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Customer Name *</label>
        <input class="form-input" id="delCustomer" placeholder="John Smith">
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Phone</label>
          <input class="form-input" id="delPhone" placeholder="(936) 555-0123" type="tel">
        </div>
        <div class="form-group">
          <label class="form-label">Email</label>
          <input class="form-input" id="delEmail" placeholder="customer@email.com" type="email">
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Delivery Address *</label>
        <input class="form-input" id="delAddress" placeholder="123 Main St">
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">City</label>
          <input class="form-input" id="delCity" placeholder="Conroe">
        </div>
        <div class="form-group">
          <label class="form-label">ZIP</label>
          <input class="form-input" id="delZip" placeholder="77301">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Material *</label>
          <select class="form-select" id="delMaterial">
            <option value="">Loading...</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Quantity (tons) *</label>
          <input class="form-input" id="delQty" type="number" step="0.5" min="0.5" placeholder="8">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Delivery Date *</label>
          <input class="form-input" id="delDate" type="date">
        </div>
        <div class="form-group">
          <label class="form-label">Time Window</label>
          <select class="form-select" id="delTime">
            <option value="">Assign later</option>
            <option value="6:00 AM - 8:00 AM">6:00 AM - 8:00 AM</option>
            <option value="8:00 AM - 10:00 AM">8:00 AM - 10:00 AM</option>
            <option value="10:00 AM - 12:00 PM">10:00 AM - 12:00 PM</option>
            <option value="12:00 PM - 2:00 PM">12:00 PM - 2:00 PM</option>
            <option value="2:00 PM - 4:00 PM">2:00 PM - 4:00 PM</option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Notes</label>
        <input class="form-input" id="delNotes" placeholder="Gate code, special instructions...">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeModal('deliveryModal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveDelivery()">Add Delivery</button>
    </div>
  </div>
</div>

<!-- â•â•â• ADD TRUCK MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-overlay" id="truckModal">
  <div class="modal">
    <div class="modal-header">
      <h3 id="truckModalTitle">Add Truck</h3>
      <button class="modal-close" onclick="closeModal('truckModal')">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">Truck Number *</label>
        <input class="form-input" id="truckNumber" placeholder="TC-001">
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Type</label>
          <select class="form-select" id="truckType">
            <option value="End Dump">End Dump</option>
            <option value="Tandem">Tandem</option>
            <option value="Semi">Semi</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Capacity (tons)</label>
          <input class="form-input" id="truckCap" type="number" value="24">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Default Driver Name</label>
          <input class="form-input" id="truckDriver" placeholder="Driver name">
        </div>
        <div class="form-group">
          <label class="form-label">Driver Phone</label>
          <input class="form-input" id="truckDriverPhone" placeholder="(936) 555-0123" type="tel">
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeModal('truckModal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveTruck()">Save Truck</button>
    </div>
  </div>
</div>

<!-- â•â•â• DELIVERY DETAIL MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-overlay" id="detailModal">
  <div class="modal">
    <div class="modal-header">
      <h3>Delivery Details</h3>
      <button class="modal-close" onclick="closeModal('detailModal')">&times;</button>
    </div>
    <div class="modal-body" id="detailBody"></div>
    <div class="modal-footer" id="detailFooter"></div>
  </div>
</div>

<!-- â•â•â• TOAST â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="toast" id="toast"></div>

<!-- Hidden date picker -->
<input type="date" id="hiddenDatePicker" style="position:fixed;top:-100px;left:-100px;opacity:0;">

<script>
// â”€â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const API = '/.netlify/functions';
let currentDate = new Date();
let trucks = [];
let deliveries = [];
let products = [];
let dragData = null;

// â”€â”€â”€ SOURCE HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getSourceClass(source) {
  if (source === 'Texas Got Rocks' || source === 'texasgotrocks') return 'source-tgr';
  if (source === 'Yard Sale' || source === 'YardTrackPro') return 'source-yard';
  return 'source-tc';
}

function getSourceColor(source) {
  if (source === 'Texas Got Rocks' || source === 'texasgotrocks') return 'var(--green)';
  if (source === 'Yard Sale' || source === 'YardTrackPro') return 'var(--yellow)';
  return 'var(--blue)';
}

function fmtTons(val) {
  return val ? parseFloat(val).toFixed(2) : '?';
}

// â”€â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('DOMContentLoaded', () => {
  renderDateLabel();
  loadAll();
});

async function loadAll() {
  await Promise.all([loadTrucks(), loadProducts()]);
  await loadDeliveries();
  render();
}

// â”€â”€â”€ DATA LOADING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadTrucks() {
  try {
    const r = await fetch(`${API}/trucks`);
    const d = await r.json();
    trucks = d.success ? (d.trucks || []) : [];
  } catch(e) { trucks = []; console.error('Truck load error:', e); }
}

async function loadDeliveries() {
  try {
    const dateStr = formatDateISO(currentDate);
    // Load both the specific date AND all unassigned for any date
    const [dateRes, unassRes] = await Promise.all([
      fetch(`${API}/dispatch?date=${dateStr}`),
      fetch(`${API}/dispatch?status=UNASSIGNED`)
    ]);
    const dateData = await dateRes.json();
    const unassData = await unassRes.json();

    // Merge: all unassigned + all for current date (deduplicated)
    const dateDeliveries = dateData.deliveries || [];
    const unassDeliveries = unassData.deliveries || [];
    const all = [...dateDeliveries];
    const dateIds = new Set(dateDeliveries.map(d => d._id));
    for (const u of unassDeliveries) {
      if (!dateIds.has(u._id)) all.push(u);
    }
    deliveries = all;
  } catch(e) { deliveries = []; console.error('Delivery load error:', e); }
}

async function loadProducts() {
  try {
    const r = await fetch(`${API}/products`);
    const d = await r.json();
    products = d.products || d || [];
    populateMaterialDropdown();
  } catch(e) { products = []; console.error('Products load error:', e); }
}

function populateMaterialDropdown() {
  const sel = document.getElementById('delMaterial');
  sel.innerHTML = '<option value="">Select material</option>';
  const items = Array.isArray(products) ? products : [];
  items.filter(p => p.active !== false).forEach(p => {
    sel.innerHTML += `<option value="${p._id}" data-name="${p.name}">${p.name}</option>`;
  });
}

// â”€â”€â”€ RENDERING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function render() {
  renderQueue();
  renderTruckLanes();
  renderStats();
}

function renderQueue() {
  const list = document.getElementById('queueList');
  const unassigned = deliveries.filter(d => d.status === 'UNASSIGNED');
  document.getElementById('queueCount').textContent = unassigned.length;

  if (!unassigned.length) {
    list.innerHTML = '<div class="queue-empty">No unassigned deliveries<br><small>Add one with + Delivery</small></div>';
    return;
  }

  list.innerHTML = unassigned.map(d => renderDeliveryCard(d, true)).join('');
}

function renderDeliveryCard(d, draggable = true) {
  const sourceClass = getSourceClass(d.source);
  const statusClass = d.status === 'SCHEDULED' ? 'scheduled' : d.status === 'EN_ROUTE' ? 'en-route' : d.status === 'DELIVERED' ? 'delivered' : '';

  return `<div class="delivery-card ${statusClass}" 
    ${draggable ? `draggable="true" ondragstart="onDragStart(event,'${d._id}')" ondragend="onDragEnd(event)"` : ''}
    onclick="showDetail('${d._id}')">
    <div class="card-customer"><span class="source-dot ${sourceClass}"></span>${d.customerName || 'Unknown'}</div>
    <div class="card-material">${d.materialName || 'Material TBD'} â€” ${fmtTons(d.quantity)} tons</div>
    <div class="card-address">${d.deliveryCity || d.deliveryAddress || 'No address'}${d.timeWindow ? ' Â· ' + d.timeWindow : ''}</div>
    <div class="card-tons">${fmtTons(d.quantity)}T</div>
  </div>`;
}

function renderTruckLanes() {
  const container = document.getElementById('truckLanes');
  const dateStr = formatDateISO(currentDate);

  const lanesHTML = trucks.map(truck => {
    const truckDeliveries = deliveries.filter(d =>
      d.truckId === truck._id && d.deliveryDate === dateStr && d.status !== 'CANCELLED'
    ).sort((a,b) => (a.stopOrder || 99) - (b.stopOrder || 99));

    const totalTons = truckDeliveries.reduce((s, d) => s + (d.quantity || 0), 0);
    const loadClass = totalTons > truck.capacity ? 'lane-load-over' : totalTons > truck.capacity * 0.8 ? 'lane-load-warn' : 'lane-load-ok';
    const driverName = truck.defaultDriver ? truck.defaultDriver.name : 'No driver';

    const cardsHTML = truckDeliveries.length
      ? truckDeliveries.map(d => renderDeliveryCard(d, d.status === 'SCHEDULED')).join('')
      : `<div class="lane-empty">Drop deliveries here</div>`;

    return `<div class="truck-lane">
      <div class="lane-header">
        <div class="lane-truck-info">
          <div class="lane-truck-icon">ðŸš›</div>
          <div>
            <div class="lane-truck-name">${truck.truckNumber}</div>
            <div class="lane-truck-cap">${truck.type} Â· ${truck.capacity}T Â· ${driverName}</div>
          </div>
        </div>
        <div class="lane-truck-load ${loadClass}">${totalTons.toFixed(2)}/${truck.capacity}T</div>
      </div>
      <div class="lane-body" 
        ondragover="onDragOver(event)" 
        ondragleave="onDragLeave(event)" 
        ondrop="onDrop(event,'${truck._id}','${truck.truckNumber}')">
        ${cardsHTML}
      </div>
    </div>`;
  }).join('');

  container.innerHTML = lanesHTML + '<div class="add-truck-lane" onclick="openAddTruck()">+ Add Truck</div>';
}

function renderStats() {
  const dateStr = formatDateISO(currentDate);
  const dayDeliveries = deliveries.filter(d => d.deliveryDate === dateStr && d.status !== 'CANCELLED');
  const unassigned = deliveries.filter(d => d.status === 'UNASSIGNED');

  document.getElementById('statUnassigned').textContent = unassigned.length;
  document.getElementById('statScheduled').textContent = dayDeliveries.filter(d => d.status === 'SCHEDULED').length;
  document.getElementById('statEnRoute').textContent = dayDeliveries.filter(d => d.status === 'EN_ROUTE').length;
  document.getElementById('statDelivered').textContent = dayDeliveries.filter(d => d.status === 'DELIVERED').length;
  document.getElementById('statTons').textContent = dayDeliveries.reduce((s, d) => s + (d.quantity || 0), 0).toFixed(2);
}

// â”€â”€â”€ DRAG & DROP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function onDragStart(e, deliveryId) {
  dragData = deliveryId;
  e.target.classList.add('dragging');
  e.dataTransfer.effectAllowed = 'move';
}

function onDragEnd(e) {
  e.target.classList.remove('dragging');
  dragData = null;
}

function onDragOver(e) {
  e.preventDefault();
  e.dataTransfer.dropEffect = 'move';
  e.currentTarget.classList.add('drag-over');
}

function onDragLeave(e) {
  e.currentTarget.classList.remove('drag-over');
}

async function onDrop(e, truckId, truckNumber) {
  e.preventDefault();
  e.currentTarget.classList.remove('drag-over');
  if (!dragData) return;

  const deliveryId = dragData;
  dragData = null;

  // Find truck's driver info
  const truck = trucks.find(t => t._id === truckId);
  const driverName = truck?.defaultDriver?.name || null;
  const driverId = truck?.defaultDriver?.id || null;

  // Count existing stops for this truck on this date to set stop order
  const dateStr = formatDateISO(currentDate);
  const existingStops = deliveries.filter(d => d.truckId === truckId && d.deliveryDate === dateStr && d.status !== 'CANCELLED');

  try {
    const r = await fetch(`${API}/dispatch`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        id: deliveryId,
        truckId,
        truckNumber,
        driverId,
        driverName,
        deliveryDate: dateStr,
        stopOrder: existingStops.length + 1,
        status: 'SCHEDULED',
        updatedBy: 'dispatcher'
      })
    });
    const data = await r.json();
    if (data.success) {
      toast('Delivery assigned to ' + truckNumber);
      await loadDeliveries();
      render();
    }
  } catch(e) { toast('Error assigning delivery', true); console.error(e); }
}

// â”€â”€â”€ DATE NAVIGATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function formatDateISO(d) {
  return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
}

function renderDateLabel() {
  const days = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
  const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const label = `${days[currentDate.getDay()]}, ${months[currentDate.getMonth()]} ${currentDate.getDate()}, ${currentDate.getFullYear()}`;
  document.getElementById('dateLabel').textContent = label;
}

function changeDate(delta) {
  currentDate.setDate(currentDate.getDate() + delta);
  renderDateLabel();
  loadDeliveries().then(render);
}

function goToday() {
  currentDate = new Date();
  renderDateLabel();
  loadDeliveries().then(render);
}

function pickDate() {
  const picker = document.getElementById('hiddenDatePicker');
  picker.value = formatDateISO(currentDate);
  picker.showPicker();
  picker.onchange = () => {
    currentDate = new Date(picker.value + 'T12:00:00');
    renderDateLabel();
    loadDeliveries().then(render);
  };
}

// â”€â”€â”€ MODALS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openModal(id) { document.getElementById(id).classList.add('active'); }
function closeModal(id) { document.getElementById(id).classList.remove('active'); }

function openAddDelivery() {
  document.getElementById('delDate').value = formatDateISO(currentDate);
  openModal('deliveryModal');
}

function openAddTruck() {
  document.getElementById('truckNumber').value = '';
  document.getElementById('truckCap').value = '24';
  document.getElementById('truckDriver').value = '';
  document.getElementById('truckDriverPhone').value = '';
  document.getElementById('truckModalTitle').textContent = 'Add Truck';
  openModal('truckModal');
}

// â”€â”€â”€ SAVE DELIVERY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function saveDelivery() {
  const customer = document.getElementById('delCustomer').value.trim();
  const materialSel = document.getElementById('delMaterial');
  const qty = document.getElementById('delQty').value;
  const date = document.getElementById('delDate').value;

  if (!customer || !materialSel.value || !qty || !date) {
    toast('Please fill required fields', true);
    return;
  }

  const materialName = materialSel.options[materialSel.selectedIndex].dataset.name || materialSel.options[materialSel.selectedIndex].text;

  const body = {
    source: document.getElementById('delSource').value,
    customerName: customer,
    customerPhone: document.getElementById('delPhone').value.trim(),
    customerEmail: document.getElementById('delEmail').value.trim(),
    deliveryAddress: document.getElementById('delAddress').value.trim(),
    deliveryCity: document.getElementById('delCity').value.trim(),
    deliveryZip: document.getElementById('delZip').value.trim(),
    productId: materialSel.value,
    materialName: materialName,
    quantity: parseFloat(qty),
    deliveryDate: date,
    timeWindow: document.getElementById('delTime').value || null,
    deliveryNotes: document.getElementById('delNotes').value.trim(),
    createdBy: 'dispatcher'
  };

  try {
    const r = await fetch(`${API}/dispatch`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });
    const data = await r.json();
    if (data.success) {
      toast('Delivery added');
      closeModal('deliveryModal');
      // Clear form
      ['delCustomer','delPhone','delEmail','delAddress','delCity','delZip','delQty','delNotes'].forEach(id => document.getElementById(id).value = '');
      await loadDeliveries();
      render();
    }
  } catch(e) { toast('Error saving delivery', true); console.error(e); }
}

// â”€â”€â”€ SAVE TRUCK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function saveTruck() {
  const num = document.getElementById('truckNumber').value.trim();
  const cap = document.getElementById('truckCap').value;
  if (!num) { toast('Truck number required', true); return; }

  const body = {
    truckNumber: num,
    type: document.getElementById('truckType').value,
    capacity: parseFloat(cap) || 24,
    defaultDriver: null
  };

  const driverName = document.getElementById('truckDriver').value.trim();
  if (driverName) {
    body.defaultDriver = {
      name: driverName,
      phone: document.getElementById('truckDriverPhone').value.trim(),
      id: driverName.toLowerCase().replace(/\s+/g, '-')
    };
  }

  try {
    const r = await fetch(`${API}/trucks`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });
    const data = await r.json();
    if (data.success) {
      toast('Truck added: ' + num);
      closeModal('truckModal');
      await loadTrucks();
      render();
    } else {
      toast(data.error || 'Error adding truck', true);
    }
  } catch(e) { toast('Error saving truck', true); console.error(e); }
}

// â”€â”€â”€ DELIVERY DETAIL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showDetail(deliveryId) {
  const d = deliveries.find(del => del._id === deliveryId);
  if (!d) return;

  const sourceColor = getSourceColor(d.source);

  document.getElementById('detailBody').innerHTML = `
    <div style="display:flex;align-items:center;gap:8px;margin-bottom:16px;">
      <span class="source-dot" style="background:${sourceColor};width:10px;height:10px;"></span>
      <span style="font-size:13px;color:var(--text-dim)">${d.source}</span>
      <span style="margin-left:auto;font-size:12px;font-weight:600;padding:3px 10px;border-radius:6px;
        background:${d.status==='UNASSIGNED'?'var(--orange-dim)':d.status==='SCHEDULED'?'var(--blue-dim)':d.status==='EN_ROUTE'?'var(--purple-dim)':'var(--green-dim)'};
        color:${d.status==='UNASSIGNED'?'var(--orange)':d.status==='SCHEDULED'?'var(--blue)':d.status==='EN_ROUTE'?'var(--purple)':'var(--green)'};">
        ${d.status}
      </span>
    </div>
    <div style="font-size:18px;font-weight:700;margin-bottom:12px;">${d.customerName || 'Unknown'}</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
      <div><div style="font-size:11px;color:var(--text-muted);text-transform:uppercase;margin-bottom:4px;">Phone</div>${d.customerPhone || 'â€”'}</div>
      <div><div style="font-size:11px;color:var(--text-muted);text-transform:uppercase;margin-bottom:4px;">Email</div>${d.customerEmail || 'â€”'}</div>
      <div><div style="font-size:11px;color:var(--text-muted);text-transform:uppercase;margin-bottom:4px;">Date</div>${d.deliveryDate || 'â€”'}</div>
      <div><div style="font-size:11px;color:var(--text-muted);text-transform:uppercase;margin-bottom:4px;">Material</div>${d.materialName || 'â€”'}</div>
      <div><div style="font-size:11px;color:var(--text-muted);text-transform:uppercase;margin-bottom:4px;">Quantity</div>${fmtTons(d.quantity)} tons</div>
      <div style="grid-column:1/-1;"><div style="font-size:11px;color:var(--text-muted);text-transform:uppercase;margin-bottom:4px;">Address</div>${d.deliveryAddress || ''}${d.deliveryCity ? ', '+d.deliveryCity : ''} ${d.deliveryState || ''} ${d.deliveryZip || ''}</div>
      <div><div style="font-size:11px;color:var(--text-muted);text-transform:uppercase;margin-bottom:4px;">Time Window</div>
        ${d.status === 'UNASSIGNED' || d.status === 'SCHEDULED' 
          ? `<select class="form-select" style="padding:8px 10px;font-size:13px;" onchange="updateTimeWindow('${d._id}',this.value)">
              <option value=""${!d.timeWindow?' selected':''}>Assign later</option>
              <option value="6:00 AM - 8:00 AM"${d.timeWindow==='6:00 AM - 8:00 AM'?' selected':''}>6:00 AM - 8:00 AM</option>
              <option value="8:00 AM - 10:00 AM"${d.timeWindow==='8:00 AM - 10:00 AM'?' selected':''}>8:00 AM - 10:00 AM</option>
              <option value="10:00 AM - 12:00 PM"${d.timeWindow==='10:00 AM - 12:00 PM'?' selected':''}>10:00 AM - 12:00 PM</option>
              <option value="12:00 PM - 2:00 PM"${d.timeWindow==='12:00 PM - 2:00 PM'?' selected':''}>12:00 PM - 2:00 PM</option>
              <option value="2:00 PM - 4:00 PM"${d.timeWindow==='2:00 PM - 4:00 PM'?' selected':''}>2:00 PM - 4:00 PM</option>
            </select>`
          : (d.timeWindow || 'â€”')}
      </div>
      ${d.truckNumber ? `<div><div style="font-size:11px;color:var(--text-muted);text-transform:uppercase;margin-bottom:4px;">Truck</div>${d.truckNumber}</div>` : ''}
      ${d.driverName ? `<div><div style="font-size:11px;color:var(--text-muted);text-transform:uppercase;margin-bottom:4px;">Driver</div>${d.driverName}</div>` : ''}
      ${d.deliveryNotes ? `<div style="grid-column:1/-1;"><div style="font-size:11px;color:var(--text-muted);text-transform:uppercase;margin-bottom:4px;">Notes</div>${d.deliveryNotes}</div>` : ''}
    </div>
    ${d.deliveryPhoto ? `<div style="margin-top:16px;"><div style="font-size:11px;color:var(--text-muted);text-transform:uppercase;margin-bottom:4px;">Delivery Photo</div><img src="${d.deliveryPhoto}" style="width:100%;border-radius:8px;"></div>` : ''}
  `;

  let footerHTML = '';
  if (d.status === 'SCHEDULED') {
    footerHTML += `<button class="btn btn-danger" onclick="cancelDelivery('${d._id}')">Cancel</button>`;
    footerHTML += `<button class="btn" onclick="unassignDelivery('${d._id}')">Unassign</button>`;
  }
  if (d.status === 'UNASSIGNED') {
    footerHTML += `<button class="btn btn-danger" onclick="cancelDelivery('${d._id}')">Cancel</button>`;
  }
  footerHTML += `<button class="btn" onclick="closeModal('detailModal')">Close</button>`;
  document.getElementById('detailFooter').innerHTML = footerHTML;

  openModal('detailModal');
}

async function cancelDelivery(id) {
  if (!confirm('Cancel this delivery?')) return;
  try {
    const r = await fetch(`${API}/dispatch?id=${id}&by=dispatcher`, { method: 'DELETE' });
    const data = await r.json();
    if (data.success) {
      toast('Delivery cancelled');
      closeModal('detailModal');
      await loadDeliveries();
      render();
    }
  } catch(e) { toast('Error cancelling', true); }
}

async function unassignDelivery(id) {
  try {
    const r = await fetch(`${API}/dispatch`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id, truckId: null, truckNumber: null, driverId: null, driverName: null, status: 'UNASSIGNED', updatedBy: 'dispatcher' })
    });
    const data = await r.json();
    if (data.success) {
      toast('Delivery unassigned');
      closeModal('detailModal');
      await loadDeliveries();
      render();
    }
  } catch(e) { toast('Error unassigning', true); }
}

async function updateTimeWindow(deliveryId, timeWindow) {
  try {
    const r = await fetch(`${API}/dispatch`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id: deliveryId, timeWindow: timeWindow || null, updatedBy: 'dispatcher' })
    });
    const data = await r.json();
    if (data.success) {
      toast(timeWindow ? 'Time window set: ' + timeWindow : 'Time window cleared');
      await loadDeliveries();
      render();
    }
  } catch(e) { toast('Error updating time window', true); }
}

// â”€â”€â”€ FINALIZE SCHEDULE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function finalizeSchedule() {
  const dateStr = formatDateISO(currentDate);
  const scheduled = deliveries.filter(d => d.deliveryDate === dateStr && d.status === 'SCHEDULED' && !d.scheduleSmsSent);
  
  if (!scheduled.length) {
    toast('No new deliveries to finalize for this date', true);
    return;
  }

  if (!confirm(`Finalize ${scheduled.length} delivery(s) for ${dateStr}?\nThis will send SMS confirmations to customers.`)) return;

  try {
    // Step 1: Mark as finalized in DB
    const finalRes = await fetch(`${API}/dispatch`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action: 'finalize', date: dateStr, updatedBy: 'dispatcher' })
    });
    const finalData = await finalRes.json();

    // Step 2: Send SMS notifications
    if (finalData.toNotify && finalData.toNotify.length) {
      await fetch(`${API}/notify`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          type: 'schedule_confirmation',
          deliveries: finalData.toNotify
        })
      });
    }

    toast(`Schedule finalized â€” ${finalData.finalized || 0} customer(s) notified`);
    await loadDeliveries();
    render();
  } catch(e) { toast('Error finalizing schedule', true); console.error(e); }
}

// â”€â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toast(msg, error = false) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.className = 'toast show' + (error ? ' error' : '');
  setTimeout(() => el.className = 'toast', 3000);
}
</script>
</body>
</html>
