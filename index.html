<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dispatch Board | RockRunner</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    :root {
      --bg: #0b1426;
      --bg-card: #111d35;
      --bg-hover: #162040;
      --bg-surface: #0f1a30;
      --border: rgba(255,255,255,0.08);
      --text: #e2e8f0;
      --text-muted: #8892a4;
      --blue: #3b82f6;
      --green: #22c55e;
      --yellow: #eab308;
      --red: #ef4444;
      --orange: #f97316;
      --purple: #8b5cf6;
      --cyan: #06b6d4;
      --st-unassigned: #6b7280;
      --st-scheduled: #eab308;
      --st-enroute: #22c55e;
      --st-delivered: #3b82f6;
      --st-cancelled: #ef4444;
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif; background:var(--bg); color:var(--text); min-height:100vh; }

    /* â”€â”€â”€ TOP BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .topbar {
      background: linear-gradient(135deg, #0d1f3c 0%, #132744 100%);
      border-bottom: 1px solid var(--border);
      padding: 12px 20px;
      display: flex;
      align-items: center;
      gap: 16px;
      flex-wrap: wrap;
    }
    .topbar-left { display:flex; align-items:center; gap:12px; }
    .topbar-logo { font-size:20px; }
    .date-nav { display:flex; align-items:center; gap:6px; }
    .date-nav .btn-icon {
      width:32px; height:32px; border:1px solid var(--border); border-radius:6px;
      background:transparent; color:var(--text-muted); cursor:pointer; font-size:14px;
      display:flex; align-items:center; justify-content:center; transition:all 0.15s;
    }
    .date-nav .btn-icon:hover { background:rgba(255,255,255,0.08); color:#fff; }
    .date-label {
      font-size: 16px; font-weight: 600; min-width: 180px; cursor:pointer;
      padding: 4px 12px; border-radius: 6px; transition: background 0.15s;
    }
    .date-label:hover { background: rgba(255,255,255,0.06); }
    .btn-today {
      font-size:12px; padding:4px 12px; border-radius:12px; border:1px solid var(--blue);
      background:rgba(59,130,246,0.15); color:var(--blue); cursor:pointer; font-weight:500;
    }
    .btn-today:hover { background:rgba(59,130,246,0.25); }

    .topbar-stats { display:flex; gap:20px; margin-left:auto; }
    .stat-pill {
      display:flex; align-items:center; gap:6px; font-size:13px; color:var(--text-muted);
    }
    .stat-pill .num { font-size:20px; font-weight:700; }
    .stat-pill.unassigned .num { color:var(--st-unassigned); }
    .stat-pill.assigned .num { color:var(--st-scheduled); }
    .stat-pill.enroute .num { color:var(--st-enroute); }
    .stat-pill.delivered .num { color:var(--st-delivered); }

    .topbar-actions { display:flex; gap:8px; }
    .btn {
      padding:8px 16px; border-radius:8px; font-size:13px; font-weight:500;
      cursor:pointer; border:none; transition:all 0.15s; white-space:nowrap;
    }
    .btn-primary { background:var(--blue); color:#fff; }
    .btn-primary:hover { opacity:0.9; }
    .btn-success { background:var(--green); color:#fff; }
    .btn-success:hover { opacity:0.9; }
    .btn-success:disabled { background:#374151; color:#6b7280; cursor:not-allowed; opacity:0.6; }
    .btn-outline { background:transparent; border:1px solid var(--border); color:var(--text-muted); }
    .btn-outline:hover { background:rgba(255,255,255,0.06); color:#fff; }
    .btn-danger { background:rgba(239,68,68,0.15); color:var(--red); border:1px solid rgba(239,68,68,0.3); }
    .btn-danger:hover { background:rgba(239,68,68,0.25); }
    .btn-sm { padding:5px 10px; font-size:12px; border-radius:6px; }

    /* â”€â”€â”€ MAIN CONTENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .main-wrapper { display:flex; gap:0; height:calc(100vh - 64px); }
    .main-left { flex:0 0 60%; overflow-y:auto; padding:20px; }
    .main-right { flex:0 0 40%; position:relative; }
    #dispatchMap { width:100%; height:100%; }
    .map-toggle-btn {
      display:none; padding:6px 14px; border-radius:8px; border:1px solid var(--border);
      background:rgba(59,130,246,0.15); color:var(--blue); cursor:pointer; font-size:12px;
      font-weight:600;
    }

    .section-header {
      display:flex; align-items:center; justify-content:space-between;
      margin-bottom:12px; padding-bottom:8px; border-bottom:1px solid var(--border);
    }
    .section-title { font-size:15px; font-weight:600; display:flex; align-items:center; gap:8px; }
    .section-title .count {
      background:rgba(255,255,255,0.1); padding:2px 8px; border-radius:10px;
      font-size:12px; font-weight:600; color:var(--text-muted);
    }

    /* â”€â”€â”€ DELIVERY CARDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .card-grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(280px, 1fr)); gap:10px; }

    .delivery-card {
      background:var(--bg-card); border:1px solid var(--border); border-radius:8px;
      padding:12px 14px; cursor:pointer; transition:all 0.15s;
      border-left:4px solid var(--st-unassigned); position:relative;
    }
    .delivery-card:hover { background:var(--bg-hover); transform:translateY(-1px); }
    .delivery-card.scheduled { border-left-color:var(--st-scheduled); }
    .delivery-card.en-route { border-left-color:var(--st-enroute); }
    .delivery-card.delivered { border-left-color:var(--st-delivered); }
    .delivery-card.cancelled { border-left-color:var(--st-cancelled); opacity:0.5; }

    .card-top { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:6px; }
    .card-customer { font-size:14px; font-weight:600; }
    .card-source {
      font-size:10px; font-weight:600; padding:2px 6px; border-radius:4px;
      text-transform:uppercase; letter-spacing:0.5px;
    }
    .card-source.tgr { background:rgba(34,197,94,0.15); color:var(--green); }
    .card-source.ytp { background:rgba(234,179,8,0.15); color:var(--yellow); }
    .card-source.tc { background:rgba(59,130,246,0.15); color:var(--blue); }

    .card-material { font-size:13px; color:var(--text-muted); margin-bottom:4px; }
    .card-material strong { color:var(--text); }
    .card-bottom { display:flex; justify-content:space-between; align-items:center; }
    .card-city { font-size:12px; color:var(--text-muted); }
    .card-time { font-size:11px; color:var(--yellow); font-weight:500; }
    .card-status-badge {
      font-size:10px; font-weight:600; padding:2px 6px; border-radius:4px;
      text-transform:uppercase; letter-spacing:0.3px;
    }
    .badge-scheduled { background:rgba(234,179,8,0.15); color:var(--yellow); }
    .badge-enroute { background:rgba(34,197,94,0.15); color:var(--green); }
    .badge-delivered { background:rgba(59,130,246,0.15); color:var(--blue); }

    .empty-state {
      text-align:center; padding:32px; color:var(--text-muted); font-size:14px;
      background:var(--bg-card); border:1px dashed var(--border); border-radius:8px;
    }

    /* â”€â”€â”€ TRUCK ROUTES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .truck-routes { margin-top:28px; }
    .truck-group { margin-bottom:12px; border:1px solid var(--border); border-radius:10px; overflow:hidden; }
    .truck-header {
      background:#e67e22; padding:14px 16px; cursor:pointer; color:#fff;
      display:flex; align-items:center; gap:12px; transition:background 0.15s;
      user-select:none; border-bottom:1px solid rgba(0,0,0,0.15);
    }
    .truck-header:hover { background:#d35400; }
    .truck-chevron { font-size:12px; color:rgba(255,255,255,0.8); transition:transform 0.2s; width:16px; }
    .truck-group.collapsed .truck-chevron { transform:rotate(-90deg); }
    .truck-group.collapsed .truck-body { display:none; }
    .truck-info { flex:1; }
    .truck-name { font-size:17px; font-weight:700; }
    .truck-name .driver { font-weight:400; color:rgba(255,255,255,0.85); margin-left:6px; }
    .truck-driver-row { display:flex; align-items:center; gap:6px; margin-top:3px; }
    .truck-driver-btn {
      font-size:11px; padding:2px 8px; border-radius:4px; border:1px solid rgba(255,255,255,0.3);
      background:rgba(255,255,255,0.12); color:#fff; cursor:pointer; white-space:nowrap;
    }
    .truck-driver-btn:hover { background:rgba(255,255,255,0.25); }
    .truck-driver-select {
      font-size:12px; padding:3px 6px; border-radius:4px; border:1px solid rgba(255,255,255,0.3);
      background:rgba(0,0,0,0.3); color:#fff; max-width:180px;
    }
    .truck-driver-select option { background:#1a2540; }
    .truck-meta { font-size:12px; color:rgba(255,255,255,0.75); margin-top:2px; }
    .truck-load-bar {
      width:100px; height:6px; background:rgba(255,255,255,0.3); border-radius:3px; overflow:hidden;
    }
    .truck-load-fill { height:100%; border-radius:3px; transition:width 0.3s; }
    .load-ok { background:var(--green); }
    .load-warn { background:var(--yellow); }
    .load-over { background:var(--red); }
    .truck-tons { font-size:12px; font-weight:600; min-width:80px; text-align:right; }

    .truck-body { padding:8px; display:flex; flex-direction:column; gap:6px; background:var(--bg-surface); }
    .truck-body .delivery-card { border-left-width:3px; }
    .truck-body .empty-state { border:none; padding:16px; font-size:13px; }
    .truck-stop-num {
      position:absolute; top:8px; right:10px; font-size:11px; font-weight:700;
      color:var(--text-muted); background:rgba(255,255,255,0.06); width:20px; height:20px;
      border-radius:50%; display:flex; align-items:center; justify-content:center;
    }

    .add-truck-row {
      text-align:center; padding:16px; color:var(--text-muted); font-size:13px;
      cursor:pointer; border:1px dashed var(--border); border-radius:10px;
      transition:all 0.15s;
    }
    .add-truck-row:hover { background:var(--bg-card); color:#fff; }

    /* â”€â”€â”€ MODALS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .modal-overlay {
      display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7);
      backdrop-filter:blur(4px); z-index:1000; align-items:center; justify-content:center; padding:20px;
    }
    .modal-overlay.active { display:flex; }
    .modal {
      background:#1a2540; border:1px solid var(--border); border-radius:14px;
      width:100%; max-height:90vh; overflow-y:auto;
    }
    .modal-sm { max-width:480px; }
    .modal-md { max-width:560px; }
    .modal-lg { max-width:640px; }
    .modal-header {
      padding:16px 20px; border-bottom:1px solid var(--border);
      display:flex; justify-content:space-between; align-items:center;
    }
    .modal-header h3 { font-size:16px; }
    .modal-close {
      background:none; border:none; color:var(--text-muted); font-size:22px;
      cursor:pointer; padding:0; line-height:1;
    }
    .modal-close:hover { color:#fff; }
    .modal-body { padding:20px; }
    .modal-footer {
      padding:12px 20px; border-top:1px solid var(--border);
      display:flex; justify-content:flex-end; gap:8px;
    }

    .form-row { margin-bottom:14px; }
    .form-row label { display:block; font-size:12px; color:var(--text-muted); margin-bottom:4px; font-weight:500; }
    .form-row input, .form-row select {
      width:100%; padding:9px 12px; background:rgba(0,0,0,0.25); border:1px solid var(--border);
      border-radius:7px; color:#fff; font-size:13px;
    }
    .form-row input:focus, .form-row select:focus { outline:none; border-color:var(--blue); }
    .form-row select option { background:#1a2540; }
    .form-grid { display:grid; grid-template-columns:1fr 1fr; gap:10px; }

    /* â”€â”€â”€ ASSIGN MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .assign-delivery-info {
      background:rgba(0,0,0,0.2); border-radius:8px; padding:14px; margin-bottom:16px;
      border-left:4px solid var(--st-unassigned);
    }
    .assign-delivery-info .name { font-size:15px; font-weight:600; margin-bottom:4px; }
    .assign-delivery-info .details { font-size:13px; color:var(--text-muted); line-height:1.5; }

    .assign-time-row { margin-bottom:14px; }
    .assign-time-row label { font-size:12px; color:var(--text-muted); margin-bottom:4px; display:block; }
    .assign-time-row select {
      width:100%; padding:8px 12px; background:rgba(0,0,0,0.25); border:1px solid var(--border);
      border-radius:7px; color:#fff; font-size:13px;
    }

    .truck-pick-list { display:flex; flex-direction:column; gap:6px; }
    .truck-pick {
      display:flex; align-items:center; gap:12px; padding:10px 14px;
      background:var(--bg-card); border:1px solid var(--border); border-radius:8px;
      cursor:pointer; transition:all 0.15s;
    }
    .truck-pick:hover { background:var(--bg-hover); border-color:var(--blue); }
    .truck-pick-info { flex:1; }
    .truck-pick-name { font-size:13px; font-weight:600; }
    .truck-pick-driver { font-size:12px; color:var(--text-muted); }
    .truck-pick-stats { text-align:right; }
    .truck-pick-load { font-size:12px; color:var(--text-muted); }
    .truck-pick-stops { font-size:11px; color:var(--text-muted); }
    .truck-pick-bar { width:60px; height:5px; background:rgba(255,255,255,0.1); border-radius:3px; overflow:hidden; margin-top:3px; }
    .truck-pick-bar-fill { height:100%; border-radius:3px; }

    /* â”€â”€â”€ DETAIL PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .detail-grid { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    .detail-field label { font-size:11px; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.3px; }
    .detail-field .val { font-size:14px; margin-top:2px; }
    .detail-photo { margin-top:12px; }
    .detail-photo img { max-width:100%; border-radius:8px; border:1px solid var(--border); }

    /* â”€â”€â”€ FINALIZE MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .finalize-summary { max-height:220px; overflow-y:auto; margin:12px 0; }
    .finalize-row {
      display:flex; align-items:center; gap:10px; padding:8px 10px;
      background:rgba(0,0,0,0.2); border-radius:6px; margin-bottom:4px; font-size:13px;
    }
    .finalize-row .fr-name { font-weight:600; flex:1; }
    .finalize-row .fr-material { color:var(--text-muted); }
    .finalize-row .fr-truck { color:var(--orange); font-size:12px; font-weight:500; }
    .finalize-unassigned-note { color:var(--yellow); font-size:13px; margin-top:10px; }
    .finalize-spinner { display:inline-block; width:18px; height:18px; border:2px solid #fff; border-top-color:transparent; border-radius:50%; animation:spin 0.8s linear infinite; vertical-align:middle; margin-right:8px; }
    @keyframes spin { to { transform:rotate(360deg); } }
    .finalize-success { text-align:center; padding:20px 0; }
    .finalize-success .check { font-size:40px; margin-bottom:8px; }
    .finalize-success .msg { font-size:16px; font-weight:600; }

    /* â”€â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .toast {
      position:fixed; bottom:20px; right:20px; background:#16a34a; color:#fff;
      padding:10px 20px; border-radius:8px; font-size:13px; font-weight:500;
      opacity:0; transform:translateY(10px); transition:all 0.3s; pointer-events:none; z-index:2000;
    }
    .toast.show { opacity:1; transform:translateY(0); }
    .toast.error { background:var(--red); }

    /* â”€â”€â”€ RESPONSIVE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    @media (max-width:1024px) {
      .main-wrapper { flex-direction:column; height:auto; }
      .main-left { flex:1 1 auto; }
      .main-right { display:none; height:50vh; flex:none; }
      .main-right.map-visible { display:block; }
      .map-toggle-btn { display:inline-flex; align-items:center; gap:4px; }
    }
    @media (max-width:768px) {
      .topbar { flex-direction:column; align-items:flex-start; }
      .topbar-stats { margin-left:0; flex-wrap:wrap; gap:12px; }
      .card-grid { grid-template-columns:1fr; }
      .form-grid { grid-template-columns:1fr; }
      .detail-grid { grid-template-columns:1fr; }
    }
  </style>
</head>
<body>

<!-- â”€â”€â”€ TOP BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="topbar">
  <div class="topbar-left">
    <span class="topbar-logo">ğŸš›</span>
    <div class="date-nav">
      <button class="btn-icon" onclick="changeDate(-1)">â—€</button>
      <span class="date-label" id="dateLabel" onclick="pickDate()">â€”</span>
      <button class="btn-icon" onclick="changeDate(1)">â–¶</button>
      <button class="btn-today" onclick="goToday()">Today</button>
    </div>
  </div>
  <div class="topbar-stats">
    <div class="stat-pill unassigned"><span class="num" id="statUnassigned">0</span> Unassigned</div>
    <div class="stat-pill assigned"><span class="num" id="statScheduled">0</span> Assigned</div>
    <div class="stat-pill enroute"><span class="num" id="statEnRoute">0</span> En Route</div>
    <div class="stat-pill delivered"><span class="num" id="statDelivered">0</span> Delivered</div>
  </div>
  <div class="topbar-actions">
    <button class="map-toggle-btn" onclick="toggleMap()">ğŸ—º Map</button>
    <button class="btn btn-primary" onclick="openAddDelivery()">+ Delivery</button>
    <button class="btn btn-success" id="finalizeBtn" onclick="finalizeSchedule()" disabled>ğŸ“¤ Finalize &amp; Notify</button>
  </div>
</div>

<!-- â”€â”€â”€ MAIN CONTENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="main-wrapper">
  <div class="main-left">
    <!-- Unassigned Deliveries -->
    <div class="section-header">
      <div class="section-title">ğŸ“‹ Unassigned Deliveries <span class="count" id="unassignedCount">0</span></div>
    </div>
    <div class="card-grid" id="unassignedList"></div>

    <!-- Truck Routes -->
    <div class="truck-routes">
      <div class="section-header" style="margin-top:28px;">
        <div class="section-title">ğŸš› Truck Routes <span class="count" id="truckCount">0</span></div>
      </div>
      <div id="truckRoutes"></div>
    </div>
  </div>
  <div class="main-right" id="mapPanel">
    <div id="dispatchMap"></div>
  </div>
</div>

<!-- â”€â”€â”€ ASSIGNMENT MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="modal-overlay" id="assignModal">
  <div class="modal modal-sm">
    <div class="modal-header">
      <h3>Assign to Truck</h3>
      <button class="modal-close" onclick="closeModal('assignModal')">&times;</button>
    </div>
    <div class="modal-body">
      <div class="assign-delivery-info" id="assignDeliveryInfo"></div>
      <div class="form-row">
        <label>Time Window</label>
        <select id="assignTimeWindow">
          <option value="">Assign later</option>
          <option>6:00 AM - 8:00 AM</option>
          <option>8:00 AM - 10:00 AM</option>
          <option>10:00 AM - 12:00 PM</option>
          <option>12:00 PM - 2:00 PM</option>
          <option>2:00 PM - 4:00 PM</option>
        </select>
      </div>
      <div class="form-row">
        <label>Select Truck</label>
        <select id="assignTruckSelect" onchange="onAssignTruckChange(this)">
          <option value="">Choose a truck...</option>
        </select>
      </div>
      <div class="form-row">
        <label>Driver</label>
        <select id="assignDriverSelect">
          <option value="">No driver</option>
        </select>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeModal('assignModal')">Cancel</button>
      <button class="btn btn-primary" id="assignBtn" onclick="confirmAssign()" disabled>Assign</button>
    </div>
  </div>
</div>

<!-- â”€â”€â”€ DETAIL MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="modal-overlay" id="detailModal">
  <div class="modal modal-md">
    <div class="modal-header">
      <h3>Delivery Details</h3>
      <button class="modal-close" onclick="closeModal('detailModal')">&times;</button>
    </div>
    <div class="modal-body" id="detailBody"></div>
    <div class="modal-footer" id="detailFooter"></div>
  </div>
</div>

<!-- â”€â”€â”€ ADD DELIVERY MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="modal-overlay" id="deliveryModal">
  <div class="modal modal-md">
    <div class="modal-header">
      <h3>Add Delivery</h3>
      <button class="modal-close" onclick="closeModal('deliveryModal')">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-row">
          <label>Source</label>
          <select id="delSource">
            <option>Yard Sale</option>
            <option>Texas Got Rocks</option>
            <option>T&amp;C Materials</option>
          </select>
        </div>
        <div class="form-row">
          <label>Customer Name *</label>
          <input type="text" id="delCustomer" placeholder="John Smith">
        </div>
      </div>
      <div class="form-grid">
        <div class="form-row">
          <label>Phone</label>
          <input type="tel" id="delPhone" placeholder="(936) 555-0123">
        </div>
        <div class="form-row">
          <label>Email</label>
          <input type="email" id="delEmail" placeholder="customer@email.com">
        </div>
      </div>
      <div class="form-row">
        <label>Delivery Address *</label>
        <input type="text" id="delAddress" placeholder="123 Main St">
      </div>
      <div class="form-grid">
        <div class="form-row">
          <label>City</label>
          <input type="text" id="delCity" placeholder="Conroe">
        </div>
        <div class="form-row">
          <label>ZIP</label>
          <input type="text" id="delZip" placeholder="77301">
        </div>
      </div>
      <div class="form-grid">
        <div class="form-row">
          <label>Material *</label>
          <select id="delMaterial"><option value="">Select material...</option></select>
        </div>
        <div class="form-row">
          <label>Quantity (tons) *</label>
          <input type="number" id="delQty" step="0.5" min="0.5" placeholder="8">
        </div>
      </div>
      <div class="form-grid">
        <div class="form-row">
          <label>Delivery Date *</label>
          <input type="date" id="delDate">
        </div>
        <div class="form-row">
          <label>Time Window</label>
          <select id="delTime">
            <option value="">Assign later</option>
            <option>6:00 AM - 8:00 AM</option>
            <option>8:00 AM - 10:00 AM</option>
            <option>10:00 AM - 12:00 PM</option>
            <option>12:00 PM - 2:00 PM</option>
            <option>2:00 PM - 4:00 PM</option>
          </select>
        </div>
      </div>
      <div class="form-row">
        <label>Notes</label>
        <input type="text" id="delNotes" placeholder="Gate code, special instructions...">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeModal('deliveryModal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveDelivery()">Add Delivery</button>
    </div>
  </div>
</div>

<!-- â”€â”€â”€ FINALIZE MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="modal-overlay" id="finalizeModal">
  <div class="modal modal-md">
    <div class="modal-header">
      <h3 id="finalizeTitle">ğŸ“£ Finalize &amp; Notify</h3>
      <button class="modal-close" onclick="closeModal('finalizeModal')">&times;</button>
    </div>
    <div class="modal-body" id="finalizeBody"></div>
    <div class="modal-footer" id="finalizeFooter"></div>
  </div>
</div>

<!-- Hidden date picker -->
<input type="date" id="hiddenDatePicker" style="position:absolute;opacity:0;pointer-events:none;">

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GLOBALS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const API = '/.netlify/functions';
let currentDate = new Date();
let trucks = [];
let deliveries = [];
let products = [];
let activeDrivers = [];
let assigningDeliveryId = null; // for assignment modal

// â”€â”€â”€ MAP GLOBALS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let map = null;
let deliveryMarkers = {};  // keyed by delivery _id
let driverMarkers = {};    // keyed by driverId
let driverRefreshTimer = null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getSourceTag(source) {
  const s = (source || '').toLowerCase();
  if (s.includes('texas') || s.includes('texasgotrocks') || s === 'tgr') return { label: 'TGR', cls: 'tgr' };
  if (s.includes('yard') || s.includes('yardtrackpro') || s === 'ytp') return { label: 'YTP', cls: 'ytp' };
  return { label: 'T&C', cls: 'tc' };
}

function fmtTons(val) {
  const n = parseFloat(val);
  return isNaN(n) ? '?' : n.toFixed(1);
}

function formatDateISO(d) {
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, '0');
  const day = String(d.getDate()).padStart(2, '0');
  return `${y}-${m}-${day}`;
}

function renderDateLabel() {
  const days = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
  const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  document.getElementById('dateLabel').textContent =
    `${days[currentDate.getDay()]} - ${months[currentDate.getMonth()]} ${currentDate.getDate()}`;
}

function statusClass(status) {
  const s = (status || '').toUpperCase();
  if (s === 'SCHEDULED') return 'scheduled';
  if (s === 'EN_ROUTE') return 'en-route';
  if (s === 'DELIVERED') return 'delivered';
  if (s === 'CANCELLED') return 'cancelled';
  return '';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATE NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function changeDate(delta) {
  currentDate.setDate(currentDate.getDate() + delta);
  renderDateLabel();
  loadDeliveries().then(render);
}

function goToday() {
  currentDate = new Date();
  renderDateLabel();
  loadDeliveries().then(render);
}

function pickDate() {
  const picker = document.getElementById('hiddenDatePicker');
  picker.value = formatDateISO(currentDate);
  picker.style.pointerEvents = 'auto';
  picker.showPicker ? picker.showPicker() : picker.click();
  picker.onchange = () => {
    if (picker.value) {
      currentDate = new Date(picker.value + 'T12:00:00');
      renderDateLabel();
      loadDeliveries().then(render);
    }
    picker.style.pointerEvents = 'none';
  };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA LOADING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadAll() {
  await Promise.all([loadTrucks(), loadProducts(), loadDrivers()]);
  await loadDeliveries();
  render();
}

async function loadTrucks() {
  try {
    const r = await fetch(`${API}/trucks`);
    const d = await r.json();
    trucks = d.success ? d.trucks : (Array.isArray(d) ? d : []);
  } catch(e) { console.error('loadTrucks:', e); trucks = []; }
}

async function loadDeliveries() {
  try {
    const dateStr = formatDateISO(currentDate);
    const r = await fetch(`${API}/dispatch?date=${dateStr}`);
    const data = await r.json();
    deliveries = data.deliveries || [];
  } catch(e) { console.error('loadDeliveries:', e); deliveries = []; }
}

async function loadProducts() {
  try {
    const r = await fetch(`${API}/products`);
    const d = await r.json();
    products = d.materials || d.products || (Array.isArray(d) ? d : []);
    populateMaterialDropdown();
  } catch(e) { console.error('loadProducts:', e); }
}

async function loadDrivers() {
  try {
    const r = await fetch(`${API}/drivers`);
    const d = await r.json();
    activeDrivers = (d.drivers || []).filter(dr => dr.active !== false);
  } catch(e) { console.error('loadDrivers:', e); activeDrivers = []; }
}

function populateMaterialDropdown() {
  const sel = document.getElementById('delMaterial');
  const current = sel.value;
  sel.innerHTML = '<option value="">Select material...</option>';
  products.filter(p => p.active !== false).forEach(p => {
    const opt = document.createElement('option');
    opt.value = p.id || p._id;
    opt.dataset.name = p.name;
    opt.textContent = p.name;
    sel.appendChild(opt);
  });
  if (current) sel.value = current;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDERING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function render() {
  renderUnassigned();
  renderTruckRoutes();
  renderStats();
  updateMapPins();
}

function renderUnassigned() {
  const list = document.getElementById('unassignedList');
  const dateStr = formatDateISO(currentDate);
  const unassigned = deliveries.filter(d => d.status === 'UNASSIGNED' && d.deliveryDate === dateStr);
  document.getElementById('unassignedCount').textContent = unassigned.length;

  if (!unassigned.length) {
    list.innerHTML = '<div class="empty-state">No unassigned deliveries</div>';
    return;
  }

  list.innerHTML = unassigned.map(d => {
    const src = getSourceTag(d.source);
    return `<div class="delivery-card" onclick="openAssignModal('${d._id}')">
      <div class="card-top">
        <span class="card-customer">${esc(d.customerName || 'Unknown')}</span>
        <span class="card-source ${src.cls}">${src.label}</span>
      </div>
      <div class="card-material"><strong>${esc(d.materialName || '?')}</strong> Â· ${fmtTons(d.quantity)} tons</div>
      <div class="card-bottom">
        <span class="card-city">${esc(d.deliveryCity || d.deliveryAddress || 'â€”')}</span>
        ${d.deliveryDate ? `<span class="card-city">${d.deliveryDate}</span>` : ''}
      </div>
    </div>`;
  }).join('');
}

function renderTruckRoutes() {
  const container = document.getElementById('truckRoutes');
  const dateStr = formatDateISO(currentDate);
  let activeTruckCount = 0;

  const html = trucks.map(truck => {
    const tid = truck._id?.toString() || truck._id;
    const truckDels = deliveries.filter(d =>
      d.truckId === tid && d.deliveryDate === dateStr && d.status !== 'CANCELLED'
    ).sort((a, b) => (a.stopOrder || 99) - (b.stopOrder || 99));

    const totalTons = truckDels.reduce((s, d) => s + (parseFloat(d.quantity) || 0), 0);
    const cap = truck.capacity || 24;
    const pct = Math.min((totalTons / cap) * 100, 100);
    const loadCls = pct >= 100 ? 'load-over' : pct >= 80 ? 'load-warn' : 'load-ok';
    const driverName = truck.defaultDriver?.name || 'No driver';
    if (truckDels.length > 0) activeTruckCount++;

    const cardsHtml = truckDels.length ? truckDels.map((d, i) => {
      const src = getSourceTag(d.source);
      const sc = statusClass(d.status);
      return `<div class="delivery-card ${sc}" onclick="showDetail('${d._id}')">
        <span class="truck-stop-num">${i + 1}</span>
        <div class="card-top">
          <span class="card-customer">${esc(d.customerName || 'Unknown')}</span>
          ${sc ? `<span class="card-status-badge badge-${sc.replace('-','')}">${d.status.replace('_',' ')}</span>` : ''}
        </div>
        <div class="card-material"><strong>${esc(d.materialName || '?')}</strong> Â· ${fmtTons(d.quantity)} tons</div>
        <div class="card-bottom">
          <span class="card-city">${esc(d.deliveryCity || d.deliveryAddress || 'â€”')}</span>
          ${d.timeWindow ? `<span class="card-time">${d.timeWindow}</span>` : ''}
        </div>
      </div>`;
    }).join('') : '<div class="empty-state">No deliveries assigned</div>';

    const driverOpts = activeDrivers.map(d =>
      `<option value="${d.driverId}" data-name="${esc(d.name)}" data-phone="${esc(d.phone || '')}" ${d.driverId === (truck.defaultDriver?.id || '') ? 'selected' : ''}>${esc(d.name)}</option>`
    ).join('');

    return `<div class="truck-group" id="truck-${tid}">
      <div class="truck-header" onclick="toggleTruck('${tid}')">
        <span class="truck-chevron">â–¼</span>
        <div class="truck-info">
          <div class="truck-name">ğŸš› ${esc(truck.truckNumber)}</div>
          <div class="truck-driver-row" onclick="event.stopPropagation()">
            <span style="font-size:12px;color:rgba(255,255,255,0.75);">${esc(driverName)}</span>
            <button class="truck-driver-btn" onclick="showDriverSelect('${tid}', this)">change</button>
            <select class="truck-driver-select" style="display:none" id="driverSel-${tid}" onchange="changeTruckDriver('${tid}', this)">
              <option value="">No driver</option>
              ${driverOpts}
            </select>
          </div>
        </div>
        <div style="display:flex;align-items:center;gap:10px;">
          <div class="truck-load-bar"><div class="truck-load-fill ${loadCls}" style="width:${pct}%"></div></div>
          <span class="truck-tons">${fmtTons(totalTons)} / ${cap}t</span>
        </div>
        <div style="font-size:11px;color:rgba(255,255,255,0.6);">${esc(truck.type || 'Truck')} Â· ${truckDels.length} stop${truckDels.length !== 1 ? 's' : ''}</div>
      </div>
      <div class="truck-body">${cardsHtml}</div>
    </div>`;
  }).join('');

  container.innerHTML = html || '<div class="empty-state">No trucks configured â€” add trucks in Command Center</div>';
  document.getElementById('truckCount').textContent = activeTruckCount;
}

function renderStats() {
  const dateStr = formatDateISO(currentDate);
  const dayDels = deliveries.filter(d => d.deliveryDate === dateStr && d.status !== 'CANCELLED');
  const dayUnassigned = dayDels.filter(d => d.status === 'UNASSIGNED');

  document.getElementById('statUnassigned').textContent = dayUnassigned.length;
  document.getElementById('statScheduled').textContent = dayDels.filter(d => d.status === 'SCHEDULED').length;
  document.getElementById('statEnRoute').textContent = dayDels.filter(d => d.status === 'EN_ROUTE').length;
  document.getElementById('statDelivered').textContent = dayDels.filter(d => d.status === 'DELIVERED').length;

  // Finalize button: enable when there are SCHEDULED deliveries not yet notified
  const toFinalize = dayDels.filter(d => d.status === 'SCHEDULED' && !d.scheduleSmsSent);
  const btn = document.getElementById('finalizeBtn');
  btn.disabled = toFinalize.length === 0;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ASSIGNMENT MODAL (replaces drag-and-drop)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openAssignModal(deliveryId) {
  const d = deliveries.find(del => del._id === deliveryId);
  if (!d) return;
  assigningDeliveryId = deliveryId;

  document.getElementById('assignDeliveryInfo').innerHTML = `
    <div class="name">${esc(d.customerName || 'Unknown')}</div>
    <div class="details">
      <strong>${esc(d.materialName || '?')}</strong> Â· ${fmtTons(d.quantity)} tons<br>
      ${esc([d.deliveryAddress, d.deliveryCity].filter(Boolean).join(', ') || 'No address')}
    </div>`;

  document.getElementById('assignTimeWindow').value = d.timeWindow || '';

  // Populate truck dropdown
  const dateStr = formatDateISO(currentDate);
  const sel = document.getElementById('assignTruckSelect');
  sel.innerHTML = '<option value="">Choose a truck...</option>';
  trucks.forEach(truck => {
    const tid = truck._id?.toString() || truck._id;
    const truckDels = deliveries.filter(del =>
      del.truckId === tid && del.deliveryDate === dateStr && del.status !== 'CANCELLED'
    );
    const totalTons = truckDels.reduce((s, del) => s + (parseFloat(del.quantity) || 0), 0);
    const cap = truck.capacity || 24;
    const opt = document.createElement('option');
    opt.value = tid;
    opt.dataset.truckNumber = truck.truckNumber;
    opt.textContent = `${truck.truckNumber} â€” ${fmtTons(totalTons)}/${cap}T`;
    sel.appendChild(opt);
  });

  // Populate driver dropdown with all active drivers, no selection yet
  const dSel = document.getElementById('assignDriverSelect');
  dSel.innerHTML = '<option value="">No driver</option>';
  activeDrivers.forEach(dr => {
    const opt = document.createElement('option');
    opt.value = dr.driverId;
    opt.dataset.name = dr.name;
    opt.textContent = dr.name;
    dSel.appendChild(opt);
  });

  document.getElementById('assignBtn').disabled = true;
  openModal('assignModal');
  panToDelivery(deliveryId);
}

function onAssignTruckChange(sel) {
  const truckId = sel.value;
  const btn = document.getElementById('assignBtn');
  btn.disabled = !truckId;

  // Default driver dropdown to this truck's assigned driver
  const dSel = document.getElementById('assignDriverSelect');
  if (truckId) {
    const truck = trucks.find(t => (t._id?.toString() || t._id) === truckId);
    dSel.value = truck?.defaultDriver?.id || '';
  } else {
    dSel.value = '';
  }
}

async function confirmAssign() {
  const truckSel = document.getElementById('assignTruckSelect');
  const truckId = truckSel.value;
  if (!truckId || !assigningDeliveryId) return;

  const truckNumber = truckSel.options[truckSel.selectedIndex].dataset.truckNumber;
  const dSel = document.getElementById('assignDriverSelect');
  const driverId = dSel.value || null;
  const driverName = driverId ? dSel.options[dSel.selectedIndex].dataset.name : null;

  const dateStr = formatDateISO(currentDate);
  const existingStops = deliveries.filter(d =>
    d.truckId === truckId && d.deliveryDate === dateStr && d.status !== 'CANCELLED'
  );
  const timeWindow = document.getElementById('assignTimeWindow').value || null;

  const btn = document.getElementById('assignBtn');
  btn.disabled = true;
  btn.textContent = 'Assigning...';

  try {
    const r = await fetch(`${API}/dispatch`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        id: assigningDeliveryId,
        truckId,
        truckNumber,
        driverId,
        driverName,
        deliveryDate: dateStr,
        stopOrder: existingStops.length + 1,
        status: 'SCHEDULED',
        timeWindow,
        updatedBy: 'dispatcher'
      })
    });
    const data = await r.json();
    if (data.success) {
      toast(`Assigned to ${truckNumber}`);
      closeModal('assignModal');
      assigningDeliveryId = null;
      await loadDeliveries();
      render();
    }
  } catch(e) { toast('Error assigning delivery', true); console.error(e); }
  btn.disabled = false;
  btn.textContent = 'Assign';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TRUCK GROUP TOGGLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleTruck(truckId) {
  const el = document.getElementById('truck-' + truckId);
  if (el) el.classList.toggle('collapsed');
}

function showDriverSelect(truckId, btn) {
  const sel = document.getElementById('driverSel-' + truckId);
  if (sel.style.display === 'none') {
    sel.style.display = '';
    btn.textContent = 'cancel';
  } else {
    sel.style.display = 'none';
    btn.textContent = 'change';
  }
}

async function changeTruckDriver(truckId, sel) {
  const driverId = sel.value;
  const opt = sel.options[sel.selectedIndex];
  const driverName = opt.dataset?.name || null;
  const driverPhone = opt.dataset?.phone || null;

  try {
    await fetch(`${API}/trucks`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        id: truckId,
        defaultDriver: driverId ? { id: driverId, name: driverName, phone: driverPhone } : null
      })
    });
    toast(driverName ? `Driver: ${driverName}` : 'Driver removed');
    await loadTrucks();
    render();
  } catch(e) { toast('Error updating driver', true); console.error(e); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DELIVERY DETAIL MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showDetail(deliveryId) {
  const d = deliveries.find(del => del._id === deliveryId);
  if (!d) return;

  const src = getSourceTag(d.source);
  const sc = statusClass(d.status);
  const statusColors = { UNASSIGNED:'#f97316', SCHEDULED:'#eab308', EN_ROUTE:'#22c55e', DELIVERED:'#3b82f6', CANCELLED:'#ef4444' };
  const isEditable = d.status === 'UNASSIGNED' || d.status === 'SCHEDULED';

  const timeOptions = ['','6:00 AM - 8:00 AM','8:00 AM - 10:00 AM','10:00 AM - 12:00 PM','12:00 PM - 2:00 PM','2:00 PM - 4:00 PM'];
  const timeHtml = isEditable
    ? `<select onchange="updateTimeWindow('${d._id}', this.value)" style="background:rgba(0,0,0,0.25);border:1px solid var(--border);border-radius:6px;color:#fff;padding:4px 8px;font-size:13px;">
        ${timeOptions.map(tw => `<option value="${tw}" ${tw === (d.timeWindow||'') ? 'selected' : ''}>${tw || 'Not set'}</option>`).join('')}
       </select>`
    : `<span>${d.timeWindow || 'Not set'}</span>`;

  document.getElementById('detailBody').innerHTML = `
    <div style="display:flex;align-items:center;gap:8px;margin-bottom:16px;">
      <span class="card-source ${src.cls}">${src.label}</span>
      <span style="background:${statusColors[d.status] || '#666'}22;color:${statusColors[d.status] || '#666'};padding:3px 10px;border-radius:4px;font-size:11px;font-weight:600;">${d.status}</span>
    </div>
    <h2 style="font-size:18px;margin-bottom:16px;">${esc(d.customerName || 'Unknown')}</h2>
    <div class="detail-grid">
      <div class="detail-field"><label>Phone</label><div class="val">${d.customerPhone ? `<a href="tel:${d.customerPhone}" style="color:var(--blue);">${esc(d.customerPhone)}</a>` : 'â€”'}</div></div>
      <div class="detail-field"><label>Email</label><div class="val">${esc(d.customerEmail || 'â€”')}</div></div>
      <div class="detail-field"><label>Date</label><div class="val">${d.deliveryDate || 'â€”'}</div></div>
      <div class="detail-field"><label>Time Window</label><div class="val">${timeHtml}</div></div>
      <div class="detail-field"><label>Material</label><div class="val">${esc(d.materialName || 'â€”')}</div></div>
      <div class="detail-field"><label>Quantity</label><div class="val">${fmtTons(d.quantity)} tons</div></div>
      <div class="detail-field" style="grid-column:1/-1;"><label>Address</label><div class="val">${esc([d.deliveryAddress, d.deliveryCity, d.deliveryState, d.deliveryZip].filter(Boolean).join(', ') || 'â€”')}</div></div>
      ${d.truckNumber ? `<div class="detail-field"><label>Truck</label><div class="val">${esc(d.truckNumber)}</div></div>` : ''}
      ${d.driverName ? `<div class="detail-field"><label>Driver</label><div class="val">${esc(d.driverName)}</div></div>` : ''}
      ${d.deliveryNotes ? `<div class="detail-field" style="grid-column:1/-1;"><label>Notes</label><div class="val">${esc(d.deliveryNotes)}</div></div>` : ''}
    </div>
    ${d.deliveryPhoto ? `<div class="detail-photo"><img src="${d.deliveryPhoto}" alt="Delivery photo"></div>` : ''}`;

  let footerHtml = '';
  if (d.status === 'SCHEDULED') {
    footerHtml = `
      <button class="btn btn-danger btn-sm" onclick="cancelDelivery('${d._id}')">Cancel</button>
      <button class="btn btn-outline btn-sm" onclick="unassignDelivery('${d._id}')">Unassign</button>`;
  } else if (d.status === 'UNASSIGNED') {
    footerHtml = `<button class="btn btn-danger btn-sm" onclick="cancelDelivery('${d._id}')">Cancel</button>`;
  }
  footerHtml += `<button class="btn btn-outline btn-sm" onclick="closeModal('detailModal')">Close</button>`;
  document.getElementById('detailFooter').innerHTML = footerHtml;

  openModal('detailModal');
  panToDelivery(deliveryId);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DELIVERY ACTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function cancelDelivery(id) {
  if (!confirm('Cancel this delivery?')) return;
  try {
    await fetch(`${API}/dispatch?id=${id}&by=dispatcher`, { method: 'DELETE' });
    toast('Delivery cancelled');
    closeModal('detailModal');
    await loadDeliveries();
    render();
  } catch(e) { toast('Error cancelling', true); console.error(e); }
}

async function unassignDelivery(id) {
  try {
    await fetch(`${API}/dispatch`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        id,
        truckId: null,
        truckNumber: null,
        driverId: null,
        driverName: null,
        status: 'UNASSIGNED',
        updatedBy: 'dispatcher'
      })
    });
    toast('Delivery unassigned');
    closeModal('detailModal');
    await loadDeliveries();
    render();
  } catch(e) { toast('Error unassigning', true); console.error(e); }
}

async function updateTimeWindow(deliveryId, timeWindow) {
  try {
    await fetch(`${API}/dispatch`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id: deliveryId, timeWindow: timeWindow || null, updatedBy: 'dispatcher' })
    });
    toast('Time window updated');
    await loadDeliveries();
    render();
  } catch(e) { toast('Error updating time', true); console.error(e); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODALS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openModal(id) { document.getElementById(id).classList.add('active'); }
function closeModal(id) { document.getElementById(id).classList.remove('active'); }

function openAddDelivery() {
  document.getElementById('delDate').value = formatDateISO(currentDate);
  openModal('deliveryModal');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SAVE DELIVERY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function saveDelivery() {
  const customer = document.getElementById('delCustomer').value.trim();
  const materialSel = document.getElementById('delMaterial');
  const qty = document.getElementById('delQty').value;
  const date = document.getElementById('delDate').value;

  if (!customer || !materialSel.value || !qty || !date) {
    toast('Please fill required fields', true);
    return;
  }

  const materialName = materialSel.options[materialSel.selectedIndex].dataset.name || materialSel.options[materialSel.selectedIndex].text;

  try {
    const r = await fetch(`${API}/dispatch`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        source: document.getElementById('delSource').value,
        customerName: customer,
        customerPhone: document.getElementById('delPhone').value.trim(),
        customerEmail: document.getElementById('delEmail').value.trim(),
        deliveryAddress: document.getElementById('delAddress').value.trim(),
        deliveryCity: document.getElementById('delCity').value.trim(),
        deliveryZip: document.getElementById('delZip').value.trim(),
        productId: materialSel.value,
        materialName,
        quantity: parseFloat(qty),
        deliveryDate: date,
        timeWindow: document.getElementById('delTime').value || null,
        deliveryNotes: document.getElementById('delNotes').value.trim(),
        createdBy: 'dispatcher'
      })
    });
    const data = await r.json();
    if (data.success) {
      toast('Delivery added');
      closeModal('deliveryModal');
      ['delCustomer','delPhone','delEmail','delAddress','delCity','delZip','delQty','delNotes'].forEach(id => document.getElementById(id).value = '');
      await loadDeliveries();
      render();
    }
  } catch(e) { toast('Error saving delivery', true); console.error(e); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FINALIZE & NOTIFY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function finalizeSchedule() {
  const dateStr = formatDateISO(currentDate);
  const scheduled = deliveries.filter(d => d.deliveryDate === dateStr && d.status === 'SCHEDULED' && !d.scheduleSmsSent);

  if (!scheduled.length) {
    toast('No new deliveries to finalize for this date', true);
    return;
  }

  const withContact = scheduled.filter(d => d.customerPhone || d.customerEmail);
  const unassignedCount = deliveries.filter(d => d.deliveryDate === dateStr && d.status === 'UNASSIGNED').length;

  // Build summary list
  const rows = scheduled.map(d =>
    `<div class="finalize-row"><span class="fr-name">${esc(d.customerName || 'Unknown')}</span><span class="fr-material">${esc(d.materialName || '?')} Â· ${fmtTons(d.quantity)}t</span><span class="fr-truck">${esc(d.truckNumber || 'â€”')}</span></div>`
  ).join('');

  let body = `<p style="color:var(--text-muted);font-size:14px;margin-bottom:12px;">You are about to finalize <strong style="color:#fff;">${scheduled.length}</strong> assigned deliver${scheduled.length === 1 ? 'y' : 'ies'} and notify <strong style="color:#fff;">${withContact.length}</strong> customer${withContact.length === 1 ? '' : 's'} via SMS and email.</p>`;
  body += `<div class="finalize-summary">${rows}</div>`;
  if (unassignedCount > 0) {
    body += `<div class="finalize-unassigned-note">âš  ${unassignedCount} deliver${unassignedCount === 1 ? 'y' : 'ies'} will remain unassigned.</div>`;
  }

  document.getElementById('finalizeBody').innerHTML = body;
  document.getElementById('finalizeFooter').innerHTML = `
    <button class="btn btn-outline" onclick="closeModal('finalizeModal')">Cancel</button>
    <button class="btn btn-success" id="finalizeConfirmBtn" onclick="executeFinalizeAndNotify()">Confirm &amp; Send</button>`;
  openModal('finalizeModal');
}

async function executeFinalizeAndNotify() {
  const dateStr = formatDateISO(currentDate);
  const btn = document.getElementById('finalizeConfirmBtn');
  btn.disabled = true;
  btn.innerHTML = '<span class="finalize-spinner"></span>Sending...';

  try {
    // Step 1: Mark as finalized in DB
    const finalRes = await fetch(`${API}/dispatch`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action: 'finalize', date: dateStr, updatedBy: 'dispatcher' })
    });
    const finalData = await finalRes.json();

    // Step 2: Send notifications
    let notified = 0;
    if (finalData.toNotify && finalData.toNotify.length) {
      const notifyRes = await fetch(`${API}/notify`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          type: 'schedule_confirmation',
          deliveries: finalData.toNotify
        })
      });
      const notifyData = await notifyRes.json();
      notified = (notifyData.smsSent || 0) + (notifyData.emailSent || 0);
    }

    // Step 3: Alert owner (fire-and-forget)
    const truckCount = new Set(finalData.toNotify?.map(d => d.truckNumber || d.truckId).filter(Boolean)).size || 0;
    fetch(`${API}/notify`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        type: 'owner_finalized',
        deliveryCount: finalData.toNotify?.length || finalData.finalized || 0,
        truckCount,
        date: dateStr
      })
    }).catch(err => console.error('Owner alert error:', err));

    // Show success state
    document.getElementById('finalizeBody').innerHTML = `
      <div class="finalize-success">
        <div class="check">âœ…</div>
        <div class="msg">${notified || finalData.finalized || 0} notification${notified === 1 ? '' : 's'} sent successfully</div>
      </div>`;
    document.getElementById('finalizeFooter').innerHTML = `
      <button class="btn btn-primary" onclick="closeModal('finalizeModal')">Done</button>`;

    await loadDeliveries();
    render();
  } catch(e) {
    toast('Error finalizing schedule', true);
    console.error(e);
    closeModal('finalizeModal');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILITIES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function esc(text) {
  const div = document.createElement('div');
  div.textContent = text || '';
  return div.innerHTML;
}

function toast(msg, error = false) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.className = 'toast show' + (error ? ' error' : '');
  clearTimeout(toast._t);
  toast._t = setTimeout(() => el.className = 'toast', 3000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAP â€” INIT, PINS, DRIVERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const STATUS_COLORS = {
  UNASSIGNED: '#6b7280',
  SCHEDULED:  '#eab308',
  EN_ROUTE:   '#22c55e',
  DELIVERED:  '#3b82f6',
  CANCELLED:  '#ef4444'
};

function initMap() {
  if (map) return;
  map = L.map('dispatchMap').setView([30.31, -95.46], 10);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap',
    maxZoom: 18
  }).addTo(map);
}

function toggleMap() {
  const panel = document.getElementById('mapPanel');
  panel.classList.toggle('map-visible');
  if (panel.classList.contains('map-visible')) {
    setTimeout(() => { if (map) map.invalidateSize(); }, 100);
  }
}

// â”€â”€â”€ Geocode + pin deliveries on map â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let geocodeQueue = [];
let geocodeRunning = false;

async function geocodeAndPin(delivery) {
  const id = delivery._id;
  // Already have coords cached on the delivery
  if (delivery.lat != null && delivery.lng != null) {
    addDeliveryMarker(delivery, delivery.lat, delivery.lng);
    return;
  }
  const addr = [delivery.deliveryAddress, delivery.deliveryCity, delivery.deliveryState || 'TX', delivery.deliveryZip].filter(Boolean).join(', ');
  if (!addr || addr === 'TX') return;
  geocodeQueue.push({ delivery, addr });
  processGeocodeQueue();
}

async function processGeocodeQueue() {
  if (geocodeRunning || !geocodeQueue.length) return;
  geocodeRunning = true;

  while (geocodeQueue.length) {
    const { delivery, addr } = geocodeQueue.shift();
    try {
      const r = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(addr)}&format=json&limit=1`);
      const results = await r.json();
      if (results.length) {
        const lat = parseFloat(results[0].lat);
        const lng = parseFloat(results[0].lon);
        addDeliveryMarker(delivery, lat, lng);
        // Cache coords on delivery doc (fire-and-forget)
        fetch(`${API}/dispatch`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id: delivery._id, lat, lng, updatedBy: 'geocoder' })
        }).catch(() => {});
      }
    } catch(e) { console.error('Geocode error:', e); }
    // Nominatim rate limit: 1 req/sec
    await new Promise(r => setTimeout(r, 1100));
  }
  geocodeRunning = false;
}

function addDeliveryMarker(d, lat, lng) {
  if (!map) return;
  // Remove old marker if exists
  if (deliveryMarkers[d._id]) { map.removeLayer(deliveryMarkers[d._id]); }

  const color = STATUS_COLORS[d.status] || '#6b7280';
  const marker = L.circleMarker([lat, lng], {
    radius: 9,
    fillColor: color,
    color: '#fff',
    weight: 2,
    opacity: 1,
    fillOpacity: 0.85
  }).addTo(map);

  marker.bindPopup(`
    <div style="font-family:sans-serif;min-width:160px;">
      <strong>${esc(d.customerName || 'Unknown')}</strong><br>
      ${esc(d.materialName || '?')} &middot; ${fmtTons(d.quantity)}T<br>
      <span style="color:#666;font-size:12px;">${esc(d.deliveryAddress || '')}</span><br>
      <span style="color:${color};font-weight:600;font-size:12px;">${d.status}</span>
    </div>
  `);

  deliveryMarkers[d._id] = marker;
}

function updateMapPins() {
  if (!map) return;
  // Clear old markers
  Object.values(deliveryMarkers).forEach(m => map.removeLayer(m));
  deliveryMarkers = {};

  const dateStr = formatDateISO(currentDate);
  const dayDels = deliveries.filter(d => d.deliveryDate === dateStr && d.status !== 'CANCELLED');
  dayDels.forEach(d => geocodeAndPin(d));
}

function panToDelivery(deliveryId) {
  const marker = deliveryMarkers[deliveryId];
  if (marker && map) {
    map.setView(marker.getLatLng(), 14);
    marker.openPopup();
    // On mobile, ensure map is visible
    const panel = document.getElementById('mapPanel');
    if (!panel.classList.contains('map-visible') && window.innerWidth <= 1024) {
      panel.classList.add('map-visible');
      setTimeout(() => map.invalidateSize(), 100);
      setTimeout(() => { map.setView(marker.getLatLng(), 14); marker.openPopup(); }, 200);
    }
  }
}

// â”€â”€â”€ Driver markers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function refreshDriverLocations() {
  if (!map) return;
  try {
    const r = await fetch(`${API}/driver-location`);
    const data = await r.json();
    const locations = data.locations || [];

    // Remove stale markers
    const activeIds = new Set(locations.map(l => l.driverId));
    Object.keys(driverMarkers).forEach(id => {
      if (!activeIds.has(id)) {
        map.removeLayer(driverMarkers[id]);
        delete driverMarkers[id];
      }
    });

    locations.forEach(loc => {
      const latlng = [loc.lat, loc.lng];
      const ago = Math.round((Date.now() - new Date(loc.timestamp).getTime()) / 60000);
      const popupHtml = `
        <div style="font-family:sans-serif;">
          <strong>ğŸš› ${esc(loc.driverName || loc.driverId)}</strong><br>
          <span style="color:#666;font-size:12px;">Updated ${ago}m ago</span>
        </div>`;

      if (driverMarkers[loc.driverId]) {
        driverMarkers[loc.driverId].setLatLng(latlng);
        driverMarkers[loc.driverId].setPopupContent(popupHtml);
      } else {
        const icon = L.divIcon({
          className: '',
          html: '<div style="background:#e67e22;color:#fff;width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:14px;border:2px solid #fff;box-shadow:0 1px 4px rgba(0,0,0,0.3);">ğŸš›</div>',
          iconSize: [28, 28],
          iconAnchor: [14, 14]
        });
        const marker = L.marker(latlng, { icon }).addTo(map);
        marker.bindPopup(popupHtml);
        driverMarkers[loc.driverId] = marker;
      }
    });
  } catch(e) { console.error('Driver locations error:', e); }
}

function startDriverRefresh() {
  refreshDriverLocations();
  driverRefreshTimer = setInterval(refreshDriverLocations, 30000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('DOMContentLoaded', () => {
  renderDateLabel();
  initMap();
  loadAll();
  startDriverRefresh();
});
</script>
</body>
</html>
