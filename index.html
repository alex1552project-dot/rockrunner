<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dispatch Board | RockRunner</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    :root {
      --bg: #0b1426;
      --bg-card: #111d35;
      --bg-hover: #162040;
      --bg-surface: #0f1a30;
      --border: rgba(255,255,255,0.08);
      --text: #e2e8f0;
      --text-muted: #8892a4;
      --blue: #3b82f6;
      --green: #22c55e;
      --yellow: #eab308;
      --red: #ef4444;
      --orange: #f97316;
      --purple: #8b5cf6;
      --cyan: #06b6d4;
      --st-unassigned: #6b7280;
      --st-scheduled: #eab308;
      --st-enroute: #22c55e;
      --st-delivered: #3b82f6;
      --st-cancelled: #ef4444;
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif; background:var(--bg); color:var(--text); min-height:100vh; }

    /* â”€â”€â”€ TOP BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .topbar {
      background: linear-gradient(135deg, #0d1f3c 0%, #132744 100%);
      border-bottom: 1px solid var(--border);
      padding: 12px 20px;
      display: flex;
      align-items: center;
      gap: 16px;
      flex-wrap: wrap;
    }
    .topbar-left { display:flex; align-items:center; gap:12px; }
    .topbar-logo { font-size:20px; }
    .date-nav { display:flex; align-items:center; gap:6px; }
    .date-nav .btn-icon {
      width:32px; height:32px; border:1px solid var(--border); border-radius:6px;
      background:transparent; color:var(--text-muted); cursor:pointer; font-size:14px;
      display:flex; align-items:center; justify-content:center; transition:all 0.15s;
    }
    .date-nav .btn-icon:hover { background:rgba(255,255,255,0.08); color:#fff; }
    .date-label {
      font-size: 16px; font-weight: 600; min-width: 180px; cursor:pointer;
      padding: 4px 12px; border-radius: 6px; transition: background 0.15s;
    }
    .date-label:hover { background: rgba(255,255,255,0.06); }
    .btn-today {
      font-size:12px; padding:4px 12px; border-radius:12px; border:1px solid var(--blue);
      background:rgba(59,130,246,0.15); color:var(--blue); cursor:pointer; font-weight:500;
    }
    .btn-today:hover { background:rgba(59,130,246,0.25); }

    .topbar-stats { display:flex; gap:20px; margin-left:auto; }
    .stat-pill {
      display:flex; align-items:center; gap:6px; font-size:13px; color:var(--text-muted);
    }
    .stat-pill .num { font-size:20px; font-weight:700; }
    .stat-pill.unassigned .num { color:var(--st-unassigned); }
    .stat-pill.assigned .num { color:var(--st-scheduled); }
    .stat-pill.enroute .num { color:var(--st-enroute); }
    .stat-pill.delivered .num { color:var(--st-delivered); }

    .topbar-actions { display:flex; gap:8px; }
    .btn {
      padding:8px 16px; border-radius:8px; font-size:13px; font-weight:500;
      cursor:pointer; border:none; transition:all 0.15s; white-space:nowrap;
    }
    .btn-primary { background:var(--blue); color:#fff; }
    .btn-primary:hover { opacity:0.9; }
    .btn-success { background:var(--green); color:#fff; }
    .btn-success:hover { opacity:0.9; }
    .btn-success:disabled { background:#374151; color:#6b7280; cursor:not-allowed; opacity:0.6; }
    .btn-outline { background:transparent; border:1px solid var(--border); color:var(--text-muted); }
    .btn-outline:hover { background:rgba(255,255,255,0.06); color:#fff; }
    .btn-danger { background:rgba(239,68,68,0.15); color:var(--red); border:1px solid rgba(239,68,68,0.3); }
    .btn-danger:hover { background:rgba(239,68,68,0.25); }
    .btn-sm { padding:5px 10px; font-size:12px; border-radius:6px; }

    /* â”€â”€â”€ MAIN CONTENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .main-wrapper { display:flex; gap:0; height:calc(100vh - 64px); }
    .main-left { flex:0 0 60%; overflow-y:auto; padding:20px; }
    .main-right { flex:0 0 40%; position:relative; }
    #dispatchMap { width:100%; height:100%; }
    .map-toggle-btn {
      display:none; padding:6px 14px; border-radius:8px; border:1px solid var(--border);
      background:rgba(59,130,246,0.15); color:var(--blue); cursor:pointer; font-size:12px;
      font-weight:600;
    }

    .section-header {
      display:flex; align-items:center; justify-content:space-between;
      margin-bottom:12px; padding-bottom:8px; border-bottom:1px solid var(--border);
    }
    .section-title { font-size:15px; font-weight:600; display:flex; align-items:center; gap:8px; }
    .section-title .count {
      background:rgba(255,255,255,0.1); padding:2px 8px; border-radius:10px;
      font-size:12px; font-weight:600; color:var(--text-muted);
    }

    /* â”€â”€â”€ DELIVERY CARDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .card-grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(280px, 1fr)); gap:10px; }

    .delivery-card {
      background:var(--bg-card); border:1px solid var(--border); border-radius:8px;
      padding:12px 14px; cursor:pointer; transition:all 0.15s;
      border-left:4px solid var(--st-unassigned); position:relative;
    }
    .delivery-card:hover { background:var(--bg-hover); transform:translateY(-1px); }
    .delivery-card.scheduled { border-left-color:var(--st-scheduled); }
    .delivery-card.en-route { border-left-color:var(--st-enroute); }
    .delivery-card.delivered { border-left-color:var(--st-delivered); }
    .delivery-card.cancelled { border-left-color:var(--st-cancelled); opacity:0.5; }

    .card-top { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:6px; }
    .card-customer { font-size:14px; font-weight:600; }
    .card-source {
      font-size:10px; font-weight:600; padding:2px 6px; border-radius:4px;
      text-transform:uppercase; letter-spacing:0.5px;
    }
    .card-source.tgr { background:rgba(34,197,94,0.15); color:var(--green); }
    .card-source.ytp { background:rgba(234,179,8,0.15); color:var(--yellow); }
    .card-source.tc { background:rgba(59,130,246,0.15); color:var(--blue); }

    .card-material { font-size:13px; color:var(--text-muted); margin-bottom:4px; }
    .card-material strong { color:var(--text); }
    .card-bottom { display:flex; justify-content:space-between; align-items:center; }
    .card-city { font-size:12px; color:var(--text-muted); }
    .card-time { font-size:11px; color:var(--yellow); font-weight:500; }
    .card-status-badge {
      font-size:10px; font-weight:600; padding:2px 6px; border-radius:4px;
      text-transform:uppercase; letter-spacing:0.3px;
    }
    .badge-scheduled { background:rgba(234,179,8,0.15); color:var(--yellow); }
    .badge-enroute { background:rgba(34,197,94,0.15); color:var(--green); }
    .badge-delivered { background:rgba(59,130,246,0.15); color:var(--blue); }

    .empty-state {
      text-align:center; padding:32px; color:var(--text-muted); font-size:14px;
      background:var(--bg-card); border:1px dashed var(--border); border-radius:8px;
    }

    /* â”€â”€â”€ TRUCK ROUTES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .truck-routes { margin-top:28px; }
    .truck-group { margin-bottom:12px; border:1px solid var(--border); border-radius:10px; overflow:hidden; }
    .truck-header {
      background:#e67e22; padding:14px 16px; cursor:pointer; color:#fff;
      display:flex; align-items:center; gap:12px; transition:background 0.15s;
      user-select:none; border-bottom:1px solid rgba(0,0,0,0.15);
    }
    .truck-header:hover { background:#d35400; }
    .truck-chevron { font-size:12px; color:rgba(255,255,255,0.8); transition:transform 0.2s; width:16px; }
    .truck-group.collapsed .truck-chevron { transform:rotate(-90deg); }
    .truck-group.collapsed .truck-body { display:none; }
    .truck-info { flex:1; }
    .truck-name { font-size:17px; font-weight:700; }
    .truck-name .driver { font-weight:400; color:rgba(255,255,255,0.85); margin-left:6px; }
    .truck-driver-row { display:flex; align-items:center; gap:6px; margin-top:3px; }
    .truck-driver-btn {
      font-size:11px; padding:2px 8px; border-radius:4px; border:1px solid rgba(255,255,255,0.3);
      background:rgba(255,255,255,0.12); color:#fff; cursor:pointer; white-space:nowrap;
    }
    .truck-driver-btn:hover { background:rgba(255,255,255,0.25); }
    .truck-driver-select {
      font-size:12px; padding:3px 6px; border-radius:4px; border:1px solid rgba(255,255,255,0.3);
      background:rgba(0,0,0,0.3); color:#fff; max-width:180px;
    }
    .truck-driver-select option { background:#1a2540; }
    .truck-meta { font-size:12px; color:rgba(255,255,255,0.75); margin-top:2px; }
    .truck-load-bar {
      width:100px; height:6px; background:rgba(255,255,255,0.3); border-radius:3px; overflow:hidden;
    }
    .truck-load-fill { height:100%; border-radius:3px; transition:width 0.3s; }
    .load-ok { background:var(--green); }
    .load-warn { background:var(--yellow); }
    .load-over { background:var(--red); }
    .truck-tons { font-size:12px; font-weight:600; min-width:80px; text-align:right; }

    .truck-body { padding:8px; display:flex; flex-direction:column; gap:6px; background:var(--bg-surface); }
    .truck-body .delivery-card { border-left-width:3px; }
    .truck-body .empty-state { border:none; padding:16px; font-size:13px; }
    .truck-stop-num {
      position:absolute; top:8px; right:10px; font-size:11px; font-weight:700;
      color:var(--text-muted); background:rgba(255,255,255,0.06); width:20px; height:20px;
      border-radius:50%; display:flex; align-items:center; justify-content:center;
    }

    .add-truck-row {
      text-align:center; padding:16px; color:var(--text-muted); font-size:13px;
      cursor:pointer; border:1px dashed var(--border); border-radius:10px;
      transition:all 0.15s;
    }
    .add-truck-row:hover { background:var(--bg-card); color:#fff; }

    /* â”€â”€â”€ MODALS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .modal-overlay {
      display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7);
      backdrop-filter:blur(4px); z-index:1000; align-items:center; justify-content:center; padding:20px;
    }
    .modal-overlay.active { display:flex; }
    .modal {
      background:#1a2540; border:1px solid var(--border); border-radius:14px;
      width:100%; max-height:90vh; overflow-y:auto;
    }
    .modal-sm { max-width:480px; }
    .modal-md { max-width:560px; }
    .modal-lg { max-width:640px; }
    .modal-header {
      padding:16px 20px; border-bottom:1px solid var(--border);
      display:flex; justify-content:space-between; align-items:center;
    }
    .modal-header h3 { font-size:16px; }
    .modal-close {
      background:none; border:none; color:var(--text-muted); font-size:22px;
      cursor:pointer; padding:0; line-height:1;
    }
    .modal-close:hover { color:#fff; }
    .modal-body { padding:20px; }
    .modal-footer {
      padding:12px 20px; border-top:1px solid var(--border);
      display:flex; justify-content:flex-end; gap:8px;
    }

    .form-row { margin-bottom:14px; }
    .form-row label { display:block; font-size:12px; color:var(--text-muted); margin-bottom:4px; font-weight:500; }
    .form-row input, .form-row select {
      width:100%; padding:9px 12px; background:rgba(0,0,0,0.25); border:1px solid var(--border);
      border-radius:7px; color:#fff; font-size:13px;
    }
    .form-row input:focus, .form-row select:focus { outline:none; border-color:var(--blue); }
    .form-row input[type="date"]::-webkit-calendar-picker-indicator { filter:invert(1); opacity:0.7; cursor:pointer; }
    .form-row select option { background:#1a2540; }
    .form-grid { display:grid; grid-template-columns:1fr 1fr; gap:10px; }

    /* â”€â”€â”€ ASSIGN MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .assign-delivery-info {
      background:rgba(0,0,0,0.2); border-radius:8px; padding:14px; margin-bottom:16px;
      border-left:4px solid var(--st-unassigned);
    }
    .assign-delivery-info .name { font-size:15px; font-weight:600; margin-bottom:4px; }
    .assign-delivery-info .details { font-size:13px; color:var(--text-muted); line-height:1.5; }

    .assign-time-row { margin-bottom:14px; }
    .assign-time-row label { font-size:12px; color:var(--text-muted); margin-bottom:4px; display:block; }
    .assign-time-row select {
      width:100%; padding:8px 12px; background:rgba(0,0,0,0.25); border:1px solid var(--border);
      border-radius:7px; color:#fff; font-size:13px;
    }

    .truck-pick-list { display:flex; flex-direction:column; gap:6px; }
    .truck-pick {
      display:flex; align-items:center; gap:12px; padding:10px 14px;
      background:var(--bg-card); border:1px solid var(--border); border-radius:8px;
      cursor:pointer; transition:all 0.15s;
    }
    .truck-pick:hover { background:var(--bg-hover); border-color:var(--blue); }
    .truck-pick-info { flex:1; }
    .truck-pick-name { font-size:13px; font-weight:600; }
    .truck-pick-driver { font-size:12px; color:var(--text-muted); }
    .truck-pick-stats { text-align:right; }
    .truck-pick-load { font-size:12px; color:var(--text-muted); }
    .truck-pick-stops { font-size:11px; color:var(--text-muted); }
    .truck-pick-bar { width:60px; height:5px; background:rgba(255,255,255,0.1); border-radius:3px; overflow:hidden; margin-top:3px; }
    .truck-pick-bar-fill { height:100%; border-radius:3px; }

    /* â”€â”€â”€ DETAIL PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .detail-grid { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    .detail-field label { font-size:11px; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.3px; }
    .detail-field .val { font-size:14px; margin-top:2px; }
    .detail-photo { margin-top:12px; }
    .detail-photo img { max-width:100%; border-radius:8px; border:1px solid var(--border); }

    /* â”€â”€â”€ FINALIZE MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .finalize-summary { max-height:220px; overflow-y:auto; margin:12px 0; }
    .finalize-row {
      display:flex; align-items:center; gap:10px; padding:8px 10px;
      background:rgba(0,0,0,0.2); border-radius:6px; margin-bottom:4px; font-size:13px;
    }
    .finalize-row .fr-name { font-weight:600; flex:1; }
    .finalize-row .fr-material { color:var(--text-muted); }
    .finalize-row .fr-truck { color:var(--orange); font-size:12px; font-weight:500; }
    .finalize-unassigned-note { color:var(--yellow); font-size:13px; margin-top:10px; }
    .finalize-spinner { display:inline-block; width:18px; height:18px; border:2px solid #fff; border-top-color:transparent; border-radius:50%; animation:spin 0.8s linear infinite; vertical-align:middle; margin-right:8px; }
    @keyframes spin { to { transform:rotate(360deg); } }
    .finalize-success { text-align:center; padding:20px 0; }
    .finalize-success .check { font-size:40px; margin-bottom:8px; }
    .finalize-success .msg { font-size:16px; font-weight:600; }

    /* â”€â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .toast {
      position:fixed; bottom:20px; right:20px; background:#16a34a; color:#fff;
      padding:10px 20px; border-radius:8px; font-size:13px; font-weight:500;
      opacity:0; transform:translateY(10px); transition:all 0.3s; pointer-events:none; z-index:2000;
    }
    .toast.show { opacity:1; transform:translateY(0); }
    .toast.error { background:var(--red); }

    /* â”€â”€â”€ ROCKY BANNER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #rockyBanner {
      display:none; padding:12px 20px; align-items:center; gap:12px;
      border-bottom:1px solid var(--border); font-size:14px; flex-wrap:wrap;
    }
    #rockyBanner.loading   { display:flex; background:rgba(139,92,246,0.1); color:#a78bfa; }
    #rockyBanner.suggested { display:flex; background:rgba(34,197,94,0.06); border-color:rgba(34,197,94,0.2); }
    #rockyBanner.confirmed { display:flex; background:rgba(59,130,246,0.08); border-color:rgba(59,130,246,0.2); color:var(--blue); }
    .rocky-spinner {
      display:inline-block; width:16px; height:16px; border:2px solid currentColor;
      border-top-color:transparent; border-radius:50%; animation:spin 0.8s linear infinite;
      flex-shrink:0; vertical-align:middle; margin-right:4px;
    }
    .ai-badge {
      font-size:10px; padding:1px 5px; border-radius:3px;
      background:rgba(139,92,246,0.2); color:#a78bfa; border:1px solid rgba(139,92,246,0.3);
    }
    .manual-badge {
      font-size:10px; padding:1px 5px; border-radius:3px;
      background:rgba(249,115,22,0.12); color:var(--orange); border:1px solid rgba(249,115,22,0.3);
    }
    .delivery-card.rocky-suggested { border-left-color:#8b5cf6; }

    /* â”€â”€â”€ RESPONSIVE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    @media (max-width:1024px) {
      .main-wrapper { flex-direction:column; height:auto; }
      .main-left { flex:1 1 auto; }
      .main-right { display:none; height:50vh; flex:none; }
      .main-right.map-visible { display:block; }
      .map-toggle-btn { display:inline-flex; align-items:center; gap:4px; }
    }
    @media (max-width:768px) {
      .topbar { flex-direction:column; align-items:flex-start; }
      .topbar-stats { margin-left:0; flex-wrap:wrap; gap:12px; }
      .card-grid { grid-template-columns:1fr; }
      .form-grid { grid-template-columns:1fr; }
      .detail-grid { grid-template-columns:1fr; }
    }

    /* â”€â”€â”€ LOCATION LINK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .location-link-resolving { color:var(--yellow); }
    .location-link-success { color:var(--green); }
    .location-link-error { color:var(--red); }
    .location-link-coords { font-family:monospace; font-size:11px; color:var(--text-muted); }

    /* â”€â”€â”€ LOCATION PIN TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .loc-tabs {
      display:flex; gap:4px; margin-top:6px;
    }
    .loc-tab {
      flex:1; padding:7px 12px; border:1px solid var(--border); border-radius:6px;
      background:transparent; color:var(--text-muted); cursor:pointer;
      font-size:12px; font-weight:500; transition:all 0.15s; text-align:center;
    }
    .loc-tab:hover { background:rgba(255,255,255,0.06); color:#fff; }
    .loc-tab.active { background:rgba(59,130,246,0.15); color:var(--blue); border-color:var(--blue); }
    #pinDropMap {
      height:280px; border-radius:8px; border:1px solid var(--border);
      background:var(--bg-surface);
    }

    /* â”€â”€â”€ EDIT DELIVERY BTN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .stop-edit-btn {
      display:block; width:100%; margin-top:10px;
      background:rgba(255,255,255,0.06); border:1px solid var(--border);
      border-radius:6px; padding:7px 12px; cursor:pointer;
      color:var(--text-muted); font-size:13px; font-weight:500;
      transition:all 0.15s; text-align:center;
    }
    .stop-edit-btn:hover { background:rgba(59,130,246,0.15); color:var(--blue); border-color:var(--blue); }
    /* â”€â”€â”€ EDIT DELIVERY MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .btn-cancel-delivery {
      background:rgba(239,68,68,0.15); border:1px solid rgba(239,68,68,0.4);
      color:var(--red); padding:8px 16px; border-radius:8px; cursor:pointer;
      font-size:13px; font-weight:600; transition:all 0.15s;
    }
    .btn-cancel-delivery:hover { background:rgba(239,68,68,0.3); }
  </style>
</head>
<body>

<!-- â”€â”€â”€ TOP BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="topbar">
  <div class="topbar-left">
    <span class="topbar-logo">ğŸš›</span>
    <div class="date-nav">
      <button class="btn-icon" onclick="changeDate(-1)">â—€</button>
      <span class="date-label" id="dateLabel" onclick="pickDate()">â€”</span>
      <button class="btn-icon" onclick="changeDate(1)">â–¶</button>
      <button class="btn-today" onclick="goToday()">Today</button>
    </div>
  </div>
  <div class="topbar-stats">
    <div class="stat-pill unassigned"><span class="num" id="statUnassigned">0</span> Unassigned</div>
    <div class="stat-pill assigned"><span class="num" id="statScheduled">0</span> Assigned</div>
    <div class="stat-pill enroute"><span class="num" id="statEnRoute">0</span> En Route</div>
    <div class="stat-pill delivered"><span class="num" id="statDelivered">0</span> Delivered</div>
  </div>
  <div class="topbar-actions">
    <button class="map-toggle-btn" onclick="toggleMap()">ğŸ—º Map</button>
    <button class="btn btn-primary" onclick="openAddDelivery()">+ Delivery</button>
    <button class="btn btn-success" id="finalizeBtn" onclick="finalizeSchedule()" disabled>ğŸ“¤ Finalize &amp; Notify</button>
  </div>
</div>

<!-- â”€â”€â”€ ROCKY BANNER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="rockyBanner">
  <span id="rockyBannerText" style="flex:1;"></span>
  <button class="btn btn-success btn-sm" id="rockyConfirmBtn" style="display:none;padding:7px 18px;font-size:13px;" onclick="confirmRockyAssignments()">âœ… Confirm Assignments</button>
</div>

<!-- â”€â”€â”€ MAIN CONTENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="main-wrapper">
  <div class="main-left">
    <!-- Unassigned Deliveries -->
    <div class="section-header">
      <div class="section-title">ğŸ“‹ Unassigned Deliveries <span class="count" id="unassignedCount">0</span></div>
    </div>
    <div class="card-grid" id="unassignedList"></div>

    <!-- Truck Routes -->
    <div class="truck-routes">
      <div class="section-header" style="margin-top:28px;">
        <div class="section-title">ğŸš› Truck Routes <span class="count" id="truckCount">0</span></div>
      </div>
      <div id="truckRoutes"></div>
    </div>
  </div>
  <div class="main-right" id="mapPanel">
    <div id="dispatchMap"></div>
  </div>
</div>

<!-- â”€â”€â”€ ASSIGNMENT MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="modal-overlay" id="assignModal">
  <div class="modal modal-sm">
    <div class="modal-header">
      <h3>Assign to Truck</h3>
      <button class="modal-close" onclick="closeModal('assignModal')">&times;</button>
    </div>
    <div class="modal-body">
      <div class="assign-delivery-info" id="assignDeliveryInfo"></div>
      <div class="form-row">
        <label>Time Window</label>
        <select id="assignTimeWindow">
          <option value="">Assign later</option>
          <option>6:00 AM - 8:00 AM</option>
          <option>8:00 AM - 10:00 AM</option>
          <option>10:00 AM - 12:00 PM</option>
          <option>12:00 PM - 2:00 PM</option>
          <option>2:00 PM - 4:00 PM</option>
        </select>
      </div>
      <div class="form-row">
        <label>Select Truck</label>
        <select id="assignTruckSelect" onchange="onAssignTruckChange(this)">
          <option value="">Choose a truck...</option>
        </select>
      </div>
      <div class="form-row">
        <label>Driver</label>
        <select id="assignDriverSelect">
          <option value="">No driver</option>
        </select>
      </div>
      <div id="assignMultiLoadPreview" style="display:none;background:rgba(234,179,8,0.08);border:1px solid rgba(234,179,8,0.3);border-radius:8px;padding:12px;margin-top:4px;">
        <div id="assignMultiLoadContent"></div>
        <div style="margin-top:8px;">
          <label style="font-size:12px;font-weight:600;color:var(--text-muted);display:block;margin-bottom:4px;">Start Time</label>
          <input type="time" id="assignStartTime" value="07:00" style="width:100%;padding:9px 12px;background:rgba(0,0,0,0.25);border:1px solid var(--border);border-radius:7px;color:#fff;font-size:13px;">
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeModal('assignModal')">Cancel</button>
      <button class="btn btn-primary" id="assignBtn" onclick="confirmAssign()" disabled>Assign</button>
    </div>
  </div>
</div>

<!-- â”€â”€â”€ DETAIL MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="modal-overlay" id="detailModal">
  <div class="modal modal-md">
    <div class="modal-header">
      <h3>Delivery Details</h3>
      <button class="modal-close" onclick="closeModal('detailModal')">&times;</button>
    </div>
    <div class="modal-body" id="detailBody"></div>
    <div class="modal-footer" id="detailFooter"></div>
  </div>
</div>

<!-- â”€â”€â”€ ADD DELIVERY MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="modal-overlay" id="deliveryModal">
  <div class="modal modal-md">
    <div class="modal-header">
      <h3>Add Delivery</h3>
      <button class="modal-close" onclick="closeModal('deliveryModal')">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-row">
          <label>Source</label>
          <select id="delSource">
            <option>Yard Sale</option>
            <option>Texas Got Rocks</option>
            <option>T&amp;C Materials</option>
          </select>
        </div>
        <div class="form-row">
          <label>Customer Name *</label>
          <input type="text" id="delCustomer" placeholder="John Smith">
        </div>
      </div>
      <div class="form-grid">
        <div class="form-row">
          <label>Phone</label>
          <input type="tel" id="delPhone" placeholder="(936) 555-0123">
        </div>
        <div class="form-row">
          <label>Email</label>
          <input type="email" id="delEmail" placeholder="customer@email.com">
        </div>
      </div>
      <div class="form-row">
        <label>Delivery Address *</label>
        <input type="text" id="delAddress" placeholder="123 Main St">
      </div>
      <div class="form-grid">
        <div class="form-row">
          <label>City</label>
          <input type="text" id="delCity" placeholder="Conroe">
        </div>
        <div class="form-row">
          <label>ZIP</label>
          <input type="text" id="delZip" placeholder="77301">
        </div>
      </div>
      <div class="form-row" id="locationPinSection">
        <label>ğŸ“ Location Pin <span style="font-weight:400;color:var(--text-muted);">(optional â€” for sites with no street address)</span></label>
        <div class="loc-tabs">
          <button type="button" class="loc-tab active" id="locTabLink" onclick="switchLocTab('link')">ğŸ“‹ Paste a Link</button>
          <button type="button" class="loc-tab" id="locTabMap" onclick="switchLocTab('map')">ğŸ—º Drop a Pin</button>
        </div>
        <!-- Tab 1: Paste a Link -->
        <div id="locPanelLink" class="loc-panel">
          <div style="display:flex;gap:6px;align-items:center;margin-top:8px;">
            <input type="text" id="delLocationLink" placeholder="Paste a Google/Apple Maps link or coordinates..." oninput="onLocationLinkInput(this.value)" style="flex:1;">
            <button type="button" id="locationLinkClearBtn" onclick="clearLocationLink()" style="display:none;padding:8px 10px;border:1px solid var(--border);border-radius:6px;background:rgba(239,68,68,0.15);color:var(--red);cursor:pointer;font-size:13px;">âœ•</button>
          </div>
        </div>
        <!-- Tab 2: Drop a Pin -->
        <div id="locPanelMap" class="loc-panel" style="display:none;">
          <div id="pinDropMap" style="margin-top:8px;"></div>
          <div style="margin-top:6px;font-size:11px;color:var(--text-muted);">Click to place pin Â· Drag to adjust</div>
        </div>
        <!-- Shared status display -->
        <div id="locationLinkStatus" style="margin-top:6px;font-size:12px;display:none;"></div>
      </div>
      <div class="form-grid">
        <div class="form-row">
          <label>Material *</label>
          <select id="delMaterial" onchange="onMaterialChange()"><option value="">Select material...</option></select>
        </div>
        <div class="form-row">
          <label id="delQtyLabel">Quantity (tons) *</label>
          <div style="display:flex;gap:6px;align-items:center;">
            <input type="number" id="delQty" step="0.1" min="0.1" placeholder="8" style="flex:1">
            <button type="button" id="delQtyUnitBtn" onclick="toggleQtyUnit()" style="padding:8px 12px;border:1px solid var(--border);border-radius:6px;background:rgba(255,255,255,0.08);color:var(--text);cursor:pointer;font-size:13px;font-weight:600;white-space:nowrap;">tons</button>
          </div>
        </div>
      </div>
      <div class="form-row" id="delMaterialCustomRow" style="display:none;">
        <label>Custom Material Name *</label>
        <input type="text" id="delMaterialCustom" placeholder="Enter material name...">
      </div>
      <div class="form-grid">
        <div class="form-row">
          <label>Delivery Date *</label>
          <input type="date" id="delDate">
        </div>
        <div class="form-row">
          <label>Time Window</label>
          <select id="delTime">
            <option value="">Assign later</option>
            <option>6:00 AM - 8:00 AM</option>
            <option>8:00 AM - 10:00 AM</option>
            <option>10:00 AM - 12:00 PM</option>
            <option>12:00 PM - 2:00 PM</option>
            <option>2:00 PM - 4:00 PM</option>
          </select>
        </div>
      </div>
      <div class="form-grid">
        <div class="form-row">
          <label>Origin / Pickup Location <a href="#" onclick="toggleSourceManager(event)" style="font-size:11px;color:var(--blue);font-weight:400;margin-left:8px;">manage</a></label>
          <input type="text" id="delOrigin" placeholder="Conroe Yard, supplier name..." list="originSuggestions" autocomplete="off" oninput="onOriginInput(this.value)">
          <datalist id="originSuggestions"></datalist>
        </div>
        <div class="form-row">
          <label>PO Number</label>
          <input type="text" id="delPO" placeholder="Optional">
        </div>
      </div>
      <div id="sourceManager" style="display:none;margin:4px 0 8px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:10px;max-height:180px;overflow-y:auto;"></div>
      <div class="form-row" id="delOriginAddrRow" style="display:none;">
        <label>Origin Address</label>
        <input type="text" id="delOriginAddr" placeholder="18565 Main St, Conroe, TX 77385">
      </div>
      <div class="form-row">
        <label>Notes</label>
        <input type="text" id="delNotes" placeholder="Gate code, special instructions...">
      </div>
      <div class="form-row" id="delTruckRow">
        <label>Assign to Truck <span style="font-weight:400;color:var(--text-muted);">(optional â€” required for multi-load)</span></label>
        <select id="delTruck" onchange="onDelTruckChange()">
          <option value="">Unassigned</option>
        </select>
      </div>
      <div id="multiLoadPreview" style="display:none;background:rgba(234,179,8,0.08);border:1px solid rgba(234,179,8,0.3);border-radius:8px;padding:14px;margin-top:2px;">
        <div id="multiLoadContent"></div>
        <div style="margin-top:10px;">
          <label style="font-size:12px;font-weight:600;color:var(--text-muted);display:block;margin-bottom:4px;">Start Time</label>
          <input type="time" id="delStartTime" value="07:00" style="width:100%;padding:9px 12px;background:rgba(0,0,0,0.25);border:1px solid var(--border);border-radius:7px;color:#fff;font-size:13px;">
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeModal('deliveryModal')">Cancel</button>
      <button class="btn btn-primary" id="saveDeliveryBtn" onclick="saveDelivery()">Add Delivery</button>
    </div>
  </div>
</div>

<!-- â”€â”€â”€ RESCHEDULE MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="modal-overlay" id="rescheduleModal">
  <div class="modal modal-sm">
    <div class="modal-header">
      <h3>ğŸ“… Reschedule Delivery</h3>
      <button class="modal-close" onclick="closeModal('rescheduleModal')">âœ•</button>
    </div>
    <div class="modal-body">
      <p id="rescheduleInfo" style="color:var(--text-muted);font-size:13px;margin-bottom:14px;"></p>
      <div class="form-row">
        <label>New Delivery Date</label>
        <input type="date" id="rescheduleDate" style="width:100%;padding:9px 12px;background:rgba(0,0,0,0.25);border:1px solid var(--border);border-radius:7px;color:#fff;font-size:13px;">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-primary" onclick="confirmReschedule()">Move Delivery</button>
      <button class="btn btn-outline" onclick="closeModal('rescheduleModal')">Cancel</button>
    </div>
  </div>
</div>

<!-- â”€â”€â”€ FINALIZE MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="modal-overlay" id="finalizeModal">
  <div class="modal modal-md">
    <div class="modal-header">
      <h3 id="finalizeTitle">ğŸ“£ Finalize &amp; Notify</h3>
      <button class="modal-close" onclick="closeModal('finalizeModal')">&times;</button>
    </div>
    <div class="modal-body" id="finalizeBody"></div>
    <div class="modal-footer" id="finalizeFooter"></div>
  </div>
</div>

<!-- â•â•â• EDIT DELIVERY MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-overlay" id="editDeliveryModal">
  <div class="modal" style="max-width:480px;">
    <div class="modal-header">
      <h3>Edit Delivery</h3>
      <button class="modal-close" onclick="closeEditDelivery()">&times;</button>
    </div>
    <div class="modal-body">
      <div id="editDelSummary" style="background:var(--bg-surface);border:1px solid var(--border);border-radius:8px;padding:14px;margin-bottom:16px;"></div>

      <div class="form-row">
        <label>Delivery Date</label>
        <input type="date" id="editDelDate">
      </div>

      <div class="form-row">
        <label>Time Window</label>
        <select id="editDelTime">
          <option value="">No time window</option>
          <option value="7:00 AM - 9:00 AM">7:00 AM - 9:00 AM</option>
          <option value="9:00 AM - 11:00 AM">9:00 AM - 11:00 AM</option>
          <option value="10:00 AM - 12:00 PM">10:00 AM - 12:00 PM</option>
          <option value="12:00 PM - 2:00 PM">12:00 PM - 2:00 PM</option>
          <option value="1:00 PM - 3:00 PM">1:00 PM - 3:00 PM</option>
          <option value="2:00 PM - 4:00 PM">2:00 PM - 4:00 PM</option>
          <option value="3:00 PM - 5:00 PM">3:00 PM - 5:00 PM</option>
          <option value="5:00 PM - 7:00 PM">5:00 PM - 7:00 PM</option>
        </select>
      </div>

      <div class="form-row">
        <label>Delivery Notes</label>
        <input type="text" id="editDelNotes" placeholder="Add or update notes...">
      </div>
    </div>
    <div class="modal-footer" style="display:flex;gap:8px;justify-content:space-between;">
      <button class="btn-cancel-delivery" id="editDelCancelBtn" onclick="cancelDelivery()">ğŸ—‘ Cancel Delivery</button>
      <div style="display:flex;gap:8px;">
        <button class="btn btn-secondary" onclick="closeEditDelivery()">Close</button>
        <button class="btn btn-primary" onclick="saveEditDelivery()">Save Changes</button>
      </div>
    </div>
  </div>
</div>

<!-- Hidden date picker -->
<input type="date" id="hiddenDatePicker" style="position:absolute;opacity:0;pointer-events:none;">

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GLOBALS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const API = '/.netlify/functions';
let currentDate = new Date();
let trucks = [];
let deliveries = [];
let products = [];
let activeDrivers = [];
let assigningDeliveryId = null; // for assignment modal
let editingDeliveryId = null;   // for edit delivery modal

// Rocky Suggests state
let rockyPlan = null;
let rockyAssignments = {};  // { deliveryId: { truckId, truckNumber, stopOrder, routeSource, reasoning, ... } }
let rockyState = 'idle';    // 'idle' | 'loading' | 'suggested' | 'confirmed'

// â”€â”€â”€ LOCATION LINK GLOBALS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let deliveryPinLat = null;
let deliveryPinLng = null;
let locationLinkDebounce = null;
let pinDropMapInstance = null;
let pinDropMarker = null;
let activeLocTab = 'link';

// â”€â”€â”€ MAP GLOBALS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let map = null;
let deliveryMarkers = {};  // keyed by delivery _id
let driverMarkers = {};    // keyed by driverId
let driverRefreshTimer = null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getSourceTag(source) {
  const s = (source || '').toLowerCase();
  if (s.includes('texas') || s.includes('texasgotrocks') || s === 'tgr') return { label: 'TGR', cls: 'tgr' };
  if (s.includes('yard') || s.includes('yardtrackpro') || s === 'ytp') return { label: 'YTP', cls: 'ytp' };
  return { label: 'T&C', cls: 'tc' };
}

function fmtTons(val) {
  const n = parseFloat(val);
  return isNaN(n) ? '?' : n.toFixed(1);
}

// Returns "X CYD / Y Tons" when material weight is known, else "Y Tons"
function fmtQty(d) {
  const tons = parseFloat(d.quantity);
  if (isNaN(tons)) return '?';
  const product = products.find(p =>
    (p.productId && p.productId === d.productId) ||
    (p.id?.toString() === d.productId) ||
    p.name === d.materialName
  );
  const weight = product?.weight;
  if (!weight) return `${tons.toFixed(1)} tons`;
  const cyd = tons / weight;
  return `${cyd.toFixed(1)} CYD / ${tons.toFixed(1)} tons`;
}

function formatDateISO(d) {
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, '0');
  const day = String(d.getDate()).padStart(2, '0');
  return `${y}-${m}-${day}`;
}

function renderDateLabel() {
  const days = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
  const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  document.getElementById('dateLabel').textContent =
    `${days[currentDate.getDay()]} - ${months[currentDate.getMonth()]} ${currentDate.getDate()}`;
}

function statusClass(status) {
  const s = (status || '').toUpperCase();
  if (s === 'SCHEDULED') return 'scheduled';
  if (s === 'EN_ROUTE') return 'en-route';
  if (s === 'DELIVERED') return 'delivered';
  if (s === 'CANCELLED') return 'cancelled';
  return '';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATE NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function changeDate(delta) {
  currentDate.setDate(currentDate.getDate() + delta);
  clearRockyPlan();
  renderDateLabel();
  loadDeliveries().then(() => { render(); loadRockySuggestions(); });
}

function goToday() {
  currentDate = new Date();
  clearRockyPlan();
  renderDateLabel();
  loadDeliveries().then(() => { render(); loadRockySuggestions(); });
}

function pickDate() {
  const picker = document.getElementById('hiddenDatePicker');
  picker.value = formatDateISO(currentDate);
  picker.style.pointerEvents = 'auto';
  picker.showPicker ? picker.showPicker() : picker.click();
  picker.onchange = () => {
    if (picker.value) {
      currentDate = new Date(picker.value + 'T12:00:00');
      clearRockyPlan();
      renderDateLabel();
      loadDeliveries().then(() => { render(); loadRockySuggestions(); });
    }
    picker.style.pointerEvents = 'none';
  };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA LOADING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadAll() {
  await Promise.all([loadTrucks(), loadProducts(), loadDrivers()]);
  await loadDeliveries();
  render();
  loadRockySuggestions(); // background â€” non-blocking
  loadKnownOrigins();     // background â€” populates origin autocomplete
}

async function loadTrucks() {
  try {
    const r = await fetch(`${API}/trucks`);
    const d = await r.json();
    trucks = d.success ? d.trucks : (Array.isArray(d) ? d : []);
  } catch(e) { console.error('loadTrucks:', e); trucks = []; }
}

async function loadDeliveries() {
  try {
    const dateStr = formatDateISO(currentDate);
    const r = await fetch(`${API}/dispatch?date=${dateStr}`);
    const data = await r.json();
    deliveries = data.deliveries || [];
  } catch(e) { console.error('loadDeliveries:', e); deliveries = []; }
}

async function loadProducts() {
  try {
    const r = await fetch(`${API}/products`);
    const d = await r.json();
    products = d.materials || d.products || (Array.isArray(d) ? d : []);
    populateMaterialDropdown();
  } catch(e) { console.error('loadProducts:', e); }
}

async function loadDrivers() {
  try {
    const r = await fetch(`${API}/drivers`);
    const d = await r.json();
    activeDrivers = (d.drivers || []).filter(dr => dr.active !== false);
  } catch(e) { console.error('loadDrivers:', e); activeDrivers = []; }
}

// â”€â”€â”€ CUSTOM MATERIAL + CYD TOGGLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let delQtyUnit = 'tons'; // 'tons' or 'cyd'

function onMaterialChange() {
  const sel = document.getElementById('delMaterial');
  const customRow = document.getElementById('delMaterialCustomRow');
  const isCustom = sel.value === '__custom__';
  customRow.style.display = isCustom ? 'block' : 'none';
  if (!isCustom) document.getElementById('delMaterialCustom').value = '';
}

function toggleQtyUnit() {
  const btn = document.getElementById('delQtyUnitBtn');
  const label = document.getElementById('delQtyLabel');
  const sel = document.getElementById('delMaterial');
  const qtyInput = document.getElementById('delQty');
  let weight = 1.4;
  if (sel.value && sel.value !== '__custom__') {
    weight = parseFloat(sel.options[sel.selectedIndex].dataset.weight) || 1.4;
  }
  const val = parseFloat(qtyInput.value);
  if (delQtyUnit === 'tons') {
    if (!isNaN(val) && val > 0) qtyInput.value = (val / weight).toFixed(1);
    qtyInput.placeholder = '4';
    btn.textContent = 'CYD';
    btn.style.background = 'var(--blue)';
    btn.style.color = '#fff';
    btn.style.borderColor = 'var(--blue)';
    label.textContent = 'Quantity (CYD) *';
    delQtyUnit = 'cyd';
  } else {
    if (!isNaN(val) && val > 0) qtyInput.value = (val * weight).toFixed(1);
    qtyInput.placeholder = '8';
    btn.textContent = 'tons';
    btn.style.background = 'rgba(255,255,255,0.08)';
    btn.style.color = 'var(--text)';
    btn.style.borderColor = 'var(--border)';
    label.textContent = 'Quantity (tons) *';
    delQtyUnit = 'tons';
  }
}

function populateMaterialDropdown() {
  const sel = document.getElementById('delMaterial');
  const current = sel.value;
  sel.innerHTML = '<option value="">Select material...</option>';
  products.filter(p => p.active !== false).forEach(p => {
    const opt = document.createElement('option');
    opt.value = p.id || p._id;
    opt.dataset.name = p.name;
    opt.dataset.weight = p.weight || '1.4';
    opt.textContent = p.name;
    sel.appendChild(opt);
  });
  // Custom entry option
  const customOpt = document.createElement('option');
  customOpt.value = '__custom__';
  customOpt.textContent = 'â”€â”€ Not listed? Type manually â”€â”€';
  sel.appendChild(customOpt);
  if (current) sel.value = current;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDERING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function render() {
  renderUnassigned();
  renderTruckRoutes();
  renderStats();
  updateMapPins();
}

function renderUnassigned() {
  const list = document.getElementById('unassignedList');
  const dateStr = formatDateISO(currentDate);
  const unassigned = deliveries.filter(d => d.status === 'UNASSIGNED' && d.deliveryDate === dateStr && !rockyAssignments[d._id]);
  document.getElementById('unassignedCount').textContent = unassigned.length;

  if (!unassigned.length) {
    list.innerHTML = '<div class="empty-state">No unassigned deliveries</div>';
    return;
  }

  list.innerHTML = unassigned.map(d => {
    const src = getSourceTag(d.source);
    return `<div class="delivery-card" onclick="openAssignModal('${d._id}')">
      <div class="card-top">
        <span class="card-customer">${esc(d.customerName || 'Unknown')}</span>
        <span class="card-source ${src.cls}">${src.label}</span>
      </div>
      <div class="card-material"><strong>${esc(d.materialName || '?')}</strong> Â· ${fmtQty(d)}</div>
      <div class="card-bottom">
        <span class="card-city">${esc(d.deliveryCity || d.deliveryAddress || 'â€”')}</span>
        ${d.deliveryDate ? `<span class="card-city">${d.deliveryDate}</span>` : ''}
      </div>
      <button class="stop-edit-btn" onclick="event.stopPropagation();openEditDelivery('${d._id}')">âœï¸ Edit Delivery</button>
    </div>`;
  }).join('');
}

function renderTruckRoutes() {
  const container = document.getElementById('truckRoutes');
  const dateStr = formatDateISO(currentDate);
  let activeTruckCount = 0;

  const html = trucks.map(truck => {
    const tid = truck._id?.toString() || truck._id;

    // DB-assigned deliveries for this truck
    const dbDels = deliveries.filter(d =>
      d.truckId === tid && d.deliveryDate === dateStr && d.status !== 'CANCELLED'
    ).sort((a, b) => (a.stopOrder || 99) - (b.stopOrder || 99));

    // Rocky-tentative deliveries for this truck (not yet saved to DB)
    const rockyDelsForTruck = rockyState === 'suggested'
      ? Object.entries(rockyAssignments)
          .filter(([, a]) => a.truckId === tid)
          .map(([deliveryId, assignment]) => {
            const d = deliveries.find(del => del._id === deliveryId);
            return d ? { ...d, _rocky: assignment } : null;
          })
          .filter(Boolean)
          .sort((a, b) => (a._rocky.stopOrder || 99) - (b._rocky.stopOrder || 99))
      : [];

    const totalTons = [...dbDels, ...rockyDelsForTruck].reduce((s, d) => s + (parseFloat(d.quantity) || 0), 0);
    const cap = truck.capacity || 24;
    const pct = Math.min((totalTons / cap) * 100, 100);
    const loadCls = pct >= 100 ? 'load-over' : pct >= 80 ? 'load-warn' : 'load-ok';
    const driverName = truck.defaultDriver?.name || 'No driver';
    const totalStops = dbDels.length + rockyDelsForTruck.length;
    if (totalStops > 0) activeTruckCount++;

    // DB stop cards â€” group multi-load orders by fulfillmentGroupId (3F)
    const seenGroups = new Set();
    const dbCards = dbDels.map((d, i) => {
      // Multi-load grouped card
      if (d.fulfillmentGroupId && d.totalLoads > 1) {
        if (seenGroups.has(d.fulfillmentGroupId)) return ''; // already rendered
        seenGroups.add(d.fulfillmentGroupId);
        const groupLoads = dbDels.filter(del => del.fulfillmentGroupId === d.fulfillmentGroupId)
          .sort((a, b) => a.loadNumber - b.loadNumber);
        const deliveredTons = groupLoads.filter(l => l.status === 'DELIVERED').reduce((s, l) => s + (parseFloat(l.quantity) || 0), 0);
        const totalTons = d.totalTons || groupLoads.reduce((s, l) => s + (parseFloat(l.quantity) || 0), 0);
        const pctDone = totalTons ? Math.round((deliveredTons / totalTons) * 100) : 0;
        const statusIcon = s => s === 'DELIVERED' ? 'âœ…' : s === 'EN_ROUTE' ? 'ğŸš›' : 'â³';
        const loadsHtml = groupLoads.map(l =>
          `<div style="font-size:12px;margin-top:3px;">
            ${statusIcon(l.status)} Load ${l.loadNumber}: ${l.quantity}t
            <span style="color:var(--text-muted);"> â€” ${l.status.replace('_',' ')}</span>
          </div>`
        ).join('');
        const progressBar = `<div style="background:rgba(255,255,255,0.1);border-radius:4px;height:6px;margin-top:8px;">
          <div style="background:var(--green);width:${pctDone}%;height:100%;border-radius:4px;"></div>
        </div>
        <div style="font-size:11px;color:var(--text-muted);margin-top:3px;">${deliveredTons.toFixed(1)} / ${totalTons.toFixed(1)} tons delivered</div>`;
        return `<div class="delivery-card" onclick="showDetail('${d._id}')">
          <span class="truck-stop-num">${i + 1}</span>
          <div class="card-top">
            <span class="card-customer">${esc(d.customerName || 'Unknown')}</span>
            <span class="card-status-badge" style="background:rgba(234,179,8,0.2);color:#eab308;">${d.totalLoads} loads</span>
          </div>
          <div class="card-material"><strong>${esc(d.materialName || '?')}</strong> Â· ${totalTons.toFixed(1)}T total</div>
          ${loadsHtml}
          ${progressBar}
          <button class="stop-edit-btn" onclick="event.stopPropagation();showDetail('${d._id}')">ğŸ“‹ Order Detail</button>
        </div>`;
      }
      // Single-load card (existing behavior)
      const sc = statusClass(d.status);
      const clickFn = (d.status === 'SCHEDULED' || d.status === 'UNASSIGNED') ? `openAssignModal('${d._id}')` : `showDetail('${d._id}')`;
      return `<div class="delivery-card ${sc}" onclick="${clickFn}">
        <span class="truck-stop-num">${i + 1}</span>
        <div class="card-top">
          <span class="card-customer">${esc(d.customerName || 'Unknown')}</span>
          ${sc ? `<span class="card-status-badge badge-${sc.replace('-','')}">${d.status.replace('_',' ')}</span>` : ''}
        </div>
        <div class="card-material"><strong>${esc(d.materialName || '?')}</strong> Â· ${fmtQty(d)}</div>
        <div class="card-bottom">
          <span class="card-city">${esc(d.deliveryCity || d.deliveryAddress || 'â€”')}</span>
          ${d.timeWindow ? (d.timeWindow === 'Morning' || d.timeWindow === 'Afternoon'
            ? `<span style="display:inline-block;padding:2px 8px;border-radius:12px;font-size:11px;font-weight:600;${d.timeWindow === 'Morning' ? 'background:#dbeafe;color:#1d4ed8' : 'background:#fef9c3;color:#854d0e'};">${d.timeWindow === 'Morning' ? 'ğŸŒ… Morning' : 'â˜€ï¸ Afternoon'}</span>`
            : `<span class="card-time">${d.timeWindow}</span>`) : ''}
        </div>
        <button class="stop-edit-btn" onclick="event.stopPropagation();openEditDelivery('${d._id}')">âœï¸ Edit Delivery</button>
      </div>`;
    }).join('');

    // Rocky-suggested stop cards (with ğŸ¤– or âœï¸ badge)
    const rockyCards = rockyDelsForTruck.map((d, i) => {
      const isManual = d._rocky.routeSource === 'manual';
      const badge = isManual
        ? '<span class="manual-badge">âœï¸ manual</span>'
        : '<span class="ai-badge">ğŸ¤– AI</span>';
      const tw = d._rocky.timeWindow || d.timeWindow;
      return `<div class="delivery-card rocky-suggested" onclick="openAssignModal('${d._id}')" title="Click to reassign">
        <span class="truck-stop-num">${dbDels.length + i + 1}</span>
        <div class="card-top">
          <span class="card-customer">${esc(d.customerName || 'Unknown')}</span>
          ${badge}
        </div>
        <div class="card-material"><strong>${esc(d.materialName || '?')}</strong> Â· ${fmtQty(d)}</div>
        <div class="card-bottom">
          <span class="card-city">${esc(d.deliveryCity || d.deliveryAddress || 'â€”')}</span>
          <span style="display:flex;align-items:center;gap:6px;">
            ${tw ? `<span class="card-time">${tw}</span>` : ''}
            ${!isManual ? '<span style="font-size:10px;color:#a78bfa;opacity:0.85;">â†• reassign</span>' : ''}
          </span>
        </div>
        <button class="stop-edit-btn" onclick="event.stopPropagation();openEditDelivery('${d._id}')">âœï¸ Edit Delivery</button>
      </div>`;
    }).join('');

    const cardsHtml = (dbCards + rockyCards) || '<div class="empty-state">No deliveries assigned</div>';

    const driverOpts = activeDrivers.map(d =>
      `<option value="${d.driverId}" data-name="${esc(d.name)}" data-phone="${esc(d.phone || '')}" ${d.driverId === (truck.defaultDriver?.id || '') ? 'selected' : ''}>${esc(d.name)}</option>`
    ).join('');

    return `<div class="truck-group" id="truck-${tid}">
      <div class="truck-header" onclick="toggleTruck('${tid}')">
        <span class="truck-chevron">â–¼</span>
        <div class="truck-info">
          <div class="truck-name">ğŸš› ${esc(truck.truckNumber)}</div>
          <div class="truck-driver-row" onclick="event.stopPropagation()">
            <span style="font-size:12px;color:rgba(255,255,255,0.75);">${esc(driverName)}</span>
            <button class="truck-driver-btn" onclick="showDriverSelect('${tid}', this)">change</button>
            <select class="truck-driver-select" style="display:none" id="driverSel-${tid}" onchange="changeTruckDriver('${tid}', this)">
              <option value="">No driver</option>
              ${driverOpts}
            </select>
          </div>
        </div>
        <div style="display:flex;align-items:center;gap:10px;">
          <div class="truck-load-bar"><div class="truck-load-fill ${loadCls}" style="width:${pct}%"></div></div>
          <span class="truck-tons">${fmtTons(totalTons)} / ${cap}t</span>
        </div>
        <div style="font-size:11px;color:rgba(255,255,255,0.6);">${esc(truck.type || 'Truck')} Â· ${totalStops} stop${totalStops !== 1 ? 's' : ''}</div>
      </div>
      <div class="truck-body">${cardsHtml}</div>
    </div>`;
  }).join('');

  container.innerHTML = html || '<div class="empty-state">No trucks configured â€” add trucks in Command Center</div>';
  document.getElementById('truckCount').textContent = activeTruckCount;
}

function renderStats() {
  const dateStr = formatDateISO(currentDate);
  const dayDels = deliveries.filter(d => d.deliveryDate === dateStr && d.status !== 'CANCELLED');
  const dayUnassigned = dayDels.filter(d => d.status === 'UNASSIGNED' && !rockyAssignments[d._id]);

  document.getElementById('statUnassigned').textContent = dayUnassigned.length;
  document.getElementById('statScheduled').textContent = dayDels.filter(d => d.status === 'SCHEDULED').length;
  document.getElementById('statEnRoute').textContent = dayDels.filter(d => d.status === 'EN_ROUTE').length;
  document.getElementById('statDelivered').textContent = dayDels.filter(d => d.status === 'DELIVERED').length;

  // Finalize button: enable when there are SCHEDULED deliveries not yet notified
  const toFinalize = dayDels.filter(d => d.status === 'SCHEDULED' && !d.scheduleSmsSent);
  const btn = document.getElementById('finalizeBtn');
  btn.disabled = toFinalize.length === 0;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ASSIGNMENT MODAL (replaces drag-and-drop)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openAssignModal(deliveryId) {
  const d = deliveries.find(del => del._id === deliveryId);
  if (!d) return;
  assigningDeliveryId = deliveryId;

  document.getElementById('assignDeliveryInfo').innerHTML = `
    <div class="name">${esc(d.customerName || 'Unknown')}</div>
    <div class="details">
      <strong>${esc(d.materialName || '?')}</strong> Â· ${fmtQty(d)}<br>
      ${esc([d.deliveryAddress, d.deliveryCity].filter(Boolean).join(', ') || 'No address')}
    </div>`;

  document.getElementById('assignTimeWindow').value = d.timeWindow || '';

  // Populate truck dropdown
  const dateStr = formatDateISO(currentDate);
  const sel = document.getElementById('assignTruckSelect');
  sel.innerHTML = '<option value="">Choose a truck...</option>';
  trucks.forEach(truck => {
    const tid = truck._id?.toString() || truck._id;
    const truckDels = deliveries.filter(del =>
      del.truckId === tid && del.deliveryDate === dateStr && del.status !== 'CANCELLED'
    );
    const totalTons = truckDels.reduce((s, del) => s + (parseFloat(del.quantity) || 0), 0);
    const cap = truck.capacity || 24;
    const opt = document.createElement('option');
    opt.value = tid;
    opt.dataset.truckNumber = truck.truckNumber;
    opt.textContent = `${truck.truckNumber} â€” ${fmtTons(totalTons)}/${cap}T`;
    sel.appendChild(opt);
  });

  // Populate driver dropdown with all active drivers, no selection yet
  const dSel = document.getElementById('assignDriverSelect');
  dSel.innerHTML = '<option value="">No driver</option>';
  activeDrivers.forEach(dr => {
    const opt = document.createElement('option');
    opt.value = dr.driverId;
    opt.dataset.name = dr.name;
    opt.textContent = dr.name;
    dSel.appendChild(opt);
  });

  document.getElementById('assignBtn').disabled = true;

  // Pre-select assignment: Rocky suggestion takes priority, then existing assignment
  const ra = rockyAssignments[deliveryId];
  if (ra) {
    const truckSel = document.getElementById('assignTruckSelect');
    truckSel.value = ra.truckId;
    onAssignTruckChange(truckSel);
  } else if (d.truckId) {
    sel.value = d.truckId;
    onAssignTruckChange(sel);
    if (d.driverId) {
      document.getElementById('assignDriverSelect').value = d.driverId;
    }
  }

  openModal('assignModal');
  // Skip map pan for Rocky-suggested cards â€” panToDelivery opens a Leaflet
  // popup which conflicts with the assignment modal.
  if (!rockyAssignments[deliveryId]) {
    panToDelivery(deliveryId);
  }
}

function onAssignTruckChange(sel) {
  const truckId = sel.value;
  const btn = document.getElementById('assignBtn');
  btn.disabled = !truckId;

  // Default driver dropdown to this truck's assigned driver
  const dSel = document.getElementById('assignDriverSelect');
  if (truckId) {
    const truck = trucks.find(t => (t._id?.toString() || t._id) === truckId);
    dSel.value = truck?.defaultDriver?.id || '';

    // Multi-load preview for assign modal (3D)
    const d = deliveries.find(del => del._id === assigningDeliveryId);
    const preview = document.getElementById('assignMultiLoadPreview');
    if (d && truck) {
      const cap = truck.capacity || 24;
      const { totalLoads, loads } = calcLoads(parseFloat(d.quantity) || 0, cap);
      if (totalLoads > 1) {
        document.getElementById('assignMultiLoadContent').innerHTML = `
          <div style="font-size:13px;font-weight:700;color:#eab308;margin-bottom:6px;">âš  ${totalLoads} loads required for this truck:</div>
          ${loads.map(l => `<div style="font-size:12px;color:rgba(255,255,255,0.85);">Load ${l.loadNumber}: ${l.quantity}t</div>`).join('')}
        `;
        preview.style.display = 'block';
      } else {
        preview.style.display = 'none';
      }
    } else {
      if (preview) preview.style.display = 'none';
    }
  } else {
    dSel.value = '';
    const preview = document.getElementById('assignMultiLoadPreview');
    if (preview) preview.style.display = 'none';
  }
}

async function confirmAssign() {
  const truckSel = document.getElementById('assignTruckSelect');
  const truckId = truckSel.value;
  if (!truckId || !assigningDeliveryId) return;

  const truckNumber = truckSel.options[truckSel.selectedIndex].dataset.truckNumber;
  const dSel = document.getElementById('assignDriverSelect');
  const driverId = dSel.value || null;
  const driverName = driverId ? dSel.options[dSel.selectedIndex].dataset.name : null;

  const dateStr = formatDateISO(currentDate);
  const existingStops = deliveries.filter(d =>
    d.truckId === truckId && d.deliveryDate === dateStr && d.status !== 'CANCELLED'
  );
  const timeWindow = document.getElementById('assignTimeWindow').value || null;

  // Rocky intercept: if this delivery is in the tentative Rocky plan,
  // update in-memory assignment instead of writing to DB
  if (rockyAssignments[assigningDeliveryId]) {
    const otherRockyForTruck = Object.entries(rockyAssignments)
      .filter(([id, a]) => a.truckId === truckId && id !== assigningDeliveryId).length;
    const newStop = existingStops.length + otherRockyForTruck + 1;
    rockyAssignments[assigningDeliveryId] = {
      ...rockyAssignments[assigningDeliveryId],
      truckId, truckNumber, stopOrder: newStop,
      routeSource: 'manual', driverId, driverName, timeWindow
    };
    toast(`Reassigned to ${truckNumber} âœï¸`);
    closeModal('assignModal');
    assigningDeliveryId = null;
    render();
    return;
  }

  const btn = document.getElementById('assignBtn');
  btn.disabled = true;
  btn.textContent = 'Assigning...';

  try {
    const r = await fetch(`${API}/dispatch`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        id: assigningDeliveryId,
        truckId,
        truckNumber,
        driverId,
        driverName,
        deliveryDate: dateStr,
        stopOrder: existingStops.length + 1,
        status: 'SCHEDULED',
        timeWindow,
        updatedBy: 'dispatcher'
      })
    });
    const data = await r.json();
    if (data.success) {
      // Check if this needs multi-load expansion (3D)
      const d = deliveries.find(del => del._id === assigningDeliveryId);
      const truck = trucks.find(t => (t._id?.toString() || t._id) === truckId);
      if (d && truck) {
        const cap = truck.capacity || 24;
        const { totalLoads, loads } = calcLoads(parseFloat(d.quantity) || 0, cap);
        if (totalLoads > 1) {
          const { randomUUID } = { randomUUID: () => `${Date.now()}-${Math.random().toString(36).slice(2)}` };
          const fulfillmentGroupId = randomUUID();
          const startVal = document.getElementById('assignStartTime').value || '07:00';
          const dateStr2 = formatDateISO(currentDate);
          // Update Load 1 (original doc) with multi-load fields
          await fetch(`${API}/dispatch`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              id: assigningDeliveryId,
              fulfillmentGroupId,
              loadNumber: 1,
              totalLoads,
              totalTons: parseFloat(d.quantity) || 0,
              scheduledStartTime: new Date(`${dateStr2}T${startVal}:00`).toISOString(),
              estimatedRoundTripMin: 60,
              updatedBy: 'dispatcher'
            })
          });
          // Create loads 2..N
          const remainingLoads = loads.slice(1).map((l, idx) => {
            const base = new Date(`${dateStr2}T${startVal}:00`);
            base.setMinutes(base.getMinutes() + (idx + 1) * 60);
            return { ...l, scheduledStartTime: base.toISOString() };
          });
          await fetch(`${API}/dispatch`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              action: 'multi_load',
              source: d.source,
              customerName: d.customerName,
              customerPhone: d.customerPhone || '',
              customerEmail: d.customerEmail || '',
              deliveryAddress: d.deliveryAddress || '',
              deliveryCity: d.deliveryCity || '',
              deliveryZip: d.deliveryZip || '',
              deliveryLat: d.deliveryLat || null,
              deliveryLng: d.deliveryLng || null,
              productId: d.productId || null,
              materialName: d.materialName,
              deliveryDate: dateStr2,
              timeWindow,
              deliveryNotes: d.deliveryNotes || '',
              sourceName: d.sourceName || null,
              sourceAddress: d.sourceAddress || null,
              truckId, truckNumber, driverId, driverName,
              fulfillmentGroupId,
              totalTons: parseFloat(d.quantity) || 0,
              loads: remainingLoads,
              stopOrder: existingStops.length + 2,
              estimatedRoundTripMin: 60,
              createdBy: 'dispatcher'
            })
          });
          toast(`${totalLoads} loads assigned to ${truckNumber}`);
          closeModal('assignModal');
          assigningDeliveryId = null;
          await loadDeliveries();
          render();
          return;
        }
      }
      toast(`Assigned to ${truckNumber}`);
      closeModal('assignModal');
      assigningDeliveryId = null;
      await loadDeliveries();
      render();
    }
  } catch(e) { toast('Error assigning delivery', true); console.error(e); }
  btn.disabled = false;
  btn.textContent = 'Assign';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TRUCK GROUP TOGGLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleTruck(truckId) {
  const el = document.getElementById('truck-' + truckId);
  if (el) el.classList.toggle('collapsed');
}

function showDriverSelect(truckId, btn) {
  const sel = document.getElementById('driverSel-' + truckId);
  if (sel.style.display === 'none') {
    sel.style.display = '';
    btn.textContent = 'cancel';
  } else {
    sel.style.display = 'none';
    btn.textContent = 'change';
  }
}

async function changeTruckDriver(truckId, sel) {
  const driverId = sel.value;
  const opt = sel.options[sel.selectedIndex];
  const driverName = opt.dataset?.name || null;
  const driverPhone = opt.dataset?.phone || null;

  try {
    await fetch(`${API}/trucks`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        id: truckId,
        defaultDriver: driverId ? { id: driverId, name: driverName, phone: driverPhone } : null
      })
    });
    toast(driverName ? `Driver: ${driverName}` : 'Driver removed');
    await loadTrucks();
    render();
  } catch(e) { toast('Error updating driver', true); console.error(e); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DELIVERY DETAIL MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showDetail(deliveryId) {
  const d = deliveries.find(del => del._id === deliveryId);
  if (!d) return;

  const src = getSourceTag(d.source);
  const sc = statusClass(d.status);
  const statusColors = { UNASSIGNED:'#f97316', SCHEDULED:'#eab308', EN_ROUTE:'#22c55e', DELIVERED:'#3b82f6', CANCELLED:'#ef4444' };
  const isEditable = d.status === 'UNASSIGNED' || d.status === 'SCHEDULED';
  const isMultiLoad = (d.totalLoads || 1) > 1;

  // Convert ISO scheduledStartTime â†’ HH:MM (local time) for <input type="time">
  const isoToHHMM = iso => {
    if (!iso) return '';
    const dt = new Date(iso);
    return String(dt.getHours()).padStart(2, '0') + ':' + String(dt.getMinutes()).padStart(2, '0');
  };

  // Time field: start-time picker for multi-load, 2-hr window dropdown for single-load
  const inputStyle = 'background:rgba(0,0,0,0.25);border:1px solid var(--border);border-radius:6px;color:#fff;padding:4px 8px;font-size:13px;';
  const timeOptions = ['','6:00 AM - 8:00 AM','8:00 AM - 10:00 AM','10:00 AM - 12:00 PM','12:00 PM - 2:00 PM','2:00 PM - 4:00 PM'];
  const timeFieldLabel = isMultiLoad ? 'Start Time' : 'Time Window';
  let timeHtml;
  if (isMultiLoad) {
    const curTime = isoToHHMM(d.scheduledStartTime);
    timeHtml = isEditable
      ? `<input type="time" value="${curTime}" onchange="updateDetailStartTime('${d._id}',this.value,${JSON.stringify(d.fulfillmentGroupId)},'${d.deliveryDate||''}',${d.estimatedRoundTripMin||60})" style="${inputStyle}">`
      : `<span>${curTime || 'Not set'}</span>`;
  } else {
    timeHtml = isEditable
      ? `<select onchange="updateTimeWindow('${d._id}', this.value)" style="${inputStyle}">
          ${timeOptions.map(tw => `<option value="${tw}" ${tw === (d.timeWindow||'') ? 'selected' : ''}>${tw || 'Not set'}</option>`).join('')}
         </select>`
      : `<span>${d.timeWindow || 'Not set'}</span>`;
  }

  // Driver field: dropdown when editable, static text otherwise
  const driverHtml = isEditable
    ? `<select id="detailDriverSel" style="${inputStyle}">
        <option value="">No driver</option>
        ${activeDrivers.map(dr => `<option value="${esc(dr.driverId)}" data-name="${esc(dr.name)}" ${dr.driverId === (d.driverId||'') ? 'selected' : ''}>${esc(dr.name)}</option>`).join('')}
       </select>`
    : esc(d.driverName || 'â€”');

  document.getElementById('detailBody').innerHTML = `
    <div style="display:flex;align-items:center;gap:8px;margin-bottom:16px;">
      <span class="card-source ${src.cls}">${src.label}</span>
      <span style="background:${statusColors[d.status] || '#666'}22;color:${statusColors[d.status] || '#666'};padding:3px 10px;border-radius:4px;font-size:11px;font-weight:600;">${d.status}</span>
    </div>
    <h2 style="font-size:18px;margin-bottom:16px;">${esc(d.customerName || 'Unknown')}</h2>
    <div class="detail-grid">
      <div class="detail-field"><label>Phone</label><div class="val">${d.customerPhone ? `<a href="tel:${d.customerPhone}" style="color:var(--blue);">${esc(d.customerPhone)}</a>` : 'â€”'}</div></div>
      <div class="detail-field"><label>Email</label><div class="val">${esc(d.customerEmail || 'â€”')}</div></div>
      <div class="detail-field"><label>Date</label><div class="val">${
        isEditable
          ? `<input type="date" value="${d.deliveryDate || ''}" onchange="updateDeliveryDate('${d._id}', this.value)" style="background:rgba(0,0,0,0.25);border:1px solid var(--border);border-radius:6px;color:#fff;padding:4px 8px;font-size:13px;width:100%;box-sizing:border-box;">`
          : (d.deliveryDate || 'â€”')
      }</div></div>
      <div class="detail-field"><label>${timeFieldLabel}</label><div class="val">${timeHtml}</div></div>
      <div class="detail-field"><label>Material</label><div class="val">${esc(d.materialName || 'â€”')}</div></div>
      <div class="detail-field"><label>Quantity</label><div class="val">${fmtQty(d)}</div></div>
      <div class="detail-field" style="grid-column:1/-1;"><label>Address</label><div class="val">${esc([d.deliveryAddress, d.deliveryCity, d.deliveryState, d.deliveryZip].filter(Boolean).join(', ') || 'â€”')}</div></div>
      ${d.truckNumber ? `<div class="detail-field"><label>Truck</label><div class="val">${esc(d.truckNumber)}</div></div>` : ''}
      <div class="detail-field"><label>Driver</label><div class="val">${driverHtml}</div></div>
      ${d.deliveryNotes ? `<div class="detail-field" style="grid-column:1/-1;"><label>Notes</label><div class="val">${esc(d.deliveryNotes)}</div></div>` : ''}
    </div>
    ${d.deliveryPhoto ? `<div class="detail-photo"><img src="${d.deliveryPhoto}" alt="Delivery photo"></div>` : ''}`;

  let footerHtml = '';
  if (d.status === 'SCHEDULED') {
    footerHtml = `
      <button class="btn btn-primary btn-sm" onclick="closeModal('detailModal');openAssignModal('${d._id}')">Reassign</button>
      <button class="btn btn-outline btn-sm" onclick="openReschedule('${d._id}')">Reschedule</button>
      <button class="btn btn-danger btn-sm" onclick="cancelDelivery('${d._id}')">Cancel</button>
      <button class="btn btn-outline btn-sm" onclick="unassignDelivery('${d._id}')">Unassign</button>
      <button class="btn btn-primary btn-sm" onclick="saveDetailDriver('${d._id}')">Save Driver</button>`;
  } else if (d.status === 'EN_ROUTE') {
    footerHtml = `
      <button class="btn btn-outline btn-sm" onclick="openReschedule('${d._id}')">Reschedule</button>`;
  } else if (d.status === 'UNASSIGNED') {
    footerHtml = `
      <button class="btn btn-primary btn-sm" onclick="closeModal('detailModal');openAssignModal('${d._id}')">Assign</button>
      <button class="btn btn-danger btn-sm" onclick="cancelDelivery('${d._id}')">Cancel</button>
      <button class="btn btn-primary btn-sm" onclick="saveDetailDriver('${d._id}')">Save Driver</button>`;
  }
  footerHtml += `<button class="btn btn-outline btn-sm" onclick="closeModal('detailModal')">Close</button>`;
  document.getElementById('detailFooter').innerHTML = footerHtml;

  openModal('detailModal');
  // panToDelivery removed â€” Leaflet popup conflicts with the modal
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DELIVERY ACTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function cancelDelivery(id) {
  if (!confirm('Cancel this delivery?')) return;
  try {
    await fetch(`${API}/dispatch?id=${id}&by=dispatcher`, { method: 'DELETE' });
    toast('Delivery cancelled');
    closeModal('detailModal');
    await loadDeliveries();
    render();
  } catch(e) { toast('Error cancelling', true); console.error(e); }
}

async function unassignDelivery(id) {
  try {
    await fetch(`${API}/dispatch`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        id,
        truckId: null,
        truckNumber: null,
        driverId: null,
        driverName: null,
        status: 'UNASSIGNED',
        updatedBy: 'dispatcher'
      })
    });
    toast('Delivery unassigned');
    closeModal('detailModal');
    await loadDeliveries();
    render();
  } catch(e) { toast('Error unassigning', true); console.error(e); }
}

async function updateTimeWindow(deliveryId, timeWindow) {
  try {
    await fetch(`${API}/dispatch`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id: deliveryId, timeWindow: timeWindow || null, updatedBy: 'dispatcher' })
    });
    toast('Time window updated');
    await loadDeliveries();
    render();
  } catch(e) { toast('Error updating time', true); console.error(e); }
}

// Update staggered start time for multi-load (or single scheduledStartTime)
async function updateDetailStartTime(deliveryId, timeVal, fulfillmentGroupId, deliveryDate, rtMin) {
  if (!timeVal) return;
  try {
    const rtm = parseInt(rtMin) || 60;
    const date = deliveryDate || new Date().toISOString().split('T')[0];
    if (fulfillmentGroupId) {
      const siblings = deliveries
        .filter(del => del.fulfillmentGroupId === fulfillmentGroupId)
        .sort((a, b) => (a.loadNumber || 1) - (b.loadNumber || 1));
      let t = new Date(`${date}T${timeVal}:00`);
      for (const sib of siblings) {
        await fetch(`${API}/dispatch`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id: sib._id, scheduledStartTime: t.toISOString(), updatedBy: 'dispatcher' })
        });
        t = new Date(t.getTime() + rtm * 60000);
      }
    } else {
      await fetch(`${API}/dispatch`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id: deliveryId, scheduledStartTime: new Date(`${date}T${timeVal}:00`).toISOString(), updatedBy: 'dispatcher' })
      });
    }
    toast('Start time updated');
    await loadDeliveries();
    render();
  } catch(e) { toast('Error updating start time', true); console.error(e); }
}

// Update driver assignment from detail modal (all loads in group for multi-load)
async function updateDetailDriver(deliveryId, selectEl, fulfillmentGroupId) {
  const driverId = selectEl.value || null;
  const driverName = driverId ? selectEl.options[selectEl.selectedIndex].dataset.name : null;
  try {
    const ids = fulfillmentGroupId
      ? deliveries.filter(del => del.fulfillmentGroupId === fulfillmentGroupId).map(del => del._id)
      : [deliveryId];
    for (const id of ids) {
      await fetch(`${API}/dispatch`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id, driverId, driverName, updatedBy: 'dispatcher' })
      });
    }
    toast(driverName ? `Driver set: ${driverName}` : 'Driver removed');
    await loadDeliveries();
    render();
  } catch(e) { toast('Error updating driver', true); console.error(e); }
}

// Called by "Save Driver" button in detail modal footer
async function saveDetailDriver(deliveryId) {
  const selectEl = document.getElementById('detailDriverSel');
  if (!selectEl) return;
  const d = deliveries.find(del => del._id === deliveryId);
  const fulfillmentGroupId = d ? (d.fulfillmentGroupId || null) : null;
  await updateDetailDriver(deliveryId, selectEl, fulfillmentGroupId);
  closeModal('detailModal');
}

let reschedulingDeliveryId = null;

function openReschedule(deliveryId) {
  reschedulingDeliveryId = deliveryId;
  const d = deliveries.find(del => del._id === deliveryId);
  document.getElementById('rescheduleInfo').textContent =
    d ? `${d.customerName || 'Customer'} â€” ${d.materialName || 'material'} Â· ${d.deliveryDate || ''}` : '';
  const today = new Date();
  document.getElementById('rescheduleDate').min = today.toISOString().slice(0, 10);
  document.getElementById('rescheduleDate').value = '';
  closeModal('detailModal');
  openModal('rescheduleModal');
}

async function confirmReschedule() {
  const newDate = document.getElementById('rescheduleDate').value;
  if (!newDate || !reschedulingDeliveryId) return;

  const d = deliveries.find(del => del._id === reschedulingDeliveryId);

  // Fetch all siblings from server by fulfillmentGroupId â€” covers loads split across dates
  let siblings;
  if (d && d.fulfillmentGroupId) {
    try {
      const r = await fetch(`${API}/dispatch?fulfillmentGroupId=${encodeURIComponent(d.fulfillmentGroupId)}`);
      const data = await r.json();
      siblings = (data.deliveries || []).sort((a, b) => (a.loadNumber || 1) - (b.loadNumber || 1));
    } catch(e) {
      siblings = d ? [d] : [];
    }
  } else {
    siblings = d ? [d] : [];
  }

  if (!siblings.length) { toast('Could not find order to reschedule', true); return; }

  try {
    for (const sib of siblings) {
      const payload = { id: sib._id, deliveryDate: newDate, status: 'SCHEDULED', updatedBy: 'dispatcher' };
      // Rebase scheduledStartTime to the new date, preserving the original time-of-day
      if (sib.scheduledStartTime) {
        const orig = new Date(sib.scheduledStartTime);
        const hh = String(orig.getHours()).padStart(2, '0');
        const mm = String(orig.getMinutes()).padStart(2, '0');
        payload.scheduledStartTime = new Date(`${newDate}T${hh}:${mm}:00`).toISOString();
      }
      await fetch(`${API}/dispatch`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
    }
    const label = siblings.length > 1 ? `${siblings.length} loads` : 'Delivery';
    toast(`${label} moved to ${newDate}`);
    await loadDeliveries();
    render();
  } catch(e) { toast('Error rescheduling', true); console.error(e); }

  reschedulingDeliveryId = null;
  closeModal('rescheduleModal');
}

async function updateDeliveryDate(deliveryId, newDate, resetStatus = false) {
  if (!newDate) return;
  try {
    const payload = { id: deliveryId, deliveryDate: newDate, updatedBy: 'dispatcher' };
    if (resetStatus) payload.status = 'SCHEDULED';
    await fetch(`${API}/dispatch`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    toast(`Delivery moved to ${newDate}`);
    await loadDeliveries();
    render();
  } catch(e) { toast('Error updating date', true); console.error(e); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EDIT DELIVERY â€” Dispatcher controls
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function openEditDelivery(deliveryId) {
  editingDeliveryId = deliveryId;
  const delivery = deliveries.find(d => d._id === deliveryId);
  if (!delivery) { toast('Delivery not found', true); return; }

  const statusColor = { DELIVERED:'var(--green)', EN_ROUTE:'#a78bfa', CANCELLED:'var(--red)' }[delivery.status] || 'var(--blue)';
  document.getElementById('editDelSummary').innerHTML = `
    <div style="font-weight:700;font-size:15px;color:#fff;">${esc(delivery.customerName || 'Customer')}</div>
    <div style="color:var(--text-muted);font-size:13px;margin-top:4px;">${esc(delivery.materialName || '')} Â· ${delivery.quantity || '?'} tons</div>
    <div style="color:var(--text-muted);font-size:13px;margin-top:2px;">${esc(delivery.deliveryAddress || '')}${delivery.deliveryCity ? ', ' + esc(delivery.deliveryCity) : ''}</div>
    <div style="color:var(--text-muted);font-size:12px;margin-top:4px;">Status: <span style="color:${statusColor};">${delivery.status}</span></div>
  `;

  document.getElementById('editDelDate').value = delivery.deliveryDate || '';
  document.getElementById('editDelTime').value = delivery.timeWindow || '';
  document.getElementById('editDelNotes').value = delivery.deliveryNotes || '';

  const cancelBtn = document.getElementById('editDelCancelBtn');
  cancelBtn.style.display = (delivery.status === 'DELIVERED' || delivery.status === 'CANCELLED') ? 'none' : 'block';

  openModal('editDeliveryModal');
}

function closeEditDelivery() {
  closeModal('editDeliveryModal');
  editingDeliveryId = null;
}

async function saveEditDelivery() {
  if (!editingDeliveryId) return;

  const updateBody = {
    id: editingDeliveryId,
    updatedBy: 'dispatcher',
    deliveryDate: document.getElementById('editDelDate').value,
    timeWindow: document.getElementById('editDelTime').value,
  };

  const notes = document.getElementById('editDelNotes').value;
  if (notes) updateBody.deliveryNotes = notes;

  try {
    const res = await fetch(`${API}/dispatch`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(updateBody)
    });
    const data = await res.json();
    if (data.success) {
      toast('Delivery updated');
      closeEditDelivery();
      await loadDeliveries();
      render();
    } else {
      toast('Error saving changes', true);
    }
  } catch(e) { toast('Error saving changes', true); console.error(e); }
}

async function cancelDelivery() {
  if (!editingDeliveryId) return;

  const reason = prompt('Reason for cancellation (optional):');
  if (reason === null) return;
  if (!confirm('Are you sure you want to cancel this delivery?')) return;

  try {
    const res = await fetch(`${API}/dispatch?id=${editingDeliveryId}&by=dispatcher&reason=${encodeURIComponent(reason || 'Cancelled by dispatcher')}`, {
      method: 'DELETE'
    });
    const data = await res.json();
    if (data.success) {
      toast('Delivery cancelled');
      closeEditDelivery();
      await loadDeliveries();
      render();
    } else {
      toast('Error cancelling delivery', true);
    }
  } catch(e) { toast('Error cancelling delivery', true); console.error(e); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODALS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openModal(id) { document.getElementById(id).classList.add('active'); }
function closeModal(id) { document.getElementById(id).classList.remove('active'); }

// Saved origin/pickup locations for autocomplete (from delivery_sources collection)
let knownOrigins = {}; // name â†’ address
const CONROE_YARD_NAME = 'Conroe Yard';
const CONROE_YARD_ADDR = '14211 Stuebner Airline Rd, Houston, TX 77069';

function openAddDelivery() {
  resetLocationLink();
  document.getElementById('delDate').value = formatDateISO(currentDate);
  document.getElementById('delOrigin').value = '';
  const addrInput = document.getElementById('delOriginAddr');
  addrInput.value = '';
  addrInput.disabled = false;
  addrInput.style.opacity = '';
  document.getElementById('delOriginAddrRow').style.display = 'none';
  document.getElementById('delPO').value = '';
  // Populate datalist from saved sources
  const dl = document.getElementById('originSuggestions');
  dl.innerHTML = Object.keys(knownOrigins).map(n => `<option value="${esc(n)}">`).join('');
  // Populate truck dropdown for multi-load
  const truckSel = document.getElementById('delTruck');
  truckSel.innerHTML = '<option value="">Unassigned</option>';
  trucks.forEach(truck => {
    const tid = truck._id?.toString() || truck._id;
    const opt = document.createElement('option');
    opt.value = tid;
    opt.dataset.capacity = truck.capacity || 24;
    opt.dataset.truckNumber = truck.truckNumber;
    opt.textContent = `${truck.truckNumber} (${truck.capacity || 24}T cap)`;
    truckSel.appendChild(opt);
  });
  // Reset multi-load state
  document.getElementById('multiLoadPreview').style.display = 'none';
  document.getElementById('saveDeliveryBtn').textContent = 'Add Delivery';
  multiLoadEstRTMin = 60;
  openModal('deliveryModal');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MULTI-LOAD CALCULATION (3B/3C/3D)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let multiLoadEstRTMin = 60; // default round-trip; updated by async ETA fetch

function calcLoads(totalTons, cap) {
  const n = Math.ceil(totalTons / cap);
  const loads = []; let rem = parseFloat(totalTons.toFixed(2));
  for (let i = 1; i <= n; i++) {
    const t = parseFloat(Math.min(rem, cap).toFixed(2));
    loads.push({ loadNumber: i, quantity: t });
    rem = parseFloat((rem - t).toFixed(2));
  }
  return { totalLoads: n, loads };
}

function onDelTruckChange() {
  const truckId = document.getElementById('delTruck').value;
  const qty = parseFloat(document.getElementById('delQty').value);
  updateDelMultiLoadPreview(truckId, qty);
}

function updateDelMultiLoadPreview(truckId, qty) {
  const preview = document.getElementById('multiLoadPreview');
  const btn = document.getElementById('saveDeliveryBtn');
  if (!truckId || !qty || isNaN(qty)) {
    preview.style.display = 'none';
    btn.textContent = 'Add Delivery';
    return;
  }
  const truck = trucks.find(t => (t._id?.toString() || t._id) === truckId);
  if (!truck) return;

  // Convert CYD â†’ tons if needed
  let quantityTons = qty;
  if (delQtyUnit === 'cyd') {
    const materialSel = document.getElementById('delMaterial');
    let weight = 1.4;
    if (materialSel.value && materialSel.value !== '__custom__') {
      weight = parseFloat(materialSel.options[materialSel.selectedIndex].dataset.weight) || 1.4;
    }
    quantityTons = qty * weight;
  }

  const cap = truck.capacity || 24;
  const { totalLoads, loads } = calcLoads(quantityTons, cap);
  if (totalLoads <= 1) {
    preview.style.display = 'none';
    btn.textContent = 'Add Delivery';
    return;
  }

  const estTotalMin = totalLoads * multiLoadEstRTMin;
  const estHr = Math.floor(estTotalMin / 60);
  const estMin = estTotalMin % 60;
  const estStr = estHr > 0 ? `~${estHr}h ${estMin}m total` : `~${estMin}m total`;

  document.getElementById('multiLoadContent').innerHTML = `
    <div style="font-size:13px;font-weight:700;color:#eab308;margin-bottom:6px;">âš  This order requires ${totalLoads} loads:</div>
    ${loads.map(l => `<div style="font-size:13px;color:rgba(255,255,255,0.85);">Load ${l.loadNumber}: ${l.quantity}t</div>`).join('')}
    <div style="font-size:11px;color:var(--text-muted);margin-top:6px;">Est. round-trip: ~${multiLoadEstRTMin} min Â· ${estStr}</div>
  `;
  preview.style.display = 'block';
  btn.textContent = 'Confirm & Schedule';

  // Async ETA fetch for accurate estimate
  const origin = document.getElementById('delOriginAddr').value.trim() || '30.3119,-95.4561';
  const addr = [
    document.getElementById('delAddress').value.trim(),
    document.getElementById('delCity').value.trim(),
    'TX',
    document.getElementById('delZip').value.trim()
  ].filter(Boolean).join(', ');
  if (addr.length > 5) {
    fetch(`${API}/calculate-loads`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ totalTons: quantityTons, truckCapacity: cap, origin, destination: addr })
    }).then(r => r.json()).then(d => {
      if (d.estimatedRoundTripMin) {
        multiLoadEstRTMin = d.estimatedRoundTripMin;
        updateDelMultiLoadPreview(truckId, qty); // re-render with actual ETA
      }
    }).catch(() => {});
  }
}

function onOriginInput(value) {
  const addrRow = document.getElementById('delOriginAddrRow');
  const addrInput = document.getElementById('delOriginAddr');
  const trimmed = value.trim();
  if (!trimmed) {
    addrRow.style.display = 'none';
    addrInput.disabled = false;
    addrInput.style.opacity = '';
    return;
  }
  addrRow.style.display = 'block';
  if (trimmed.toLowerCase() === CONROE_YARD_NAME.toLowerCase()) {
    addrInput.value = CONROE_YARD_ADDR;
    addrInput.disabled = true;
    addrInput.style.opacity = '0.5';
  } else {
    addrInput.disabled = false;
    addrInput.style.opacity = '';
    if (knownOrigins[trimmed]) {
      addrInput.value = knownOrigins[trimmed]; // always sync to the known address
    } else {
      addrInput.value = ''; // clear for new/unknown source
    }
  }
}

async function loadKnownOrigins() {
  try {
    const r = await fetch(`${API}/sources`);
    const data = await r.json();
    knownOrigins = {};
    (data.sources || []).forEach(s => { knownOrigins[s.name] = s.address || ''; });
    // Always seed Conroe Yard
    if (!knownOrigins[CONROE_YARD_NAME]) knownOrigins[CONROE_YARD_NAME] = CONROE_YARD_ADDR;
  } catch(e) { /* non-critical */ }
}

function toggleSourceManager(e) {
  e.preventDefault();
  const mgr = document.getElementById('sourceManager');
  if (mgr.style.display === 'none') {
    renderSourceManager();
    mgr.style.display = 'block';
  } else {
    mgr.style.display = 'none';
  }
}

function renderSourceManager() {
  const mgr = document.getElementById('sourceManager');
  const names = Object.keys(knownOrigins).filter(n => n.toLowerCase() !== CONROE_YARD_NAME.toLowerCase());
  if (!names.length) {
    mgr.innerHTML = '<div style="color:var(--text-muted);font-size:12px;padding:4px;">No saved sources</div>';
    return;
  }
  mgr.innerHTML = names.sort().map(name => `
    <div style="display:flex;align-items:center;justify-content:space-between;padding:6px 0;border-bottom:1px solid rgba(255,255,255,0.06);">
      <div style="flex:1;min-width:0;">
        <div style="font-weight:600;font-size:13px;color:#fff;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${esc(name)}</div>
        <div style="font-size:11px;color:var(--text-muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${esc(knownOrigins[name] || 'â€”')}</div>
      </div>
      <button onclick="deleteSource('${name.replace(/'/g, "\\'")}')" style="background:rgba(239,68,68,0.15);border:1px solid rgba(239,68,68,0.3);color:var(--red);border-radius:6px;padding:4px 8px;cursor:pointer;font-size:11px;margin-left:8px;flex-shrink:0;">âœ•</button>
    </div>
  `).join('');
}

async function deleteSource(name) {
  if (!confirm(`Remove "${name}" from saved sources?`)) return;
  delete knownOrigins[name];
  try {
    await fetch(`${API}/sources`, {
      method: 'DELETE',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name })
    });
  } catch(e) { console.error('Error deleting source:', e); }
  // Rebuild datalist
  const dl = document.getElementById('originSuggestions');
  if (dl) dl.innerHTML = Object.keys(knownOrigins).map(n => `<option value="${esc(n)}">`).join('');
  renderSourceManager();
  toast('Source removed');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SAVE DELIVERY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function saveDelivery() {
  const customer = document.getElementById('delCustomer').value.trim();
  const materialSel = document.getElementById('delMaterial');
  const isCustom = materialSel.value === '__custom__';
  const customMaterialName = isCustom ? document.getElementById('delMaterialCustom').value.trim() : '';
  const qty = parseFloat(document.getElementById('delQty').value);
  const date = document.getElementById('delDate').value;

  if (!customer || (!materialSel.value && !isCustom) || isNaN(qty) || !date) {
    toast('Please fill required fields', true);
    return;
  }
  if (isCustom && !customMaterialName) {
    toast('Please enter the custom material name', true);
    return;
  }

  const materialName = isCustom
    ? customMaterialName
    : (materialSel.options[materialSel.selectedIndex].dataset.name || materialSel.options[materialSel.selectedIndex].text);

  // Convert CYD to tons if dispatcher entered CYD
  let quantityTons = qty;
  if (delQtyUnit === 'cyd') {
    let weight = 1.4;
    if (!isCustom && materialSel.value) {
      weight = parseFloat(materialSel.options[materialSel.selectedIndex].dataset.weight) || 1.4;
    }
    quantityTons = Math.round(qty * weight * 100) / 100;
  }

  // Determine truck assignment and multi-load breakdown
  const delTruckSel = document.getElementById('delTruck');
  const delTruckId = delTruckSel.value || null;
  const delTruck = delTruckId ? trucks.find(t => (t._id?.toString() || t._id) === delTruckId) : null;
  const delTruckCap = delTruck?.capacity || 24;
  const delTruckNumber = delTruck?.truckNumber || null;
  const { totalLoads, loads } = delTruckId ? calcLoads(quantityTons, delTruckCap) : { totalLoads: 1, loads: [{ loadNumber: 1, quantity: quantityTons }] };

  // Base payload shared by single and multi-load paths
  const basePayload = {
    source: document.getElementById('delSource').value,
    customerName: customer,
    customerPhone: document.getElementById('delPhone').value.trim(),
    customerEmail: document.getElementById('delEmail').value.trim(),
    deliveryAddress: document.getElementById('delAddress').value.trim(),
    deliveryCity: document.getElementById('delCity').value.trim(),
    deliveryZip: document.getElementById('delZip').value.trim(),
    productId: isCustom ? null : materialSel.value,
    materialName,
    deliveryDate: date,
    timeWindow: document.getElementById('delTime').value || null,
    deliveryNotes: document.getElementById('delNotes').value.trim(),
    sourceName: document.getElementById('delOrigin').value.trim() || null,
    sourceAddress: document.getElementById('delOriginAddr').value.trim() || null,
    poNumber: document.getElementById('delPO').value.trim() || null,
    deliveryLat: deliveryPinLat || null,
    deliveryLng: deliveryPinLng || null,
    truckId: delTruckId,
    truckNumber: delTruckNumber,
    createdBy: 'dispatcher'
  };

  // Stagger start times for multi-load
  const startTimeVal = document.getElementById('delStartTime').value || '07:00';
  const staggeredLoads = loads.map((l, idx) => {
    const offsetMin = idx * multiLoadEstRTMin;
    const base = new Date(`${date}T${startTimeVal}:00`);
    base.setMinutes(base.getMinutes() + offsetMin);
    return { ...l, scheduledStartTime: base.toISOString() };
  });

  try {
    let r;
    if (totalLoads > 1) {
      r = await fetch(`${API}/dispatch`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          action: 'multi_load',
          ...basePayload,
          quantity: quantityTons,
          totalTons: quantityTons,
          loads: staggeredLoads,
          estimatedRoundTripMin: multiLoadEstRTMin
        })
      });
    } else {
      r = await fetch(`${API}/dispatch`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ...basePayload, quantity: quantityTons })
      });
    }
    const data = await r.json();
    if (data.success) {
      const sourceName = document.getElementById('delOrigin').value.trim();
      const sourceAddress = document.getElementById('delOriginAddr').value.trim();
      if (sourceName && sourceAddress) {
        knownOrigins[sourceName] = sourceAddress;
        // Persist to delivery_sources collection
        fetch(`${API}/sources`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name: sourceName, address: sourceAddress })
        }).catch(() => {});
      }
      toast(totalLoads > 1 ? `${totalLoads} loads scheduled` : 'Delivery added');
      closeModal('deliveryModal');
      // Reset unit toggle
      delQtyUnit = 'tons';
      const qub = document.getElementById('delQtyUnitBtn');
      qub.textContent = 'tons';
      qub.style.background = 'rgba(255,255,255,0.08)';
      qub.style.color = 'var(--text)';
      qub.style.borderColor = 'var(--border)';
      document.getElementById('delQtyLabel').textContent = 'Quantity (tons) *';
      document.getElementById('delMaterialCustomRow').style.display = 'none';
      document.getElementById('delMaterialCustom').value = '';
      const addrInput = document.getElementById('delOriginAddr');
      addrInput.disabled = false;
      addrInput.style.opacity = '';
      resetLocationLink();
      ['delCustomer','delPhone','delEmail','delAddress','delCity','delZip','delQty','delNotes','delOrigin','delOriginAddr','delPO'].forEach(id => document.getElementById(id).value = '');
      await loadDeliveries();
      render();
    }
  } catch(e) { toast('Error saving delivery', true); console.error(e); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FINALIZE & NOTIFY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function finalizeSchedule() {
  const dateStr = formatDateISO(currentDate);
  const scheduled = deliveries.filter(d => d.deliveryDate === dateStr && d.status === 'SCHEDULED' && !d.scheduleSmsSent);

  if (!scheduled.length) {
    toast('No new deliveries to finalize for this date', true);
    return;
  }

  const withContact = scheduled.filter(d => d.customerPhone || d.customerEmail);
  const unassignedCount = deliveries.filter(d => d.deliveryDate === dateStr && d.status === 'UNASSIGNED').length;

  // Build summary list
  const rows = scheduled.map(d =>
    `<div class="finalize-row"><span class="fr-name">${esc(d.customerName || 'Unknown')}</span><span class="fr-material">${esc(d.materialName || '?')} Â· ${fmtQty(d)}</span><span class="fr-truck">${esc(d.truckNumber || 'â€”')}</span></div>`
  ).join('');

  let body = `<p style="color:var(--text-muted);font-size:14px;margin-bottom:12px;">You are about to finalize <strong style="color:#fff;">${scheduled.length}</strong> assigned deliver${scheduled.length === 1 ? 'y' : 'ies'} and notify <strong style="color:#fff;">${withContact.length}</strong> customer${withContact.length === 1 ? '' : 's'} via SMS and email.</p>`;
  body += `<div class="finalize-summary">${rows}</div>`;
  if (unassignedCount > 0) {
    body += `<div class="finalize-unassigned-note">âš  ${unassignedCount} deliver${unassignedCount === 1 ? 'y' : 'ies'} will remain unassigned.</div>`;
  }

  document.getElementById('finalizeBody').innerHTML = body;
  document.getElementById('finalizeFooter').innerHTML = `
    <button class="btn btn-outline" onclick="closeModal('finalizeModal')">Cancel</button>
    <button class="btn btn-success" id="finalizeConfirmBtn" onclick="executeFinalizeAndNotify()">Confirm &amp; Send</button>`;
  openModal('finalizeModal');
}

async function executeFinalizeAndNotify() {
  const dateStr = formatDateISO(currentDate);
  const btn = document.getElementById('finalizeConfirmBtn');
  btn.disabled = true;
  btn.innerHTML = '<span class="finalize-spinner"></span>Sending...';

  try {
    // Step 1: Mark as finalized in DB
    const finalRes = await fetch(`${API}/dispatch`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action: 'finalize', date: dateStr, updatedBy: 'dispatcher' })
    });
    const finalData = await finalRes.json();

    // Step 2: Send notifications
    let notifyData = null;
    if (finalData.toNotify && finalData.toNotify.length) {
      const notifyRes = await fetch(`${API}/notify`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          type: 'schedule_confirmation',
          deliveries: finalData.toNotify
        })
      });
      notifyData = await notifyRes.json();
    }

    // Step 3: Alert owner (fire-and-forget)
    const truckCount = new Set(finalData.toNotify?.map(d => d.truckNumber || d.truckId).filter(Boolean)).size || 0;
    fetch(`${API}/notify`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        type: 'owner_finalized',
        deliveryCount: finalData.toNotify?.length || finalData.finalized || 0,
        truckCount,
        date: dateStr
      })
    }).catch(err => console.error('Owner alert error:', err));

    // Show success state
    const newCount = finalData.toNotify?.length || 0;
    const skippedCount = finalData.alreadyNotified || 0;
    const totalCount = newCount + skippedCount;
    const notifyResults = notifyData?.results || [];

    let detailHtml = '';
    (finalData.toNotify || []).forEach((del, i) => {
      const r = notifyResults[i] || {};
      const smsOk = r.sms?.success;
      const emailOk = r.email?.success;
      const hasPhone = del.customerPhone && del.customerPhone.trim();
      const hasEmail = del.customerEmail && del.customerEmail.trim();
      detailHtml += `<div style="padding:10px 0;border-bottom:1px solid rgba(255,255,255,0.08);font-size:13px;">
        <div style="font-weight:700;color:#fff;">${esc(del.customerName || 'Customer')}</div>
        <div style="color:var(--text-muted);margin-top:2px;">${esc(del.materialName || '')} Â· ${del.quantity || '?'} tons</div>
        <div style="margin-top:4px;">
          ${hasPhone ? (smsOk ? '<span style="color:var(--green);">SMS âœ“</span>' : '<span style="color:var(--red);">SMS âœ—</span>') : '<span style="color:var(--text-muted);">SMS â€” no phone</span>'}
          <span style="margin-left:12px;">${hasEmail ? (emailOk ? '<span style="color:var(--green);">Email âœ“</span>' : '<span style="color:var(--red);">Email âœ—</span>') : '<span style="color:var(--text-muted);">Email â€” no email</span>'}</span>
        </div>
      </div>`;
    });

    const summaryLine = skippedCount > 0 || totalCount > 0
      ? `<div style="font-size:13px;color:var(--text-muted);margin-top:8px;">${skippedCount} previously notified${newCount > 0 ? ' (skipped)' : ''} Â· ${totalCount} total scheduled</div>`
      : '';

    document.getElementById('finalizeBody').innerHTML = newCount > 0
      ? `<div class="finalize-success">
          <div class="check">âœ…</div>
          <div class="msg">${newCount} new notification${newCount !== 1 ? 's' : ''} sent</div>
          <div style="max-height:280px;overflow-y:auto;margin:12px 0;text-align:left;">${detailHtml}</div>
          ${summaryLine}
        </div>`
      : `<div class="finalize-success">
          <div class="check">âœ…</div>
          <div style="font-size:16px;font-weight:700;color:#fff;margin-bottom:8px;">All customers already notified</div>
          ${summaryLine}
        </div>`;
    document.getElementById('finalizeFooter').innerHTML = `
      <button class="btn btn-primary" onclick="closeModal('finalizeModal')">Done</button>`;

    await loadDeliveries();
    render();
  } catch(e) {
    toast('Error finalizing schedule', true);
    console.error(e);
    closeModal('finalizeModal');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILITIES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function esc(text) {
  const div = document.createElement('div');
  div.textContent = text || '';
  return div.innerHTML;
}

function toast(msg, error = false) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.className = 'toast show' + (error ? ' error' : '');
  clearTimeout(toast._t);
  toast._t = setTimeout(() => el.className = 'toast', 3000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAP â€” INIT, PINS, DRIVERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const STATUS_COLORS = {
  UNASSIGNED: '#6b7280',
  SCHEDULED:  '#eab308',
  EN_ROUTE:   '#22c55e',
  DELIVERED:  '#3b82f6',
  CANCELLED:  '#ef4444'
};

function initMap() {
  if (map) return;
  map = L.map('dispatchMap').setView([30.31, -95.46], 10);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap',
    maxZoom: 18
  }).addTo(map);
}

function toggleMap() {
  const panel = document.getElementById('mapPanel');
  panel.classList.toggle('map-visible');
  if (panel.classList.contains('map-visible')) {
    setTimeout(() => { if (map) map.invalidateSize(); }, 100);
  }
}

// â”€â”€â”€ Geocode + pin deliveries on map â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let geocodeQueue = [];
let geocodeRunning = false;

async function geocodeAndPin(delivery, opts = {}) {
  const id = delivery._id;
  // Check in-memory cache (lat/lng) then DB-stored fields (deliveryLat/deliveryLng)
  const cachedLat = delivery.lat ?? delivery.deliveryLat;
  const cachedLng = delivery.lng ?? delivery.deliveryLng;
  if (cachedLat != null && cachedLng != null) {
    addDeliveryMarker(delivery, cachedLat, cachedLng, opts);
    return;
  }
  const addr = [delivery.deliveryAddress, delivery.deliveryCity, delivery.deliveryState || 'TX', delivery.deliveryZip].filter(Boolean).join(', ');
  if (!addr || addr === 'TX') return;
  geocodeQueue.push({ delivery, addr, opts });
  processGeocodeQueue();
}

async function processGeocodeQueue() {
  if (geocodeRunning || !geocodeQueue.length) return;
  geocodeRunning = true;

  while (geocodeQueue.length) {
    const { delivery, addr, opts = {} } = geocodeQueue.shift();
    try {
      const r = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(addr)}&format=json&limit=1`);
      const results = await r.json();
      if (results.length) {
        const lat = parseFloat(results[0].lat);
        const lng = parseFloat(results[0].lon);
        // Cache in memory so subsequent updateMapPins calls render instantly
        delivery.lat = lat;
        delivery.lng = lng;
        const idx = deliveries.findIndex(d => d._id === delivery._id);
        if (idx !== -1) { deliveries[idx].lat = lat; deliveries[idx].lng = lng; }
        addDeliveryMarker(delivery, lat, lng, opts);
        // Cache coords on delivery doc (fire-and-forget)
        fetch(`${API}/dispatch`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id: delivery._id, lat, lng, updatedBy: 'geocoder' })
        }).catch(() => {});
      }
    } catch(e) { console.error('Geocode error:', e); }
    // Nominatim rate limit: 1 req/sec
    await new Promise(r => setTimeout(r, 1100));
  }
  geocodeRunning = false;
}

function addDeliveryMarker(d, lat, lng, opts = {}) {
  if (!map) return;
  // Remove old marker if exists
  if (deliveryMarkers[d._id]) { map.removeLayer(deliveryMarkers[d._id]); }

  const color = opts.color || STATUS_COLORS[d.status] || '#6b7280';
  const statusLabel = opts.statusLabel || d.status;
  const marker = L.circleMarker([lat, lng], {
    radius: 9,
    fillColor: color,
    color: '#fff',
    weight: 2,
    opacity: 1,
    fillOpacity: 0.85
  }).addTo(map);

  marker.bindPopup(`
    <div style="font-family:sans-serif;min-width:160px;">
      <strong>${esc(d.customerName || 'Unknown')}</strong><br>
      ${esc(d.materialName || '?')} &middot; ${fmtQty(d)}<br>
      <span style="color:#666;font-size:12px;">${esc(d.deliveryAddress || '')}</span><br>
      <span style="color:${color};font-weight:600;font-size:12px;">${statusLabel}</span>
    </div>
  `);

  deliveryMarkers[d._id] = marker;
}

function updateMapPins() {
  if (!map) return;
  // Clear old markers and discard any stale geocode queue items so they
  // don't overwrite fresh Rocky-purple pins when they eventually resolve.
  Object.values(deliveryMarkers).forEach(m => map.removeLayer(m));
  deliveryMarkers = {};
  geocodeQueue.length = 0;

  const dateStr = formatDateISO(currentDate);
  const dayDels = deliveries.filter(d => d.deliveryDate === dateStr && d.status !== 'CANCELLED');
  dayDels.forEach(d => {
    const rockyA = rockyState === 'suggested' ? rockyAssignments[d._id] : null;
    geocodeAndPin(d, rockyA ? { color: '#8b5cf6', statusLabel: `Suggested: ${rockyA.truckNumber}` } : {});
  });
}

function panToDelivery(deliveryId) {
  const marker = deliveryMarkers[deliveryId];
  if (marker && map) {
    map.setView(marker.getLatLng(), 14);
    marker.openPopup();
    // On mobile, ensure map is visible
    const panel = document.getElementById('mapPanel');
    if (!panel.classList.contains('map-visible') && window.innerWidth <= 1024) {
      panel.classList.add('map-visible');
      setTimeout(() => map.invalidateSize(), 100);
      setTimeout(() => { map.setView(marker.getLatLng(), 14); marker.openPopup(); }, 200);
    }
  }
}

// â”€â”€â”€ Driver markers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function refreshDriverLocations() {
  if (!map) return;
  try {
    const r = await fetch(`${API}/driver-location`);
    const data = await r.json();
    const locations = data.locations || [];

    // Remove stale markers
    const activeIds = new Set(locations.map(l => l.driverId));
    Object.keys(driverMarkers).forEach(id => {
      if (!activeIds.has(id)) {
        map.removeLayer(driverMarkers[id]);
        delete driverMarkers[id];
      }
    });

    locations.forEach(loc => {
      const latlng = [loc.lat, loc.lng];
      const ago = Math.round((Date.now() - new Date(loc.timestamp).getTime()) / 60000);
      const truck = trucks.find(t => t.defaultDriver?.id === loc.driverId);
      const truckNum = truck ? truck.truckNumber : null;
      const label = truckNum
        ? `${truckNum} â€” ${esc(loc.driverName || loc.driverId)}`
        : esc(loc.driverName || loc.driverId);
      const popupHtml = `
        <div style="font-family:sans-serif;">
          <strong>ğŸš› ${label}</strong><br>
          <span style="color:#666;font-size:12px;">Updated ${ago}m ago</span>
        </div>`;

      if (driverMarkers[loc.driverId]) {
        driverMarkers[loc.driverId].setLatLng(latlng);
        driverMarkers[loc.driverId].setPopupContent(popupHtml);
      } else {
        const icon = L.divIcon({
          className: '',
          html: '<div style="background:#e67e22;color:#fff;width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:14px;border:2px solid #fff;box-shadow:0 1px 4px rgba(0,0,0,0.3);">ğŸš›</div>',
          iconSize: [28, 28],
          iconAnchor: [14, 14]
        });
        const marker = L.marker(latlng, { icon }).addTo(map);
        marker.bindPopup(popupHtml);
        driverMarkers[loc.driverId] = marker;
      }
    });
  } catch(e) { console.error('Driver locations error:', e); }
}

function startDriverRefresh() {
  refreshDriverLocations();
  driverRefreshTimer = setInterval(refreshDriverLocations, 30000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ROCKY SUGGESTS â€” AI Auto-Dispatch
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadRockySuggestions() {
  const dateStr = formatDateISO(currentDate);
  const unassigned = deliveries.filter(d => d.status === 'UNASSIGNED' && d.deliveryDate === dateStr);
  if (!unassigned.length) return; // nothing to suggest

  setRockyState('loading');
  try {
    const r = await fetch(`${API}/rocky-suggests?date=${dateStr}`);
    const data = await r.json();
    if (!data.success || !data.assignments?.length) {
      setRockyState('idle');
      return;
    }
    rockyPlan = data;
    rockyAssignments = {};
    data.assignments.forEach(a => {
      rockyAssignments[a.deliveryId] = { ...a, routeSource: 'rocky' };
    });
    setRockyState('suggested');
    render();
  } catch(e) {
    console.error('Rocky suggests error:', e);
    setRockyState('idle');
  }
}

function setRockyState(state) {
  rockyState = state;
  const banner = document.getElementById('rockyBanner');
  const text = document.getElementById('rockyBannerText');
  const confirmBtn = document.getElementById('rockyConfirmBtn');
  banner.className = '';
  confirmBtn.style.display = 'none';
  confirmBtn.disabled = false;
  confirmBtn.textContent = 'âœ… Confirm Assignments';

  if (state === 'loading') {
    banner.classList.add('loading');
    text.innerHTML = '<span class="rocky-spinner"></span> ğŸ¤– Rocky is planning today\'s routes...';
  } else if (state === 'suggested') {
    banner.classList.add('suggested');
    const count = Object.keys(rockyAssignments).length;
    const truckSet = new Set(Object.values(rockyAssignments).map(a => a.truckId));
    text.innerHTML = `<span style="font-size:16px;">ğŸ¤–</span>&ensp;<strong>Rocky has suggested assignments for ${count} deliver${count === 1 ? 'y' : 'ies'} across ${truckSet.size} truck${truckSet.size === 1 ? '' : 's'}.</strong>&ensp;Review below and confirm when ready.`;
    confirmBtn.style.display = '';
  } else if (state === 'confirmed') {
    banner.classList.add('confirmed');
    text.innerHTML = 'âœ… Assignments confirmed â€” ready to Finalize &amp; Notify';
  }
}

function clearRockyPlan() {
  rockyPlan = null;
  rockyAssignments = {};
  setRockyState('idle');
}

async function confirmRockyAssignments() {
  const assignments = Object.entries(rockyAssignments).map(([deliveryId, a]) => ({
    deliveryId,
    truckId: a.truckId,
    truckNumber: a.truckNumber,
    stopOrder: a.stopOrder || 1,
    routeSource: a.routeSource || 'rocky',
    driverId: a.driverId || null,
    driverName: a.driverName || null,
    timeWindow: a.timeWindow || null,
    reasoning: a.reasoning || null
  }));

  const btn = document.getElementById('rockyConfirmBtn');
  btn.disabled = true;
  btn.textContent = 'Confirming...';

  try {
    const r = await fetch(`${API}/rocky-apply`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ date: formatDateISO(currentDate), assignments })
    });
    const data = await r.json();
    if (data.success) {
      rockyAssignments = {};
      rockyPlan = null;
      setRockyState('confirmed');
      await loadDeliveries();
      render();
      toast(`âœ… ${data.applied} assignment${data.applied === 1 ? '' : 's'} confirmed`);
    } else {
      toast('Error confirming assignments', true);
      btn.disabled = false;
      btn.textContent = 'âœ… Confirm Assignments';
    }
  } catch(e) {
    console.error('Rocky apply error:', e);
    toast('Error confirming assignments', true);
    btn.disabled = false;
    btn.textContent = 'âœ… Confirm Assignments';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOCATION LINK â€” Parse pasted map URLs
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function parseMapUrl(url) {
  const trimmed = url.trim();

  // 1. Raw coordinates: "30.3119, -95.4561"
  const rawCoords = trimmed.match(/^(-?\d+\.?\d*)\s*,\s*(-?\d+\.?\d*)$/);
  if (rawCoords) {
    const lat = parseFloat(rawCoords[1]);
    const lng = parseFloat(rawCoords[2]);
    if (lat >= -90 && lat <= 90 && lng >= -180 && lng <= 180) return { lat, lng };
  }

  // 2. Google Maps: ?q=lat,lng
  const googleQ = trimmed.match(/[?&]q=(-?\d+\.?\d*)\s*,\s*(-?\d+\.?\d*)/);
  if (googleQ) return { lat: parseFloat(googleQ[1]), lng: parseFloat(googleQ[2]) };

  // 3. Google Maps: @lat,lng
  const googleAt = trimmed.match(/@(-?\d+\.?\d*),(-?\d+\.?\d*)/);
  if (googleAt) return { lat: parseFloat(googleAt[1]), lng: parseFloat(googleAt[2]) };

  // 4. Apple Maps: ll=lat,lng
  const appleLl = trimmed.match(/[?&]ll=(-?\d+\.?\d*),(-?\d+\.?\d*)/);
  if (appleLl) return { lat: parseFloat(appleLl[1]), lng: parseFloat(appleLl[2]) };

  // 5. Google Maps place path: /place/.../@lat,lng
  const placePath = trimmed.match(/\/place\/[^/]*\/@(-?\d+\.?\d*),(-?\d+\.?\d*)/);
  if (placePath) return { lat: parseFloat(placePath[1]), lng: parseFloat(placePath[2]) };

  return null;
}

function isShortMapUrl(url) {
  return /^https?:\/\/(maps\.app\.goo\.gl|goo\.gl\/maps)\//i.test(url.trim());
}

function onLocationLinkInput(value) {
  clearTimeout(locationLinkDebounce);
  const trimmed = value.trim();
  const statusEl = document.getElementById('locationLinkStatus');
  const clearBtn = document.getElementById('locationLinkClearBtn');

  if (!trimmed) {
    statusEl.style.display = 'none';
    clearBtn.style.display = 'none';
    deliveryPinLat = null;
    deliveryPinLng = null;
    return;
  }

  clearBtn.style.display = 'block';

  locationLinkDebounce = setTimeout(async () => {
    let coords = parseMapUrl(trimmed);

    if (coords) {
      applyParsedCoords(coords.lat, coords.lng);
      return;
    }

    if (isShortMapUrl(trimmed)) {
      statusEl.style.display = 'block';
      statusEl.className = 'location-link-resolving';
      statusEl.textContent = 'â³ Resolving link...';

      try {
        const r = await fetch(`${API}/resolve-map-link?url=${encodeURIComponent(trimmed)}`);
        const data = await r.json();
        if (data.success && data.resolvedUrl) {
          coords = parseMapUrl(data.resolvedUrl);
          if (coords) {
            applyParsedCoords(coords.lat, coords.lng);
            return;
          }
        }
        statusEl.className = 'location-link-error';
        statusEl.textContent = 'âš  Could not extract coordinates from this link';
      } catch(e) {
        statusEl.className = 'location-link-error';
        statusEl.textContent = 'âš  Error resolving link';
        console.error('Resolve link error:', e);
      }
      return;
    }

    if (trimmed.startsWith('http')) {
      statusEl.style.display = 'block';
      statusEl.className = 'location-link-error';
      statusEl.textContent = 'âš  Unrecognized link format â€” try a Google or Apple Maps link';
    } else {
      statusEl.style.display = 'none';
    }
  }, 400);
}

async function applyParsedCoords(lat, lng) {
  deliveryPinLat = lat;
  deliveryPinLng = lng;

  const statusEl = document.getElementById('locationLinkStatus');
  statusEl.style.display = 'block';
  statusEl.className = 'location-link-success';
  statusEl.innerHTML = `âœ… <span class="location-link-coords">${lat.toFixed(6)}, ${lng.toFixed(6)}</span> â€” resolving address...`;

  try {
    const r = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json&addressdetails=1`);
    const data = await r.json();
    if (data && data.address) {
      const a = data.address;
      const street = [a.house_number, a.road].filter(Boolean).join(' ');
      const city = a.city || a.town || a.village || a.hamlet || '';
      const zip = a.postcode || '';

      if (street) document.getElementById('delAddress').value = street;
      if (city) document.getElementById('delCity').value = city;
      if (zip) document.getElementById('delZip').value = zip;

      const resolvedText = [street, city, a.state, zip].filter(Boolean).join(', ');
      statusEl.innerHTML = `âœ… <span class="location-link-coords">${lat.toFixed(6)}, ${lng.toFixed(6)}</span><br>${resolvedText || 'Coordinates saved (no street address found)'}`;
    } else {
      statusEl.innerHTML = `âœ… <span class="location-link-coords">${lat.toFixed(6)}, ${lng.toFixed(6)}</span><br>Coordinates saved (no address found at this location)`;
    }
  } catch(e) {
    console.error('Reverse geocode error:', e);
    statusEl.innerHTML = `âœ… <span class="location-link-coords">${lat.toFixed(6)}, ${lng.toFixed(6)}</span><br>Coordinates saved (geocoding unavailable)`;
  }
}

function clearLocationLink() {
  document.getElementById('delLocationLink').value = '';
  document.getElementById('locationLinkStatus').style.display = 'none';
  document.getElementById('locationLinkClearBtn').style.display = 'none';
  deliveryPinLat = null;
  deliveryPinLng = null;
  resetPinDrop();
}

function resetLocationLink() {
  clearLocationLink();
  resetPinDrop();
  activeLocTab = 'link';
  var tabLink = document.getElementById('locTabLink');
  var tabMap = document.getElementById('locTabMap');
  var panelLink = document.getElementById('locPanelLink');
  var panelMap = document.getElementById('locPanelMap');
  if (tabLink) tabLink.classList.add('active');
  if (tabMap) tabMap.classList.remove('active');
  if (panelLink) panelLink.style.display = 'block';
  if (panelMap) panelMap.style.display = 'none';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOCATION PIN â€” Tab switching + Map pin drop
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function switchLocTab(tab) {
  activeLocTab = tab;
  document.getElementById('locTabLink').classList.toggle('active', tab === 'link');
  document.getElementById('locTabMap').classList.toggle('active', tab === 'map');
  document.getElementById('locPanelLink').style.display = tab === 'link' ? 'block' : 'none';
  document.getElementById('locPanelMap').style.display = tab === 'map' ? 'block' : 'none';

  if (tab === 'map') {
    initPinDropMap();
  }
}

function initPinDropMap() {
  if (pinDropMapInstance) {
    setTimeout(() => pinDropMapInstance.invalidateSize(), 150);
    return;
  }
  pinDropMapInstance = L.map('pinDropMap').setView([30.3119, -95.4561], 11);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Â© OpenStreetMap',
    maxZoom: 18
  }).addTo(pinDropMapInstance);

  pinDropMapInstance.on('click', function(e) {
    placePin(e.latlng.lat, e.latlng.lng);
  });

  setTimeout(() => pinDropMapInstance.invalidateSize(), 250);
}

function placePin(lat, lng) {
  if (pinDropMarker) {
    pinDropMarker.setLatLng([lat, lng]);
  } else {
    pinDropMarker = L.marker([lat, lng], { draggable: true }).addTo(pinDropMapInstance);
    pinDropMarker.on('dragend', function(e) {
      const pos = e.target.getLatLng();
      placePin(pos.lat, pos.lng);
    });
  }
  applyParsedCoords(lat, lng);
}

function resetPinDrop() {
  if (pinDropMarker && pinDropMapInstance) {
    pinDropMapInstance.removeLayer(pinDropMarker);
    pinDropMarker = null;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('DOMContentLoaded', () => {
  renderDateLabel();
  initMap();
  loadAll();
  startDriverRefresh();
});
</script>
</body>
</html>
