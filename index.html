<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RockRunner Logistics</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="apple-touch-icon" href="icon-180.png">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#C65D2A">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root{--primary:#C65D2A;--primary-light:#E07A3A;--accent:#6BB8D1;--navy:#1E3A5F;--bg-dark:#0F1A24;--bg-card:#1A2A3A;--bg-hover:#243444;--text-primary:#FFF;--text-secondary:#8AA4B8;--text-muted:#5A7488;--border:rgba(255,255,255,0.1);--success:#4CAF50;--warning:#FFC857;--danger:#FF6B6B;--tc-color:#6BB8D1;--yard-color:#FFC857;--tgr-color:#4CAF50}
        *{box-sizing:border-box;margin:0;padding:0}body{font-family:'DM Sans',sans-serif;background:var(--bg-dark);color:var(--text-primary);min-height:100vh}
        .header{background:linear-gradient(135deg,var(--navy),var(--bg-dark));padding:16px 24px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border);position:sticky;top:0;z-index:100}
        .logo-section{display:flex;align-items:center;gap:16px}.logo{width:50px;height:50px;border-radius:12px;overflow:hidden}.logo img{width:100%;height:100%;object-fit:cover}
        .brand h1{font-size:22px;font-weight:700;color:var(--primary)}.brand span{font-size:13px;color:var(--text-secondary)}
        .header-actions{display:flex;gap:12px}.btn{padding:10px 20px;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;border:none;display:flex;align-items:center;gap:8px}
        .btn-primary{background:var(--primary);color:#fff}.btn-primary:hover{background:var(--primary-light)}.btn-secondary{background:var(--bg-card);color:var(--text-primary);border:1px solid var(--border)}.btn-secondary:hover{background:var(--bg-hover)}
        .main-layout{display:flex;height:calc(100vh - 83px)}
        .sidebar{width:280px;background:var(--bg-card);border-right:1px solid var(--border);display:flex;flex-direction:column;transition:width .3s}.sidebar.collapsed{width:50px}.sidebar.collapsed .sidebar-content,.sidebar.collapsed .sidebar-header h2,.sidebar.collapsed .add-truck-btn{display:none}
        .sidebar-header{padding:16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px}.sidebar-header h2{font-size:15px;white-space:nowrap;flex:1}
        .collapse-btn,.add-truck-btn{width:32px;height:32px;min-width:32px;border-radius:8px;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center}
        .collapse-btn{background:var(--bg-dark);color:var(--text-secondary);border:1px solid var(--border)}.collapse-btn:hover{background:var(--bg-hover);color:var(--text-primary)}
        .add-truck-btn{background:var(--primary);color:#fff;font-size:20px}
        .truck-list{flex:1;overflow-y:auto;padding:12px}
        .truck-item{background:var(--bg-dark);border:1px solid var(--border);border-radius:10px;padding:14px;margin-bottom:10px}.truck-item:hover{border-color:var(--primary)}
        .truck-header{display:flex;justify-content:space-between;margin-bottom:6px}.truck-number{font-weight:700}.truck-capacity{background:var(--accent);color:var(--navy);padding:3px 8px;border-radius:12px;font-size:11px;font-weight:600}
        .truck-type{font-size:12px;color:var(--text-secondary)}.truck-actions{display:flex;gap:8px;margin-top:10px}
        .truck-action-btn{flex:1;padding:6px;border-radius:6px;border:1px solid var(--border);background:transparent;color:var(--text-secondary);font-size:12px;cursor:pointer}.truck-action-btn:hover{background:var(--bg-hover);color:var(--text-primary)}.truck-action-btn.delete:hover{background:rgba(255,107,107,.2);color:var(--danger)}
        .calendar-container{flex:1;display:flex;flex-direction:column;overflow:hidden}
        .calendar-header{padding:16px 24px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border);flex-wrap:wrap;gap:12px}
        .date-nav{display:flex;align-items:center;gap:12px}.date-nav-btn{width:36px;height:36px;border-radius:8px;background:var(--bg-card);border:1px solid var(--border);color:var(--text-primary);cursor:pointer}.date-nav-btn:hover{background:var(--bg-hover)}
        .current-date{font-size:18px;font-weight:600}.today-btn{padding:8px 16px;background:var(--accent);color:var(--navy);border:none;border-radius:6px;font-weight:600;cursor:pointer}
        .view-toggle{display:flex;background:var(--bg-card);border-radius:8px;padding:4px}.view-btn{padding:8px 14px;border:none;background:transparent;color:var(--text-secondary);border-radius:6px;cursor:pointer;font-weight:500}.view-btn.active{background:var(--primary);color:#fff}
        .legend{display:flex;gap:20px;padding:10px 24px;background:var(--bg-card);border-bottom:1px solid var(--border)}.legend-item{display:flex;align-items:center;gap:8px;font-size:12px;color:var(--text-secondary)}.legend-dot{width:10px;height:10px;border-radius:50%}.legend-dot.tc{background:var(--tc-color)}.legend-dot.yard{background:var(--yard-color)}.legend-dot.tgr{background:var(--tgr-color)}
        .calendar-scroll{flex:1;overflow:auto}.calendar-grid{display:grid;grid-template-columns:70px repeat(var(--truck-count,1),minmax(160px,1fr))}
        .time-column{background:var(--bg-card);border-right:1px solid var(--border);position:sticky;left:0;z-index:10}.time-header{height:44px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:11px;color:var(--text-muted)}
        .time-slot{height:60px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:12px;color:var(--text-secondary)}
        .truck-column{border-right:1px solid var(--border)}.truck-header-cell{height:44px;background:var(--bg-card);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:center;font-weight:600;font-size:13px;position:sticky;top:0;z-index:5}.truck-header-cell .cap{font-size:10px;color:var(--text-muted);margin-left:6px}
        .schedule-cell{height:60px;border-bottom:1px solid var(--border);padding:3px}.schedule-cell:hover{background:rgba(198,93,42,.05)}
        .delivery-card{background:var(--bg-hover);border-radius:6px;padding:6px 8px;height:100%;cursor:pointer;border-left:3px solid var(--tc-color);overflow:hidden}.delivery-card.tc{border-left-color:var(--tc-color)}.delivery-card.yard{border-left-color:var(--yard-color)}.delivery-card.tgr{border-left-color:var(--tgr-color)}
        .delivery-card:hover{background:var(--bg-card)}.delivery-customer{font-weight:600;font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.delivery-details{font-size:10px;color:var(--text-secondary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.delivery-tons{font-size:10px;font-weight:600;color:var(--accent)}
        .empty-slot{height:100%;border:2px dashed var(--border);border-radius:6px;display:flex;align-items:center;justify-content:center;color:var(--text-muted);font-size:18px;cursor:pointer;opacity:0}.schedule-cell:hover .empty-slot{opacity:1}
        .month-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:1px;background:var(--border);margin:16px;border-radius:12px;overflow:hidden}
        .month-header-cell{background:var(--bg-card);padding:10px;text-align:center;font-weight:600;font-size:12px;color:var(--text-secondary)}
        .month-day{background:var(--bg-dark);min-height:80px;padding:8px;cursor:pointer}.month-day:hover{background:var(--bg-card)}.month-day.other-month{opacity:.3}.month-day.today{background:rgba(198,93,42,.15)}
        .month-day-number{font-weight:600;font-size:13px;margin-bottom:4px}.month-day.today .month-day-number{background:var(--primary);color:#fff;width:24px;height:24px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center}
        .month-delivery-count{font-size:10px;padding:2px 5px;border-radius:3px;margin-top:2px;display:inline-block}.month-delivery-count.tc{background:rgba(107,184,209,.2);color:var(--tc-color)}.month-delivery-count.yard{background:rgba(255,200,87,.2);color:var(--yard-color)}.month-delivery-count.tgr{background:rgba(76,175,80,.2);color:var(--tgr-color)}
        .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;z-index:1000}.modal-overlay.active{display:flex}
        .modal{background:var(--bg-card);border-radius:16px;width:100%;max-width:440px;max-height:90vh;overflow-y:auto}
        .modal-header{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}.modal-header h3{font-size:17px}.modal-close{width:32px;height:32px;border-radius:8px;background:transparent;border:none;color:var(--text-secondary);cursor:pointer;font-size:20px}.modal-close:hover{background:var(--bg-hover)}
        .modal-body{padding:20px}.form-group{margin-bottom:16px}.form-label{display:block;font-size:12px;font-weight:500;color:var(--text-secondary);margin-bottom:6px}
        .form-input,.form-select{width:100%;padding:10px 14px;background:var(--bg-dark);border:1px solid var(--border);border-radius:8px;color:var(--text-primary);font-size:14px;font-family:inherit}.form-input:focus,.form-select:focus{outline:none;border-color:var(--primary)}
        .form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
        .source-options{display:flex;gap:8px}.source-option{flex:1;padding:10px;border-radius:8px;border:2px solid var(--border);background:transparent;cursor:pointer;text-align:center}.source-option:hover{border-color:var(--text-muted)}.source-option.selected{border-color:var(--primary);background:rgba(198,93,42,.1)}.source-option.tc.selected{border-color:var(--tc-color);background:rgba(107,184,209,.1)}.source-option.yard.selected{border-color:var(--yard-color);background:rgba(255,200,87,.1)}.source-option.tgr.selected{border-color:var(--tgr-color);background:rgba(76,175,80,.1)}
        .source-label{font-size:11px;font-weight:600;display:block;margin-top:4px;color:var(--text-primary)}.source-dot{width:14px;height:14px;border-radius:50%;margin:0 auto}
        .modal-footer{padding:14px 20px;border-top:1px solid var(--border);display:flex;gap:10px;justify-content:flex-end}.btn-danger{background:var(--danger);color:#fff}
        .toast{position:fixed;bottom:24px;right:24px;padding:14px 20px;background:var(--bg-card);border-radius:10px;border-left:4px solid var(--success);box-shadow:0 8px 32px rgba(0,0,0,.3);transform:translateY(100px);opacity:0;transition:all .3s;z-index:2000}.toast.show{transform:translateY(0);opacity:1}.toast.error{border-left-color:var(--danger)}
    </style>
</head>
<body>
    <header class="header">
        <div class="logo-section"><div class="logo"><img src="logo.jpg" alt="RockRunner"></div><div class="brand"><h1>RockRunner Logistics</h1><span>Dispatch Management</span></div></div>
        <div class="header-actions"><button class="btn btn-secondary" onclick="window.open('/tv.html','_blank')">üì∫ TV Mode</button><button class="btn btn-primary" onclick="openDeliveryModal()">+ Add Delivery</button></div>
    </header>
    <div class="main-layout">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header"><button class="collapse-btn" onclick="toggleSidebar()">‚ò∞</button><h2>üöõ Truck Roster</h2><button class="add-truck-btn" onclick="openTruckModal()">+</button></div>
            <div class="sidebar-content"><div class="truck-list" id="truckList"></div></div>
        </aside>
        <div class="calendar-container">
            <div class="calendar-header">
                <div class="date-nav"><button class="date-nav-btn" onclick="prevPeriod()">‚Üê</button><span class="current-date" id="currentDate">Loading...</span><button class="date-nav-btn" onclick="nextPeriod()">‚Üí</button><button class="today-btn" onclick="goToday()">Today</button></div>
                <div class="view-toggle"><button class="view-btn active" id="viewDay" onclick="setView('day')">Day</button><button class="view-btn" id="viewWeek" onclick="setView('week')">Week</button><button class="view-btn" id="viewMonth" onclick="setView('month')">Month</button></div>
            </div>
            <div class="legend"><div class="legend-item"><div class="legend-dot tc"></div>T&C Materials</div><div class="legend-item"><div class="legend-dot yard"></div>Yard Sale</div><div class="legend-item"><div class="legend-dot tgr"></div>Texas Got Rocks</div></div>
            <div class="calendar-scroll" id="calendarScroll"></div>
        </div>
    </div>
    <div class="modal-overlay" id="deliveryModal">
        <div class="modal">
            <div class="modal-header"><h3 id="deliveryModalTitle">Add Delivery</h3><button class="modal-close" onclick="closeDeliveryModal()">√ó</button></div>
            <div class="modal-body">
                <input type="hidden" id="deliveryId">
                <div class="form-row"><div class="form-group"><label class="form-label">Date</label><input type="date" class="form-input" id="deliveryDate"></div><div class="form-group"><label class="form-label">Time</label><select class="form-select" id="deliveryHour"><option value="6">6 AM</option><option value="7">7 AM</option><option value="8">8 AM</option><option value="9">9 AM</option><option value="10">10 AM</option><option value="11">11 AM</option><option value="12">12 PM</option><option value="13">1 PM</option><option value="14">2 PM</option><option value="15">3 PM</option><option value="16">4 PM</option><option value="17">5 PM</option></select></div></div>
                <div class="form-group"><label class="form-label">Truck</label><select class="form-select" id="deliveryTruck"></select></div>
                <div class="form-group"><label class="form-label">Source</label><div class="source-options"><button type="button" class="source-option tc selected" onclick="selectSource('T&C Materials')"><div class="source-dot" style="background:var(--tc-color)"></div><span class="source-label">T&C Materials</span></button><button type="button" class="source-option yard" onclick="selectSource('Yard Sale')"><div class="source-dot" style="background:var(--yard-color)"></div><span class="source-label">Yard Sale</span></button><button type="button" class="source-option tgr" onclick="selectSource('Texas Got Rocks')"><div class="source-dot" style="background:var(--tgr-color)"></div><span class="source-label">Texas Got Rocks</span></button></div><input type="hidden" id="deliverySource" value="T&C Materials"></div>
                <div class="form-group"><label class="form-label">Customer</label><input type="text" class="form-input" id="deliveryCustomer" placeholder="Customer name"></div>
                <div class="form-row"><div class="form-group"><label class="form-label">Address</label><input type="text" class="form-input" id="deliveryAddress" placeholder="Street"></div><div class="form-group"><label class="form-label">City</label><input type="text" class="form-input" id="deliveryCity" placeholder="City"></div></div>
                <div class="form-row"><div class="form-group"><label class="form-label">Material</label><input type="text" class="form-input" id="deliveryMaterial" placeholder="Material type"></div><div class="form-group"><label class="form-label">Tons</label><input type="number" class="form-input" id="deliveryTons" placeholder="0" step="0.5"></div></div>
                <div class="form-group"><label class="form-label">Notes</label><input type="text" class="form-input" id="deliveryNotes" placeholder="Special instructions"></div>
            </div>
            <div class="modal-footer"><button class="btn btn-danger" id="deleteDeliveryBtn" style="display:none" onclick="deleteDelivery()">Delete</button><button class="btn btn-secondary" onclick="closeDeliveryModal()">Cancel</button><button class="btn btn-primary" onclick="saveDelivery()">Save</button></div>
        </div>
    </div>
    <div class="modal-overlay" id="truckModal">
        <div class="modal">
            <div class="modal-header"><h3 id="truckModalTitle">Add Truck</h3><button class="modal-close" onclick="closeTruckModal()">√ó</button></div>
            <div class="modal-body">
                <input type="hidden" id="truckId">
                <div class="form-group"><label class="form-label">Truck Number/Name</label><input type="text" class="form-input" id="truckNumber" placeholder="e.g. TC-001"></div>
                <div class="form-row"><div class="form-group"><label class="form-label">Capacity (tons)</label><input type="number" class="form-input" id="truckCapacity" placeholder="24"></div><div class="form-group"><label class="form-label">Type</label><select class="form-select" id="truckType"><option value="semi">Semi</option><option value="tandem">Tandem</option><option value="broker">Broker</option></select></div></div>
                <div class="form-group"><label class="form-label">Notes</label><input type="text" class="form-input" id="truckNotes" placeholder="Optional"></div>
            </div>
            <div class="modal-footer"><button class="btn btn-danger" id="deleteTruckBtn" style="display:none" onclick="deleteTruck()">Delete</button><button class="btn btn-secondary" onclick="closeTruckModal()">Cancel</button><button class="btn btn-primary" onclick="saveTruck()">Save</button></div>
        </div>
    </div>
    <div class="toast" id="toast">Saved!</div>
<script>
let trucks=[],deliveries=[],currentDate=new Date(),currentView='day';
const API='/.netlify/functions';
document.addEventListener('DOMContentLoaded',()=>{loadTrucks();updateDisplay();if(localStorage.getItem('sbCol')==='1')document.getElementById('sidebar').classList.add('collapsed')});
function toggleSidebar(){const s=document.getElementById('sidebar');s.classList.toggle('collapsed');localStorage.setItem('sbCol',s.classList.contains('collapsed')?'1':'0')}
function toDS(d){return d.toISOString().split('T')[0]}
function updateDisplay(){document.getElementById('currentDate').textContent=currentView==='month'?currentDate.toLocaleDateString('en-US',{month:'long',year:'numeric'}):currentDate.toLocaleDateString('en-US',{weekday:'long',month:'short',day:'numeric',year:'numeric'});loadDeliveries()}
function prevPeriod(){if(currentView==='month')currentDate.setMonth(currentDate.getMonth()-1);else if(currentView==='week')currentDate.setDate(currentDate.getDate()-7);else currentDate.setDate(currentDate.getDate()-1);updateDisplay()}
function nextPeriod(){if(currentView==='month')currentDate.setMonth(currentDate.getMonth()+1);else if(currentView==='week')currentDate.setDate(currentDate.getDate()+7);else currentDate.setDate(currentDate.getDate()+1);updateDisplay()}
function goToday(){currentDate=new Date();updateDisplay()}
function setView(v){currentView=v;document.querySelectorAll('.view-btn').forEach(b=>b.classList.remove('active'));document.getElementById('view'+v.charAt(0).toUpperCase()+v.slice(1)).classList.add('active');updateDisplay()}
async function loadTrucks(){try{const r=await fetch(API+'/trucks');const d=await r.json();trucks=d.success?d.trucks||[]:[]}catch(e){trucks=[];console.error(e)}renderTrucks();renderCal();popTruckSel()}
function renderTrucks(){const l=document.getElementById('truckList');if(!trucks.length){l.innerHTML='<div style="text-align:center;padding:30px;color:var(--text-muted)">No trucks yet<br><small>Click + to add</small></div>';return}const tp={semi:'Semi',tandem:'Tandem',broker:'Broker'};l.innerHTML=trucks.map(t=>'<div class="truck-item"><div class="truck-header"><span class="truck-number">'+t.truckNumber+'</span><span class="truck-capacity">'+t.capacity+'T</span></div><div class="truck-type">'+(tp[t.type]||t.type||'Semi')+'</div><div class="truck-actions"><button class="truck-action-btn" onclick="event.stopPropagation();editTruck(\''+t._id+'\')">Edit</button><button class="truck-action-btn delete" onclick="event.stopPropagation();delTruck(\''+t._id+'\')">Remove</button></div></div>').join('')}
function popTruckSel(){const s=document.getElementById('deliveryTruck');s.innerHTML=trucks.length?trucks.map(t=>'<option value="'+t._id+'" data-num="'+t.truckNumber+'">'+t.truckNumber+' ('+t.capacity+'T)</option>').join(''):'<option value="">Add truck first</option>'}
async function loadDeliveries(){try{let st,en;if(currentView==='month'){st=toDS(new Date(currentDate.getFullYear(),currentDate.getMonth(),1));en=toDS(new Date(currentDate.getFullYear(),currentDate.getMonth()+1,0))}else if(currentView==='week'){const s=new Date(currentDate);s.setDate(s.getDate()-s.getDay());const e=new Date(s);e.setDate(e.getDate()+6);st=toDS(s);en=toDS(e)}else{st=en=toDS(currentDate)}const r=await fetch(API+'/dispatch?startDate='+st+'&endDate='+en);const d=await r.json();deliveries=d.deliveries||[]}catch(e){deliveries=[];console.error(e)}renderCal()}
function renderCal(){if(currentView==='month')renderMonth();else renderDay()}
function renderDay(){const c=document.getElementById('calendarScroll');const hrs=[6,7,8,9,10,11,12,13,14,15,16,17];let h='<div class="calendar-grid" style="--truck-count:'+(trucks.length||1)+'"><div class="time-column"><div class="time-header">Time</div>';hrs.forEach(hr=>{h+='<div class="time-slot">'+(hr>12?hr-12:hr)+' '+(hr>=12?'PM':'AM')+'</div>'});h+='</div>';if(!trucks.length){h+='<div class="truck-column"><div class="truck-header-cell">Add trucks ‚Üí</div>';hrs.forEach(()=>h+='<div class="schedule-cell"></div>');h+='</div>'}else{const ds=toDS(currentDate);trucks.forEach(t=>{h+='<div class="truck-column"><div class="truck-header-cell">'+t.truckNumber+'<span class="cap">'+t.capacity+'T</span></div>';hrs.forEach(hr=>{const del=deliveries.find(d=>d.truckId===t._id&&d.date===ds&&d.hour===hr&&d.status!=='cancelled');h+='<div class="schedule-cell" onclick="cellClick(\''+t._id+'\','+hr+',\''+ds+'\')">';if(del){const sc=del.source==='T&C Materials'?'tc':del.source==='Yard Sale'?'yard':'tgr';h+='<div class="delivery-card '+sc+'" onclick="event.stopPropagation();editDel(\''+del._id+'\')"><div class="delivery-customer">'+(del.customer||'Delivery')+'</div><div class="delivery-details">'+(del.material||'')+' ‚Üí '+(del.city||'')+'</div><div class="delivery-tons">'+(del.tons||0)+' tons</div></div>'}else{h+='<div class="empty-slot">+</div>'}h+='</div>'});h+='</div>'})}h+='</div>';c.innerHTML=h}
function renderMonth(){const c=document.getElementById('calendarScroll');const y=currentDate.getFullYear(),m=currentDate.getMonth();const fd=new Date(y,m,1),ld=new Date(y,m+1,0);const sd=fd.getDay(),dm=ld.getDate();const tds=toDS(new Date());let h='<div class="month-grid">';['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].forEach(d=>h+='<div class="month-header-cell">'+d+'</div>');const pm=new Date(y,m,0).getDate();for(let i=sd-1;i>=0;i--)h+='<div class="month-day other-month"><div class="month-day-number">'+(pm-i)+'</div></div>';for(let d=1;d<=dm;d++){const ds=y+'-'+String(m+1).padStart(2,'0')+'-'+String(d).padStart(2,'0');const it=ds===tds;const dd=deliveries.filter(x=>x.date===ds&&x.status!=='cancelled');const tc=dd.filter(x=>x.source==='T&C Materials').length,yd=dd.filter(x=>x.source==='Yard Sale').length,tg=dd.filter(x=>x.source==='Texas Got Rocks').length;h+='<div class="month-day'+(it?' today':'')+'" onclick="goToDate(\''+ds+'\')"><div class="month-day-number">'+d+'</div>';if(tc)h+='<div class="month-delivery-count tc">'+tc+' T&C</div>';if(yd)h+='<div class="month-delivery-count yard">'+yd+' Yard</div>';if(tg)h+='<div class="month-delivery-count tgr">'+tg+' TGR</div>';h+='</div>'}const rem=(sd+dm)%7;if(rem)for(let i=1;i<=7-rem;i++)h+='<div class="month-day other-month"><div class="month-day-number">'+i+'</div></div>';h+='</div>';c.innerHTML=h}
function goToDate(ds){currentDate=new Date(ds+'T12:00:00');setView('day')}
function cellClick(tid,hr,ds){if(!trucks.length){showToast('Add a truck first',1);return}openDeliveryModal(tid,hr,ds)}
function openDeliveryModal(tid,hr,ds){document.getElementById('deliveryModalTitle').textContent='Add Delivery';document.getElementById('deliveryId').value='';document.getElementById('deliveryDate').value=ds||toDS(currentDate);document.getElementById('deliveryHour').value=hr||8;document.getElementById('deliveryTruck').value=tid||(trucks[0]?._id||'');document.getElementById('deliveryCustomer').value='';document.getElementById('deliveryAddress').value='';document.getElementById('deliveryCity').value='';document.getElementById('deliveryMaterial').value='';document.getElementById('deliveryTons').value='';document.getElementById('deliveryNotes').value='';document.getElementById('deliverySource').value='T&C Materials';selectSource('T&C Materials');document.getElementById('deleteDeliveryBtn').style.display='none';document.getElementById('deliveryModal').classList.add('active')}
function editDel(id){const d=deliveries.find(x=>x._id===id);if(!d)return;document.getElementById('deliveryModalTitle').textContent='Edit Delivery';document.getElementById('deliveryId').value=id;document.getElementById('deliveryDate').value=d.date;document.getElementById('deliveryHour').value=d.hour;document.getElementById('deliveryTruck').value=d.truckId;document.getElementById('deliveryCustomer').value=d.customer||'';document.getElementById('deliveryAddress').value=d.address||'';document.getElementById('deliveryCity').value=d.city||'';document.getElementById('deliveryMaterial').value=d.material||'';document.getElementById('deliveryTons').value=d.tons||'';document.getElementById('deliveryNotes').value=d.notes||'';selectSource(d.source);document.getElementById('deleteDeliveryBtn').style.display='block';document.getElementById('deliveryModal').classList.add('active')}
function closeDeliveryModal(){document.getElementById('deliveryModal').classList.remove('active')}
function selectSource(s){document.getElementById('deliverySource').value=s;document.querySelectorAll('.source-option').forEach(b=>{b.classList.remove('selected');if((s==='T&C Materials'&&b.classList.contains('tc'))||(s==='Yard Sale'&&b.classList.contains('yard'))||(s==='Texas Got Rocks'&&b.classList.contains('tgr')))b.classList.add('selected')})}
async function saveDelivery(){const id=document.getElementById('deliveryId').value;const ts=document.getElementById('deliveryTruck');const data={date:document.getElementById('deliveryDate').value,hour:parseInt(document.getElementById('deliveryHour').value),truckId:ts.value,truckNumber:ts.options[ts.selectedIndex]?.dataset.num||'',customer:document.getElementById('deliveryCustomer').value,address:document.getElementById('deliveryAddress').value,city:document.getElementById('deliveryCity').value,material:document.getElementById('deliveryMaterial').value,tons:parseFloat(document.getElementById('deliveryTons').value)||0,source:document.getElementById('deliverySource').value,notes:document.getElementById('deliveryNotes').value};try{const r=await fetch(API+'/dispatch',{method:id?'PUT':'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(id?{id,...data}:data)});const res=await r.json();if(res.success){showToast(id?'Updated':'Added');closeDeliveryModal();loadDeliveries()}else showToast(res.error||'Failed',1)}catch(e){showToast('Error saving',1)}}
async function deleteDelivery(){const id=document.getElementById('deliveryId').value;if(!id||!confirm('Delete this delivery?'))return;try{const r=await fetch(API+'/dispatch',{method:'DELETE',headers:{'Content-Type':'application/json'},body:JSON.stringify({id})});const res=await r.json();if(res.success){showToast('Deleted');closeDeliveryModal();loadDeliveries()}else showToast(res.error||'Failed',1)}catch(e){showToast('Error',1)}}
function openTruckModal(){document.getElementById('truckModalTitle').textContent='Add Truck';document.getElementById('truckId').value='';document.getElementById('truckNumber').value='';document.getElementById('truckCapacity').value='';document.getElementById('truckType').value='semi';document.getElementById('truckNotes').value='';document.getElementById('deleteTruckBtn').style.display='none';document.getElementById('truckModal').classList.add('active')}
function editTruck(id){const t=trucks.find(x=>x._id===id);if(!t)return;document.getElementById('truckModalTitle').textContent='Edit Truck';document.getElementById('truckId').value=id;document.getElementById('truckNumber').value=t.truckNumber;document.getElementById('truckCapacity').value=t.capacity;document.getElementById('truckType').value=t.type||'semi';document.getElementById('truckNotes').value=t.notes||'';document.getElementById('deleteTruckBtn').style.display='block';document.getElementById('truckModal').classList.add('active')}
function closeTruckModal(){document.getElementById('truckModal').classList.remove('active')}
async function saveTruck(){const id=document.getElementById('truckId').value;const data={truckNumber:document.getElementById('truckNumber').value,capacity:parseFloat(document.getElementById('truckCapacity').value),type:document.getElementById('truckType').value,notes:document.getElementById('truckNotes').value};if(!data.truckNumber||!data.capacity){showToast('Name and capacity required',1);return}try{const r=await fetch(API+'/trucks',{method:id?'PUT':'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(id?{id,...data}:data)});const res=await r.json();if(res.success){showToast(id?'Updated':'Added');closeTruckModal();loadTrucks()}else showToast(res.error||'Failed',1)}catch(e){console.error(e);showToast('Error saving truck',1)}}
async function delTruck(id){if(!confirm('Remove this truck?'))return;try{const r=await fetch(API+'/trucks',{method:'DELETE',headers:{'Content-Type':'application/json'},body:JSON.stringify({id})});const res=await r.json();if(res.success){showToast('Removed');loadTrucks()}else showToast(res.error||'Failed',1)}catch(e){showToast('Error',1)}}
async function deleteTruck(){const id=document.getElementById('truckId').value;if(id)delTruck(id);closeTruckModal()}
function showToast(m,e){const t=document.getElementById('toast');t.textContent=m;t.classList.toggle('error',!!e);t.classList.add('show');setTimeout(()=>t.classList.remove('show'),3000)}
</script>
</body>
</html>
