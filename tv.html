<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RockRunner TV</title>
<style>
:root {
  --bg: #ffffff;
  --bg-alt: #f8f9fb;
  --border: #dde3ec;
  --text: #0a1628;
  --text-muted: #4a5568;
  --blue: #2563eb;
  --green: #16a34a;
  --yellow: #d97706;
  --red: #dc2626;
  --orange: #e67e22;
  --navy: #0a1628;
  --gray: #94a3b8;
}
* { margin:0; padding:0; box-sizing:border-box; }
body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: var(--bg);
  color: var(--text);
  overflow: hidden;
  height: 100vh;
}

/* ─── SCREENS ────────────────────── */
.screen {
  position: absolute;
  inset: 0;
  display: flex;
  flex-direction: column;
  opacity: 0;
  transition: opacity 1s ease;
  pointer-events: none;
}
.screen.active { opacity: 1; pointer-events: auto; }

/* ─── TOP BAR ────────────────────── */
.topbar {
  background: linear-gradient(135deg, var(--navy) 0%, #0f2040 100%);
  color: #fff;
  padding: 16px 36px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-shrink: 0;
  border-bottom: 4px solid var(--orange);
}
.topbar-left { display: flex; align-items: center; gap: 20px; }
.topbar-logo {
  width: 56px;
  height: 56px;
  border-radius: 10px;
  object-fit: cover;
  flex-shrink: 0;
}
.topbar-brand {
  font-size: 32px;
  font-weight: 800;
  letter-spacing: -0.5px;
  color: var(--orange);
}
.topbar-title {
  font-size: 20px;
  font-weight: 600;
  color: rgba(255,255,255,0.75);
  margin-top: 2px;
}
.topbar-clock {
  font-size: 32px;
  font-weight: 700;
  font-variant-numeric: tabular-nums;
}
.topbar-date {
  font-size: 18px;
  opacity: 0.85;
  text-align: right;
}

/* ─── STATS ROW ──────────────────── */
.stats-row {
  display: flex;
  gap: 0;
  border-bottom: 2px solid var(--border);
  flex-shrink: 0;
}
.stat-box {
  flex: 1;
  text-align: center;
  padding: 16px 10px;
  border-right: 1px solid var(--border);
}
.stat-box:last-child { border-right: none; }
.stat-num { font-size: 48px; font-weight: 800; line-height: 1; }
.stat-label { font-size: 16px; font-weight: 600; color: var(--text-muted); margin-top: 4px; text-transform: uppercase; letter-spacing: 0.5px; }

/* ─── TRUCK ROWS ─────────────────── */
.truck-list { flex: 1; overflow: hidden; padding: 12px 24px; display: flex; flex-direction: column; gap: 8px; }
.truck-row {
  display: flex;
  align-items: center;
  gap: 20px;
  background: var(--bg-alt);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 14px 20px;
  flex: 1;
  min-height: 0;
}
.truck-label {
  min-width: 260px;
  flex-shrink: 0;
}
.truck-label-number {
  font-size: 28px;
  font-weight: 800;
  color: var(--orange);
}
.truck-label-driver {
  font-size: 20px;
  font-weight: 600;
  color: var(--text-muted);
}
.truck-timeline {
  flex: 1;
  display: flex;
  gap: 6px;
  align-items: center;
  overflow: hidden;
}
.stop-block {
  flex: 1;
  padding: 8px 12px;
  border-radius: 8px;
  font-size: 16px;
  font-weight: 600;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  min-width: 0;
  text-align: center;
  line-height: 1.3;
}
.stop-name { font-size: 20px; font-weight: 800; display: block; }
.stop-qty  { font-size: 13px; font-weight: 600; opacity: 0.85; }
.stop-block.scheduled { background: #f1f5f9; color: #475569; border: 1px solid #cbd5e1; }
.stop-block.en-route  { background: #22c55e; color: #fff; border: 1px solid #16a34a; }
.stop-block.delivered  { background: #3b82f6; color: #fff; border: 1px solid #2563eb; }
.stop-block.cancelled  { background: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; }
.truck-empty { color: var(--gray); font-size: 16px; font-style: italic; }

/* ─── WEEK AHEAD ─────────────────── */
.week-grid {
  flex: 1;
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 16px;
  padding: 24px 32px;
  align-items: stretch;
}
.week-col {
  border-radius: 16px;
  padding: 24px 16px;
  text-align: center;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 12px;
  border: 2px solid var(--border);
  background: var(--bg-alt);
}
.week-col.today { border-color: var(--blue); border-width: 3px; background: #eff6ff; }
.week-col.status-available { border-color: var(--green); }
.week-col.status-limited   { border-color: var(--yellow); }
.week-col.status-full       { border-color: var(--red); }
.week-col.status-closed     { border-color: var(--gray); background: #f8f8f8; opacity: 0.6; }
.week-day { font-size: 28px; font-weight: 800; }
.week-date { font-size: 18px; color: var(--text-muted); font-weight: 600; }
.week-stat { font-size: 20px; font-weight: 600; line-height: 1.5; }
.week-stat strong { font-size: 36px; display: block; font-weight: 800; }
.week-badge {
  font-size: 18px;
  font-weight: 800;
  padding: 6px 16px;
  border-radius: 8px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.badge-available { background: #dcfce7; color: var(--green); }
.badge-limited   { background: #fef3c7; color: var(--yellow); }
.badge-full       { background: #fee2e2; color: var(--red); }
.badge-closed     { background: #f1f5f9; color: var(--gray); }

/* ─── LEGEND ────────────────────── */
.legend {
  display: flex;
  justify-content: flex-end;
  align-items: center;
  gap: 24px;
  padding: 10px 28px;
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
}
.legend-item {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 18px;
  font-weight: 700;
  color: var(--text-muted);
}
.legend-swatch {
  width: 20px;
  height: 20px;
  border-radius: 5px;
  flex-shrink: 0;
}

/* ─── WATERMARK ──────────────────── */
.watermark {
  position: fixed;
  bottom: 10px;
  right: 16px;
  display: flex;
  align-items: center;
  gap: 6px;
  opacity: 0.35;
}
.watermark img {
  width: 22px;
  height: 22px;
  border-radius: 4px;
  object-fit: cover;
}
.watermark span {
  font-size: 12px;
  font-weight: 700;
  color: var(--navy);
  letter-spacing: 0.3px;
}
</style>
</head>
<body>

<!-- ═══ SCREEN 1: TODAY'S SCOREBOARD ═══════════════ -->
<div class="screen active" id="screen1">
  <div class="topbar">
    <div class="topbar-left">
      <img src="driver-logo.jpg" alt="RockRunner" class="topbar-logo">
      <div>
        <div class="topbar-brand">RockRunner Logistics</div>
        <div class="topbar-title">Dispatch Board</div>
      </div>
    </div>
    <div style="text-align:right;">
      <div class="topbar-clock" id="clock1">--:-- --</div>
      <div class="topbar-date" id="date1">—</div>
    </div>
  </div>
  <div class="stats-row" id="statsRow">
    <div class="stat-box"><div class="stat-num" id="statTrucks" style="color:var(--orange);">0</div><div class="stat-label">Trucks Active</div></div>
    <div class="stat-box"><div class="stat-num" id="statScheduled" style="color:#eab308;">0</div><div class="stat-label">Scheduled</div></div>
    <div class="stat-box"><div class="stat-num" id="statCompleted" style="color:#3b82f6;">0</div><div class="stat-label">Completed</div></div>
    <div class="stat-box"><div class="stat-num" id="statTons" style="color:var(--text);">0</div><div class="stat-label">Total Tons</div></div>
  </div>
  <div class="legend">
    <div class="legend-item"><div class="legend-swatch" style="background:#eab308;"></div>Scheduled</div>
    <div class="legend-item"><div class="legend-swatch" style="background:#22c55e;"></div>En Route</div>
    <div class="legend-item"><div class="legend-swatch" style="background:#3b82f6;"></div>Delivered</div>
    <div class="legend-item"><div class="legend-swatch" style="background:#ef4444;"></div>Cancelled</div>
  </div>
  <div class="truck-list" id="truckList"></div>
</div>

<!-- ═══ SCREEN 2: WEEK AHEAD ══════════════════════ -->
<div class="screen" id="screen2">
  <div class="topbar">
    <div class="topbar-left">
      <img src="driver-logo.jpg" alt="RockRunner" class="topbar-logo">
      <div>
        <div class="topbar-brand">RockRunner Logistics</div>
        <div class="topbar-title">7-Day Look Ahead</div>
      </div>
    </div>
    <div style="text-align:right;">
      <div class="topbar-clock" id="clock2">--:-- --</div>
      <div class="topbar-date" id="date2">—</div>
    </div>
  </div>
  <div class="week-grid" id="weekGrid"></div>
</div>

<div class="watermark">
  <img src="driver-logo.jpg" alt="RockRunner">
  <span>RockRunner Logistics</span>
</div>

<script>
const API = '/.netlify/functions';
let trucks = [];
let deliveries = [];
let products = []; // full product objects for fmtQty lookup
let capacityDays = [];
let currentScreen = 1;

// ─── HELPERS ─────────────────────────────────────
function todayISO() {
  const d = new Date();
  return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
}

function futureISO(offset) {
  const d = new Date();
  d.setDate(d.getDate() + offset);
  return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
}

function esc(t) { const d = document.createElement('div'); d.textContent = t||''; return d.innerHTML; }

// Returns "X CYD / YT" when material weight is known, else "YT"
function fmtQty(d) {
  const tons = parseFloat(d.quantity);
  if (isNaN(tons)) return '?';
  const product = products.find(p =>
    (p.productId && p.productId === d.productId) ||
    (p._id && String(p._id) === String(d.productId)) ||
    p.name === d.materialName
  );
  const weight = product?.weight;
  if (!weight) return `${tons.toFixed(1)}T`;
  const cyd = tons / weight;
  return `${cyd.toFixed(1)} CYD / ${tons.toFixed(1)}T`;
}

function updateClocks() {
  const now = new Date();
  const time = now.toLocaleTimeString('en-US', { hour:'numeric', minute:'2-digit', second:'2-digit', hour12:true });
  const date = now.toLocaleDateString('en-US', { weekday:'long', year:'numeric', month:'long', day:'numeric' });
  document.getElementById('clock1').textContent = time;
  document.getElementById('clock2').textContent = time;
  document.getElementById('date1').textContent = date;
  document.getElementById('date2').textContent = date;
}

// ─── DATA LOADING ────────────────────────────────
async function loadScoreboard() {
  try {
    const today = todayISO();
    const [truckRes, delRes, prodRes] = await Promise.all([
      fetch(`${API}/trucks`).then(r => r.json()),
      fetch(`${API}/dispatch?date=${today}`).then(r => r.json()),
      fetch(`${API}/products`).then(r => r.json())
    ]);
    trucks = (truckRes.trucks || []).filter(t => t.active !== false);
    deliveries = (delRes.deliveries || []).filter(d => d.status !== 'CANCELLED' && d.status !== 'UNASSIGNED');
    products = prodRes.materials || prodRes.products || (Array.isArray(prodRes) ? prodRes : []);
    renderScoreboard();
  } catch(e) { console.error('Scoreboard load error:', e); }
}

async function loadWeekAhead() {
  try {
    const from = todayISO();
    const to = futureISO(6);
    const r = await fetch(`${API}/capacity?from=${from}&to=${to}`);
    const data = await r.json();
    capacityDays = data.days || [];
    renderWeekAhead();
  } catch(e) { console.error('Week ahead load error:', e); }
}

// ─── DOMINANT ROW COLOR ──────────────────────────
function dominantRowStyle(dels) {
  if (!dels.length) return { row: '', num: '', driver: '' };
  const hasEnRoute   = dels.some(d => d.status === 'EN_ROUTE');
  const hasScheduled = dels.some(d => d.status === 'SCHEDULED');
  const allDelivered = dels.every(d => d.status === 'DELIVERED');
  const allCancelled = dels.every(d => d.status === 'CANCELLED');

  let bg = '';
  if (hasEnRoute)        bg = '#22c55e';
  else if (allDelivered) bg = '#3b82f6';
  else if (hasScheduled) bg = '#eab308';
  else if (allCancelled) bg = '#ef4444';

  if (!bg) return { row: '', num: '', driver: '' };
  return {
    row:    `background:${bg};border-color:${bg};`,
    num:    'color:#fff;',
    driver: 'color:rgba(255,255,255,0.85);'
  };
}

// ─── RENDER SCOREBOARD ──────────────────────────
function renderScoreboard() {
  const scheduled = deliveries.filter(d => d.status === 'SCHEDULED').length;
  const enRoute = deliveries.filter(d => d.status === 'EN_ROUTE').length;
  const completed = deliveries.filter(d => d.status === 'DELIVERED').length;
  const totalTons = deliveries.reduce((s,d) => s + (parseFloat(d.quantity)||0), 0);
  const activeTruckIds = new Set(deliveries.map(d => d.truckId).filter(Boolean));

  document.getElementById('statTrucks').textContent = activeTruckIds.size;
  document.getElementById('statScheduled').textContent = scheduled + enRoute;
  document.getElementById('statCompleted').textContent = completed;
  const cydTotal = deliveries.reduce((s, d) => {
    const tons = parseFloat(d.quantity) || 0;
    const product = products.find(p =>
      (p.productId && p.productId === d.productId) ||
      (p._id && String(p._id) === String(d.productId)) ||
      p.name === d.materialName
    );
    return s + (product?.weight ? tons / product.weight : 0);
  }, 0);
  document.getElementById('statTons').textContent = totalTons.toFixed(1);
  document.getElementById('statTons').nextElementSibling.textContent =
    cydTotal > 0 ? `${cydTotal.toFixed(1)} CYD / Total Tons` : 'Total Tons';

  const list = document.getElementById('truckList');
  if (!trucks.length) {
    list.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-muted);font-size:24px;">No trucks configured</div>';
    return;
  }

  list.innerHTML = trucks.map(truck => {
    const tid = truck._id?.toString() || truck._id;
    const truckDels = deliveries.filter(d => d.truckId === tid)
      .sort((a,b) => (a.stopOrder||99) - (b.stopOrder||99));
    const driverName = truck.defaultDriver?.name || 'No driver';

    let stopsHtml;
    if (!truckDels.length) {
      stopsHtml = '<span class="truck-empty">No deliveries assigned</span>';
    } else {
      stopsHtml = truckDels.map(d => {
        const sc = (d.status||'').replace('_','-').toLowerCase();
        const cls = sc === 'en-route' ? 'en-route' : sc;
        return `<div class="stop-block ${cls}"><span class="stop-name">${esc(d.customerName||'?')}</span><span class="stop-qty">${esc(d.materialName||'')} &middot; ${fmtQty(d)}</span></div>`;
      }).join('');
    }

    const style = dominantRowStyle(truckDels);
    return `<div class="truck-row" style="${style.row}">
      <div class="truck-label">
        <div class="truck-label-number" style="${style.num}">\u{1F69B} ${esc(truck.truckNumber)}</div>
        <div class="truck-label-driver" style="${style.driver}">${esc(driverName)}</div>
      </div>
      <div class="truck-timeline">${stopsHtml}</div>
    </div>`;
  }).join('');
}

// ─── RENDER WEEK AHEAD ─────────────────────────
function renderWeekAhead() {
  const grid = document.getElementById('weekGrid');
  const today = todayISO();
  const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

  grid.innerHTML = capacityDays.map(day => {
    const d = new Date(day.date + 'T12:00:00');
    const dayShort = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][d.getDay()];
    const dateLabel = months[d.getMonth()] + ' ' + d.getDate();
    const isToday = day.date === today;
    const statusCls = 'status-' + day.status;
    const badgeCls = 'badge-' + day.status;
    const statusLabel = day.status === 'available' ? 'Available' :
                        day.status === 'limited' ? 'Limited' :
                        day.status === 'full' ? 'Full' : 'Closed';

    return `<div class="week-col ${statusCls} ${isToday ? 'today' : ''}">
      <div class="week-day">${dayShort}</div>
      <div class="week-date">${dateLabel}</div>
      ${day.status !== 'closed' ? `
        <div class="week-stat"><strong>${day.deliveryCount}</strong>deliveries</div>
        <div class="week-stat">${day.scheduledCyd > 0 ? `<strong>${day.scheduledCyd.toFixed(1)}</strong> CYD / ` : ''}<strong>${day.scheduledTons}</strong> tons</div>
        <div class="week-stat"><strong>${day.trucksUsed}</strong>trucks needed</div>
        <div class="week-stat"><strong>${day.availableSlots}</strong>slots open</div>
      ` : `
        <div style="flex:1;display:flex;align-items:center;justify-content:center;">
          <div style="font-size:48px;opacity:0.3;">&#128564;</div>
        </div>
      `}
      <div class="week-badge ${badgeCls}">${statusLabel}</div>
    </div>`;
  }).join('');
}

// ─── SCREEN ROTATION ────────────────────────────
function rotateScreen() {
  document.getElementById('screen' + currentScreen).classList.remove('active');
  currentScreen = currentScreen === 1 ? 2 : 1;
  document.getElementById('screen' + currentScreen).classList.add('active');
}

// ─── INIT ───────────────────────────────────────
updateClocks();
setInterval(updateClocks, 1000);

loadScoreboard();
loadWeekAhead();

// Refresh data every 60 seconds
setInterval(() => { loadScoreboard(); loadWeekAhead(); }, 60000);

// Rotate screens every 15 seconds
setInterval(rotateScreen, 15000);
</script>
</body>
</html>
