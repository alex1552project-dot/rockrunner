<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RockRunner - Dispatch Board</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root{--primary:#C65D2A;--accent:#6BB8D1;--navy:#1E3A5F;--bg-dark:#0A1218;--bg-card:#141E28;--bg-hover:#1C2832;--text-primary:#FFF;--text-secondary:#8AA4B8;--border:rgba(255,255,255,0.08);--tc-color:#6BB8D1;--yard-color:#FFC857;--tgr-color:#4CAF50}
        *{box-sizing:border-box;margin:0;padding:0}body{font-family:'DM Sans',sans-serif;background:var(--bg-dark);color:var(--text-primary);height:100vh;overflow:hidden;display:flex;flex-direction:column}
        .header{background:linear-gradient(135deg,var(--primary),#A04D20);padding:12px 24px;display:flex;justify-content:space-between;align-items:center;flex-shrink:0}
        .logo-section{display:flex;align-items:center;gap:12px}.logo{width:45px;height:45px;border-radius:10px;overflow:hidden;background:#fff}.logo img{width:100%;height:100%;object-fit:cover}
        .brand h1{font-size:22px;font-weight:800}.brand span{font-size:12px;opacity:.9}
        .header-right{text-align:right}.current-date{font-size:18px;font-weight:600}.current-time{font-size:32px;font-weight:800;font-family:monospace}
        .legend{display:flex;gap:24px;padding:8px 24px;background:var(--bg-card);border-bottom:1px solid var(--border);justify-content:center;flex-shrink:0}
        .legend-item{display:flex;align-items:center;gap:8px;font-size:12px;font-weight:500}.legend-dot{width:12px;height:12px;border-radius:50%}.legend-dot.tc{background:var(--tc-color)}.legend-dot.yard{background:var(--yard-color)}.legend-dot.tgr{background:var(--tgr-color)}
        .main-content{flex:1;display:flex;flex-direction:column;overflow:hidden}
        .day-section{flex:3;display:flex;flex-direction:column;border-bottom:3px solid var(--primary);overflow:hidden}
        .section-header{background:var(--navy);padding:8px 20px;font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--accent);flex-shrink:0;display:flex;justify-content:space-between}
        .day-grid{flex:1;display:grid;grid-template-columns:70px repeat(var(--truck-count,1),1fr);overflow:auto}
        .time-column{background:var(--bg-card);border-right:1px solid var(--border)}.time-header{height:36px;display:flex;align-items:center;justify-content:center;font-size:10px;color:var(--text-secondary);font-weight:600;border-bottom:1px solid var(--border)}
        .time-slot{height:28px;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:600;color:var(--text-secondary);border-bottom:1px solid var(--border)}.time-slot.half{border-bottom:1px dashed var(--border);font-size:9px;color:var(--text-secondary);opacity:.7}
        .time-slot.current{background:rgba(198,93,42,.2);color:var(--primary)}
        .truck-column{border-right:1px solid var(--border)}.truck-header{height:36px;background:var(--navy);display:flex;flex-direction:column;align-items:center;justify-content:center;font-weight:700;font-size:13px;border-bottom:1px solid var(--border)}.truck-header .cap{font-size:10px;color:var(--accent);font-weight:500}
        .schedule-cell{height:28px;border-bottom:1px solid var(--border);padding:1px}.schedule-cell.half{border-bottom:1px dashed var(--border)}.schedule-cell.current{background:rgba(198,93,42,.1)}
        .schedule-cell.blocked{background:rgba(255,107,107,.08)}
        .delivery-card{height:100%;background:var(--bg-hover);border-radius:4px;padding:2px 6px;border-left:3px solid var(--tc-color);position:relative;overflow:hidden;display:flex;align-items:center;gap:8px}
        .delivery-card.tc{border-left-color:var(--tc-color)}.delivery-card.yard{border-left-color:var(--yard-color)}.delivery-card.tgr{border-left-color:var(--tgr-color)}
        .delivery-customer{font-weight:700;font-size:11px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1}
        .delivery-info{font-size:9px;color:var(--text-secondary);white-space:nowrap}
        .delivery-source{font-size:8px;padding:2px 4px;border-radius:3px;font-weight:700}
        .delivery-card.tc .delivery-source{background:rgba(107,184,209,.2);color:var(--tc-color)}
        .delivery-card.yard .delivery-source{background:rgba(255,200,87,.2);color:var(--yard-color)}
        .delivery-card.tgr .delivery-source{background:rgba(76,175,80,.2);color:var(--tgr-color)}
        .empty-slot{height:100%;border:1px dashed rgba(255,255,255,.05);border-radius:3px}
        .week-section{flex:2;display:flex;flex-direction:column;overflow:hidden}
        .week-grid{flex:1;display:flex;overflow:hidden}
        .week-day{flex:1;border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden}.week-day:last-child{border-right:none}
        .week-day-header{padding:8px;text-align:center;background:var(--bg-card);border-bottom:1px solid var(--border);flex-shrink:0}
        .week-day-header.today{background:rgba(198,93,42,.2)}
        .week-day-name{font-size:10px;font-weight:700;color:var(--text-secondary)}.week-day-date{font-size:16px;font-weight:700;margin-top:2px}
        .week-day-header.today .week-day-date{color:var(--primary)}
        .week-day-content{flex:1;overflow-y:auto;padding:4px}
        .week-delivery{margin-bottom:4px;padding:6px;border-radius:4px;font-size:10px;border-left:3px solid var(--tc-color);background:var(--bg-hover)}
        .week-delivery.tc{border-left-color:var(--tc-color)}.week-delivery.yard{border-left-color:var(--yard-color)}.week-delivery.tgr{border-left-color:var(--tgr-color)}
        .week-delivery-time{font-weight:700;color:var(--accent)}.week-delivery-customer{font-weight:600;margin-top:1px}.week-delivery-info{color:var(--text-secondary);font-size:9px;margin-top:1px}
        .week-no-deliveries{text-align:center;padding:15px;color:var(--text-secondary);font-size:10px}
        .status-bar{background:var(--bg-card);padding:8px 24px;display:flex;justify-content:space-between;align-items:center;border-top:1px solid var(--border);flex-shrink:0}
        .stats{display:flex;gap:32px}.stat{text-align:center}.stat-value{font-size:24px;font-weight:800;color:var(--accent)}.stat-label{font-size:10px;color:var(--text-secondary);text-transform:uppercase}
        .refresh-info{font-size:11px;color:var(--text-secondary)}
    </style>
</head>
<body>
    <header class="header">
        <div class="logo-section"><div class="logo"><img src="logo.jpg" alt="RockRunner"></div><div class="brand"><h1>RockRunner Logistics</h1><span>Dispatch Board</span></div></div>
        <div class="header-right"><div class="current-date" id="currentDate">Loading...</div><div class="current-time" id="currentTime">--:--</div></div>
    </header>
    <div class="legend"><div class="legend-item"><div class="legend-dot tc"></div>T&C Materials</div><div class="legend-item"><div class="legend-dot yard"></div>Yard Sale</div><div class="legend-item"><div class="legend-dot tgr"></div>Texas Got Rocks</div></div>
    <div class="main-content">
        <div class="day-section">
            <div class="section-header"><span>ðŸ“… TODAY'S SCHEDULE</span><span id="todayDate"></span></div>
            <div class="day-grid" id="dayGrid"></div>
        </div>
        <div class="week-section">
            <div class="section-header"><span>ðŸ“† THIS WEEK</span></div>
            <div class="week-grid" id="weekGrid"></div>
        </div>
    </div>
    <div class="status-bar">
        <div class="stats"><div class="stat"><div class="stat-value" id="totalDeliveries">0</div><div class="stat-label">Today's Deliveries</div></div><div class="stat"><div class="stat-value" id="totalTons">0</div><div class="stat-label">Total Tons</div></div><div class="stat"><div class="stat-value" id="activeTrucks">0</div><div class="stat-label">Active Trucks</div></div></div>
        <div class="refresh-info">Auto-refresh: 30s | <span id="lastUpdate">--</span></div>
    </div>
<script>
let trucks=[],deliveries=[];
const API='/.netlify/functions';

// Time slots: 5:00 AM to 6:00 PM in 30-min intervals
const TIME_SLOTS=[];
for(let h=5;h<=18;h++){
    TIME_SLOTS.push({value:h,label:formatTime(h,0)});
    if(h<18)TIME_SLOTS.push({value:h+0.5,label:formatTime(h,30)});
}

function formatTime(h,m){
    const hr=h>12?h-12:(h===0?12:h);
    const ampm=h>=12?'PM':'AM';
    return hr+':'+(m===0?'00':'30')+' '+ampm;
}

function formatTimeVal(v){
    const h=Math.floor(v);
    const m=(v%1)*60;
    return formatTime(h,m);
}

async function loadData(){
    try{
        const[tRes,dRes]=await Promise.all([fetch(API+'/trucks'),fetch(API+'/dispatch?startDate='+getWeekStart()+'&endDate='+getWeekEnd())]);
        const tData=await tRes.json();const dData=await dRes.json();
        trucks=tData.success?tData.trucks||[]:[];
        deliveries=dData.deliveries||[];
        renderDayView();renderWeekView();updateStats();
    }catch(e){console.error(e)}
}

function toDS(d){return d.toISOString().split('T')[0]}
function getWeekStart(){const d=new Date();d.setDate(d.getDate()-d.getDay());return toDS(d)}
function getWeekEnd(){const d=new Date();d.setDate(d.getDate()+(6-d.getDay()));return toDS(d)}

function getBlockedSlots(truckId,date){
    const slots=[];
    deliveries.filter(d=>d.truckId===truckId&&d.date===date&&d.status!=='cancelled').forEach(d=>{
        const start=d.time||d.hour;const end=d.returnTime||d.returnHour||(start+2);
        for(let t=start;t<end;t+=0.5)slots.push(t);
    });
    return slots;
}

function renderDayView(){
    const c=document.getElementById('dayGrid');
    const today=toDS(new Date());
    const now=new Date();
    const currentTimeVal=now.getHours()+(now.getMinutes()>=30?0.5:0);
    
    document.getElementById('todayDate').textContent=new Date().toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});
    
    let h='<div class="time-column"><div class="time-header">TIME</div>';
    TIME_SLOTS.forEach(t=>{
        const isCurrent=t.value===currentTimeVal;
        const isHalf=t.value%1!==0;
        h+='<div class="time-slot'+(isHalf?' half':'')+(isCurrent?' current':'')+'">'+t.label+'</div>';
    });
    h+='</div>';
    
    if(!trucks.length){
        h+='<div class="truck-column"><div class="truck-header">No Trucks</div>';
        TIME_SLOTS.forEach(()=>h+='<div class="schedule-cell"></div>');
        h+='</div>';
    }else{
        c.style.setProperty('--truck-count',trucks.length);
        trucks.forEach(tr=>{
            const blocked=getBlockedSlots(tr._id,today);
            h+='<div class="truck-column"><div class="truck-header">'+tr.truckNumber+'<span class="cap">'+tr.capacity+'T</span></div>';
            TIME_SLOTS.forEach(t=>{
                const isCurrent=t.value===currentTimeVal;
                const isHalf=t.value%1!==0;
                const del=deliveries.find(d=>d.truckId===tr._id&&d.date===today&&(d.time===t.value||(d.hour===t.value&&!d.time))&&d.status!=='cancelled');
                const isBlocked=!del&&blocked.includes(t.value);
                h+='<div class="schedule-cell'+(isHalf?' half':'')+(isCurrent?' current':'')+(isBlocked?' blocked':'')+'">';
                if(del){
                    const sc=del.source==='T&C Materials'?'tc':del.source==='Yard Sale'?'yard':'tgr';
                    const srcLabel=del.source==='T&C Materials'?'T&C':del.source==='Yard Sale'?'YARD':'TGR';
                    h+='<div class="delivery-card '+sc+'"><span class="delivery-source">'+srcLabel+'</span><span class="delivery-customer">'+(del.customer||'Delivery')+'</span><span class="delivery-info">'+(del.tons||0)+'T â†’ '+(del.city||'')+'</span></div>';
                }else{
                    h+='<div class="empty-slot"></div>';
                }
                h+='</div>';
            });
            h+='</div>';
        });
    }
    c.innerHTML=h;
}

function renderWeekView(){
    const c=document.getElementById('weekGrid');
    const startOfWeek=new Date();startOfWeek.setDate(startOfWeek.getDate()-startOfWeek.getDay());
    const today=toDS(new Date());
    
    let h='';
    for(let i=0;i<7;i++){
        const d=new Date(startOfWeek);d.setDate(d.getDate()+i);
        const ds=toDS(d);
        const isToday=ds===today;
        const dayDels=deliveries.filter(x=>x.date===ds&&x.status!=='cancelled').sort((a,b)=>(a.time||a.hour)-(b.time||b.hour));
        
        h+='<div class="week-day"><div class="week-day-header'+(isToday?' today':'')+'"><div class="week-day-name">'+d.toLocaleDateString('en-US',{weekday:'short'}).toUpperCase()+'</div><div class="week-day-date">'+d.getDate()+'</div></div><div class="week-day-content">';
        
        if(dayDels.length){
            dayDels.forEach(del=>{
                const sc=del.source==='T&C Materials'?'tc':del.source==='Yard Sale'?'yard':'tgr';
                const srcLabel=del.source==='T&C Materials'?'T&C':del.source==='Yard Sale'?'Yard':'TGR';
                const timeVal=del.time||del.hour;
                h+='<div class="week-delivery '+sc+'"><div class="week-delivery-time">'+formatTimeVal(timeVal)+'</div><div class="week-delivery-customer">'+(del.customer||'Delivery')+'</div><div class="week-delivery-info">'+srcLabel+' â€¢ '+(del.tons||0)+'T â€¢ '+(del.truckNumber||'')+'</div></div>';
            });
        }else{
            h+='<div class="week-no-deliveries">No deliveries</div>';
        }
        h+='</div></div>';
    }
    c.innerHTML=h;
}

function updateStats(){
    const today=toDS(new Date());
    const todayDels=deliveries.filter(d=>d.date===today&&d.status!=='cancelled');
    document.getElementById('totalDeliveries').textContent=todayDels.length;
    document.getElementById('totalTons').textContent=todayDels.reduce((s,d)=>s+(d.tons||0),0);
    document.getElementById('activeTrucks').textContent=trucks.length;
}

function updateClock(){
    const now=new Date();
    document.getElementById('currentDate').textContent=now.toLocaleDateString('en-US',{weekday:'long',month:'short',day:'numeric'});
    document.getElementById('currentTime').textContent=now.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'});
    document.getElementById('lastUpdate').textContent='Updated '+now.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
}

loadData();
updateClock();
setInterval(updateClock,1000);
setInterval(loadData,30000);
</script>
</body>
</html>
