<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>RockRunner Driver</title>
<link rel="icon" href="driver-logo.jpg" type="image/jpeg">
<link rel="apple-touch-icon" href="driver-logo.jpg">
<style>
:root {
  --navy: #001F3F;
  --navy-light: #0a2d52;
  --orange: #C65D2A;
  --green: #22c55e;
  --green-dim: rgba(34,197,94,0.15);
  --yellow: #eab308;
  --blue: #3b82f6;
  --red: #ef4444;
  --purple: #a855f7;
  --surface: #0f1923;
  --surface2: #162230;
  --border: #1e3347;
  --text: #e4e8ef;
  --text-dim: #7a8da0;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
  background: var(--navy);
  color: var(--text);
  min-height: 100vh;
  -webkit-user-select: none;
  user-select: none;
}

/* â”€â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.header {
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  padding: 16px 20px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  position: sticky;
  top: 0;
  z-index: 50;
}
.header-left {
  display: flex;
  align-items: center;
  gap: 12px;
}
.header h1 {
  font-size: 24px;
  font-weight: 800;
  color: var(--orange);
}
.header-date {
  font-size: 15px;
  font-weight: 600;
  color: var(--text-dim);
}
.driver-badge {
  background: var(--surface2);
  border: 1px solid var(--border);
  padding: 8px 16px;
  border-radius: 10px;
  font-size: 16px;
  font-weight: 700;
}

/* â”€â”€â”€ LOGIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.login-screen {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-height: 100vh;
  padding: 40px 20px;
}
.login-logo { width: 220px; height: 220px; border-radius: 28px; margin-bottom: 28px; object-fit: cover; }
.login-title { font-size: 42px; font-weight: 800; color: var(--orange); margin-bottom: 10px; letter-spacing: -0.5px; }
.login-sub { color: var(--text-dim); margin-bottom: 36px; font-size: 20px; font-weight: 600; }
.login-input {
  width: 100%;
  max-width: 360px;
  padding: 20px 24px;
  background: var(--surface2);
  border: 2px solid var(--border);
  border-radius: 14px;
  color: var(--text);
  font-size: 32px;
  font-weight: 700;
  text-align: center;
  letter-spacing: 14px;
  font-family: inherit;
  margin-bottom: 20px;
}
.login-input:focus { outline: none; border-color: var(--orange); }
.login-btn {
  width: 100%;
  max-width: 360px;
  padding: 20px;
  background: var(--orange);
  border: none;
  border-radius: 14px;
  color: #fff;
  font-size: 22px;
  font-weight: 800;
  cursor: pointer;
  letter-spacing: 0.5px;
}

/* â”€â”€â”€ ROUTE LIST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.route-list { padding: 16px; display: flex; flex-direction: column; gap: 16px; }
.empty-route {
  text-align: center;
  padding: 80px 20px;
  color: var(--text-dim);
  font-size: 20px;
  font-weight: 600;
  line-height: 1.5;
}

/* â”€â”€â”€ STOP CARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.stop-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 14px;
  overflow: hidden;
}
.stop-header {
  padding: 18px 18px;
  display: flex;
  align-items: center;
  gap: 16px;
}
.stop-number {
  width: 56px;
  height: 56px;
  border-radius: 50%;
  background: var(--orange);
  color: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 800;
  font-size: 24px;
  flex-shrink: 0;
}
.stop-number.completed { background: var(--green); }
.stop-number.active { background: var(--purple); animation: pulse 1.5s infinite; }
@keyframes pulse { 0%,100%{box-shadow:0 0 0 0 rgba(168,85,247,0.4)} 50%{box-shadow:0 0 0 8px rgba(168,85,247,0)} }
.stop-info { flex: 1; }
.stop-customer { font-size: 22px; font-weight: 800; color: #fff; }
.stop-material { font-size: 17px; font-weight: 700; color: var(--text-dim); margin-top: 3px; }
.stop-tons { font-size: 24px; font-weight: 800; color: var(--orange); }

.stop-body {
  padding: 0 18px 16px;
}
.stop-address {
  font-size: 18px;
  font-weight: 600;
  color: var(--text);
  margin-bottom: 10px;
}
.stop-time {
  font-size: 16px;
  font-weight: 600;
  color: var(--text-dim);
  margin-bottom: 12px;
}
.stop-notes {
  font-size: 16px;
  color: var(--yellow);
  background: rgba(234,179,8,0.08);
  padding: 12px 16px;
  border-radius: 8px;
  margin-bottom: 12px;
  font-weight: 700;
}
.stop-pickup {
  font-size: 15px;
  font-weight: 600;
  color: var(--blue);
  margin-bottom: 10px;
}

/* â”€â”€â”€ ACTION BUTTONS (BIG â€” glove-friendly) â”€â”€â”€â”€ */
.stop-actions {
  display: flex;
  gap: 8px;
  padding: 0 16px 16px;
}
.action-btn {
  flex: 1;
  padding: 20px;
  border-radius: 14px;
  border: none;
  font-size: 19px;
  font-weight: 800;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  min-height: 72px;
  transition: transform 0.1s;
}
.action-btn:active { transform: scale(0.97); }
.btn-navigate {
  background: var(--blue);
  color: #fff;
}
.btn-enroute {
  background: var(--purple);
  color: #fff;
}
.btn-delivered {
  background: var(--green);
  color: #fff;
}
.btn-call {
  background: var(--surface2);
  border: 1px solid var(--border);
  color: var(--text);
  flex: 0;
  width: 72px;
}
.btn-pickup {
  background: var(--blue);
  color: #fff;
}
.btn-loaded {
  background: var(--green);
  color: #fff;
}
.btn-disabled {
  background: var(--surface2) !important;
  color: var(--text-dim) !important;
  cursor: default;
  border: 1px solid var(--border);
}

/* â”€â”€â”€ COMPLETED OVERLAY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.stop-card.completed {
  opacity: 0.55;
}
.stop-card.completed .stop-header {
  padding-bottom: 6px;
}
.completed-badge {
  padding: 10px 18px;
  font-size: 15px;
  color: var(--green);
  font-weight: 700;
  border-top: 1px solid var(--border);
}

/* â”€â”€â”€ EN ROUTE CARD HIGHLIGHT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.stop-card.enroute {
  border-color: var(--purple);
  border-width: 2px;
}

/* â”€â”€â”€ PHOTO CAPTURE MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.photo-modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.9);
  z-index: 200;
  display: none;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 20px;
}
.photo-modal.active { display: flex; }
.photo-preview {
  width: 100%;
  max-width: 400px;
  aspect-ratio: 4/3;
  background: var(--surface2);
  border-radius: 12px;
  overflow: hidden;
  margin-bottom: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
}
.photo-preview img { width: 100%; height: 100%; object-fit: cover; }
.photo-placeholder { color: var(--text-dim); font-size: 14px; text-align: center; }
.photo-actions {
  display: flex;
  gap: 12px;
  width: 100%;
  max-width: 400px;
}
.photo-actions .action-btn { min-height: 52px; }

/* â”€â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.toast {
  position: fixed;
  bottom: 30px;
  left: 50%;
  transform: translateX(-50%) translateY(80px);
  background: var(--green);
  color: #fff;
  padding: 14px 24px;
  border-radius: 12px;
  font-size: 15px;
  font-weight: 600;
  z-index: 300;
  opacity: 0;
  transition: all 0.3s;
  white-space: nowrap;
}
.toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
.toast.error { background: var(--red); }

/* â”€â”€â”€ SUMMARY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.day-summary {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 14px;
  padding: 20px 16px;
  margin: 12px 16px 16px;
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 12px;
  text-align: center;
}
.summary-item { }
.summary-num { font-size: 32px; font-weight: 800; }
.summary-label { font-size: 13px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.5px; margin-top: 2px; font-weight: 600; }

/* â”€â”€â”€ TRUCK BADGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.truck-badge {
  background: rgba(198,93,42,0.15);
  border: 1px solid rgba(198,93,42,0.4);
  color: var(--orange);
  padding: 10px 20px;
  border-radius: 12px;
  font-size: 26px;
  font-weight: 800;
  text-align: center;
  margin: 0 16px;
  letter-spacing: 0.5px;
}

/* â”€â”€â”€ TRUCK SELECTOR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.truck-switch-hint {
  font-size: 13px;
  font-weight: 500;
  color: var(--text-dim);
  margin-left: 6px;
}
.truck-picker {
  position: fixed;
  inset: 0;
  z-index: 100;
  display: none;
  align-items: flex-end;
  justify-content: center;
}
.truck-picker-backdrop {
  position: absolute;
  inset: 0;
  background: rgba(0,0,0,0.6);
}
.truck-picker-sheet {
  position: relative;
  width: 100%;
  max-width: 420px;
  background: var(--surface);
  border-top-left-radius: 20px;
  border-top-right-radius: 20px;
  padding: 24px 16px;
  padding-bottom: max(24px, env(safe-area-inset-bottom));
  display: flex;
  flex-direction: column;
  gap: 8px;
}
.truck-picker-title {
  font-size: 20px;
  font-weight: 800;
  color: var(--text);
  text-align: center;
  margin-bottom: 8px;
}
.truck-picker-option {
  display: flex;
  align-items: center;
  gap: 14px;
  padding: 18px 16px;
  border-radius: 14px;
  border: 2px solid var(--border);
  background: var(--surface2);
  color: var(--text);
  font-size: 20px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.15s;
}
.truck-picker-option:active { transform: scale(0.97); }
.truck-picker-option.active {
  border-color: var(--orange);
  background: rgba(198,93,42,0.15);
}
.truck-picker-icon { font-size: 28px; }
.truck-picker-name { flex: 1; }
.truck-picker-check {
  color: var(--orange);
  font-size: 22px;
  font-weight: 800;
}
.truck-picker-cancel {
  margin-top: 4px;
  padding: 16px;
  border-radius: 14px;
  border: none;
  background: var(--surface2);
  color: var(--text-dim);
  font-size: 17px;
  font-weight: 700;
  cursor: pointer;
}
</style>
</head>
<body>

<!-- â•â•â• LOGIN SCREEN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="loginScreen" class="login-screen">
  <img src="driver-logo.jpg" alt="RockRunner" class="login-logo">
  <div class="login-title">RockRunner Driver</div>
  <div class="login-sub">Enter your 4-digit PIN</div>
  <input class="login-input" id="pinInput" type="password" maxlength="4" inputmode="numeric" placeholder="Â·Â·Â·Â·">
  <button class="login-btn" onclick="login()">Sign In</button>
</div>

<!-- â•â•â• MAIN APP â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="mainApp" style="display:none;">
  <div class="header">
    <div class="header-left">
      <h1>ğŸš› My Routes</h1>
    </div>
    <div>
      <div class="driver-badge" id="driverBadge">Driver</div>
      <div class="header-date" id="headerDate"></div>
    </div>
  </div>

  <div class="truck-badge" id="truckBadge" style="display:none;"></div>

  <div style="display:flex;gap:8px;padding:12px 16px 0;">
    <button id="btnToday" onclick="setDay(false)" style="flex:1;padding:10px;border-radius:20px;border:2px solid var(--orange);background:var(--orange);color:#fff;font-size:15px;font-weight:700;cursor:pointer;">Today</button>
    <button id="btnTomorrow" onclick="setDay(true)" style="flex:1;padding:10px;border-radius:20px;border:2px solid var(--border);background:transparent;color:var(--text-dim);font-size:15px;font-weight:700;cursor:pointer;">Tomorrow</button>
  </div>

  <div class="day-summary" id="daySummary">
    <div class="summary-item">
      <div class="summary-num" id="sumStops">0</div>
      <div class="summary-label">Stops</div>
    </div>
    <div class="summary-item">
      <div class="summary-num" id="sumTons">0</div>
      <div class="summary-label">Tons</div>
    </div>
    <div class="summary-item">
      <div class="summary-num" id="sumDone">0</div>
      <div class="summary-label">Delivered</div>
    </div>
  </div>

  <div class="route-list" id="routeList">
    <div class="empty-route">Loading your route...</div>
  </div>
</div>

<!-- â•â•â• PHOTO CAPTURE MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="photo-modal" id="photoModal">
  <div style="color:var(--text);font-size:18px;font-weight:700;margin-bottom:16px;">Delivery Photo</div>
  <div class="photo-preview" id="photoPreview">
    <div class="photo-placeholder">Tap below to take photo</div>
  </div>
  <div id="photoCount" style="color:var(--text-dim);font-size:14px;font-weight:600;margin-bottom:8px;display:none;"></div>
  <div class="photo-actions" id="photoActionsInitial">
    <button class="action-btn" style="background:var(--surface2);border:1px solid var(--border);color:var(--text);" onclick="closePhoto()">Cancel</button>
    <button class="action-btn" style="background:var(--blue);color:#fff;" onclick="takePhoto()">ğŸ“· Take Photo</button>
  </div>
  <div class="photo-actions" id="photoActionsAfter" style="display:none;">
    <button class="action-btn" style="background:var(--surface2);border:1px solid var(--border);color:var(--text);" onclick="addAnotherPhoto()">â• Add Photo</button>
    <button class="action-btn btn-delivered" id="confirmDeliverBtn" onclick="confirmDelivery()">âœ“ Done</button>
  </div>
  <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display:none;">
</div>

<div class="toast" id="toast"></div>

<script>
const API = '/.netlify/functions';
let currentDriver = null;
let currentTruckId = null;
let myTrucks = [];
let myDeliveries = [];
let materialWeights = {}; // materialName â†’ tons/CYD
let activeDeliveryId = null;
let capturedPhoto = null;
let capturedPhotos = []; // multi-photo accumulator
let gpsWatchId = null;
let lastGpsSend = 0;
let viewingTomorrow = false;
let viewingDate = new Date();
let pickupCompleted = {}; // deliveryId â†’ true (client-side, resets on reload)

// â”€â”€â”€ GPS TRACKING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startGpsTracking() {
  if (!navigator.geolocation) return;
  gpsWatchId = navigator.geolocation.watchPosition(
    (pos) => {
      const now = Date.now();
      if (now - lastGpsSend < 60000) return; // throttle to once per 60s
      lastGpsSend = now;
      fetch(`${API}/driver-location`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          driverId: currentDriver.id,
          driverName: currentDriver.name,
          lat: pos.coords.latitude,
          lng: pos.coords.longitude,
          heading: pos.coords.heading,
          speed: pos.coords.speed
        })
      }).catch(() => {});
    },
    () => {}, // silently ignore errors
    { enableHighAccuracy: true, maximumAge: 30000 }
  );
}

window.addEventListener('beforeunload', () => {
  if (gpsWatchId != null) navigator.geolocation.clearWatch(gpsWatchId);
});

// â”€â”€â”€ LOGIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('pinInput').addEventListener('keyup', e => { if (e.key === 'Enter') login(); });

async function login() {
  const pin = document.getElementById('pinInput').value;
  if (pin.length !== 4) { toast('Enter 4-digit PIN', true); return; }

  try {
    const res = await fetch(`${API}/drivers`);
    const data = await res.json();
    const match = (data.drivers || []).find(d => d.pin === pin);
    if (!match) { toast('Invalid PIN', true); return; }
    currentDriver = { id: match.driverId, name: match.name, phone: match.phone || '' };
  } catch(e) {
    toast('Connection error â€” try again', true);
    return;
  }

  document.getElementById('loginScreen').style.display = 'none';
  document.getElementById('mainApp').style.display = 'block';
  document.getElementById('driverBadge').textContent = currentDriver.name;

  // Look up ALL assigned trucks
  try {
    const tr = await fetch(`${API}/trucks`);
    const td = await tr.json();
    myTrucks = (td.trucks || []).filter(t => t.defaultDriver?.id === currentDriver.id);
    if (myTrucks.length > 0) {
      selectTruck(myTrucks[0]);
      renderTruckSelector();
    }
  } catch(e) { /* truck lookup optional */ }

  const d = new Date();
  const days = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  document.getElementById('headerDate').textContent = `${days[d.getDay()]}, ${months[d.getMonth()]} ${d.getDate()}`;

  startGpsTracking();
  await loadMyRoute();
}

// â”€â”€â”€ TRUCK SELECTOR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function selectTruck(truck) {
  currentTruckId = truck._id?.toString() || truck._id;
  document.getElementById('truckBadge').style.display = '';

  if (myTrucks.length > 1) {
    document.getElementById('truckBadge').innerHTML = 'ğŸš› ' + truck.truckNumber + ' <span class="truck-switch-hint">â–¼ tap to switch</span>';
    document.getElementById('truckBadge').onclick = showTruckPicker;
    document.getElementById('truckBadge').style.cursor = 'pointer';
  } else {
    document.getElementById('truckBadge').textContent = 'ğŸš› ' + truck.truckNumber;
    document.getElementById('truckBadge').onclick = null;
    document.getElementById('truckBadge').style.cursor = 'default';
  }
}

function renderTruckSelector() {
  if (myTrucks.length < 2) return;
  if (!document.getElementById('truckPicker')) {
    const picker = document.createElement('div');
    picker.id = 'truckPicker';
    picker.className = 'truck-picker';
    document.body.appendChild(picker);
  }
}

function showTruckPicker() {
  const picker = document.getElementById('truckPicker');
  if (!picker) return;

  picker.innerHTML = `
    <div class="truck-picker-backdrop" onclick="closeTruckPicker()"></div>
    <div class="truck-picker-sheet">
      <div class="truck-picker-title">Switch Truck</div>
      ${myTrucks.map(t => {
        const truckId = t._id?.toString() || t._id;
        const isActive = truckId === currentTruckId;
        return `<button class="truck-picker-option ${isActive ? 'active' : ''}" onclick="pickTruck('${truckId}')">
          <span class="truck-picker-icon">ğŸš›</span>
          <span class="truck-picker-name">${t.truckNumber}</span>
          ${isActive ? '<span class="truck-picker-check">âœ“</span>' : ''}
        </button>`;
      }).join('')}
      <button class="truck-picker-cancel" onclick="closeTruckPicker()">Cancel</button>
    </div>
  `;
  picker.style.display = 'flex';
}

function pickTruck(truckId) {
  const truck = myTrucks.find(t => (t._id?.toString() || t._id) === truckId);
  if (!truck) return;
  selectTruck(truck);
  closeTruckPicker();
  loadMyRoute();
}

function closeTruckPicker() {
  const picker = document.getElementById('truckPicker');
  if (picker) picker.style.display = 'none';
}

// â”€â”€â”€ DAY TOGGLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setDay(tomorrow) {
  viewingTomorrow = tomorrow;
  viewingDate = new Date();
  if (tomorrow) viewingDate.setDate(viewingDate.getDate() + 1);
  document.getElementById('btnToday').style.cssText    = 'flex:1;padding:10px;border-radius:20px;border:2px solid var(--' + (!tomorrow ? 'orange);background:var(--orange);color:#fff' : 'border);background:transparent;color:var(--text-dim)') + ';font-size:15px;font-weight:700;cursor:pointer;';
  document.getElementById('btnTomorrow').style.cssText = 'flex:1;padding:10px;border-radius:20px;border:2px solid var(--' + (tomorrow  ? 'orange);background:var(--orange);color:#fff' : 'border);background:transparent;color:var(--text-dim)') + ';font-size:15px;font-weight:700;cursor:pointer;';
  loadMyRoute();
}

// â”€â”€â”€ LOAD ROUTE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadMyRoute() {
  const chiNow = new Date(new Date().toLocaleString('en-US', { timeZone: 'America/Chicago' }));
  if (viewingTomorrow) chiNow.setDate(chiNow.getDate() + 1);
  const dateStr = chiNow.getFullYear() + '-' + String(chiNow.getMonth()+1).padStart(2,'0') + '-' + String(chiNow.getDate()).padStart(2,'0');

  try {
    const filterParam = currentTruckId
      ? `truckId=${currentTruckId}`
      : `driverId=${currentDriver.id}`;
    const [data, prodData] = await Promise.all([
      fetch(`${API}/dispatch?date=${dateStr}&${filterParam}`).then(r => r.json()),
      Object.keys(materialWeights).length === 0
        ? fetch(`${API}/products`).then(r => r.json())
        : Promise.resolve(null)
    ]);
    myDeliveries = (data.deliveries || [])
      .filter(d => d.status !== 'CANCELLED')
      .sort((a,b) => (a.stopOrder || 99) - (b.stopOrder || 99));
    if (prodData) {
      (prodData.materials || []).forEach(p => { if (p.weight) materialWeights[p.name] = p.weight; });
    }
  } catch(e) {
    myDeliveries = [];
    console.error(e);
  }
  renderRoute();
}

function renderRoute() {
  const list = document.getElementById('routeList');

  // Summary
  const total = myDeliveries.length;
  const tons = myDeliveries.reduce((s,d) => s + (d.quantity || 0), 0);
  const done = myDeliveries.filter(d => d.status === 'DELIVERED').length;
  document.getElementById('sumStops').textContent = total;
  document.getElementById('sumTons').textContent = tons.toFixed(1);
  document.getElementById('sumDone').textContent = done;

  if (!myDeliveries.length) {
    list.innerHTML = viewingTomorrow
      ? '<div class="empty-route">No deliveries scheduled for tomorrow yet.</div>'
      : '<div class="empty-route">No deliveries assigned for today.<br>Check back after dispatch is finalized.</div>';
    return;
  }

  // Sort: active deliveries first (by stopOrder), completed at bottom
  const sorted = [...myDeliveries].sort((a, b) => {
    const aDelivered = a.status === 'DELIVERED' ? 1 : 0;
    const bDelivered = b.status === 'DELIVERED' ? 1 : 0;
    if (aDelivered !== bDelivered) return aDelivered - bDelivered;
    return (a.stopOrder || 99) - (b.stopOrder || 99);
  });

  list.innerHTML = sorted.map((d, i) => {
    const isCompleted = d.status === 'DELIVERED';
    const isCancelled = d.status === 'CANCELLED';
    const isEnRoute = d.status === 'EN_ROUTE';
    const hasSource = d.sourceName && d.sourceName.trim();
    const isYardPickup = !hasSource || d.sourceName.toLowerCase().includes('conroe');

    // Auto-skip pickup phase if no source info
    if (!hasSource) pickupCompleted[d._id] = true;

    const isPickedUp = pickupCompleted[d._id] || false;
    const stopNum = i + 1;

    if (isCancelled) return '';

    if (isCompleted) {
      return `<div class="stop-card completed">
        <div class="stop-header">
          <div class="stop-number completed">âœ“</div>
          <div class="stop-info">
            <div class="stop-customer">${d.customerName || 'Customer'}</div>
            <div class="stop-material">${d.materialName || 'Material'}</div>
          </div>
          <div class="stop-tons">${(() => {
            const tons = parseFloat(d.quantity);
            if (!d.quantity || isNaN(tons)) return '?';
            const w = materialWeights[d.materialName];
            return w ? `${(tons/w).toFixed(1)}<small style="font-size:14px"> CYD</small><br>${tons.toFixed(1)}T` : `${tons.toFixed(1)}T`;
          })()}</div>
        </div>
        <div class="completed-badge">
          âœ… Delivered${d.deliveredAt ? ' Â· ' + new Date(d.deliveredAt).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true }) : ''}
        </div>
      </div>`;
    }

    const multiLoadHeader = (d.totalLoads > 1)
      ? `<div style="background:rgba(234,179,8,0.12);border-bottom:1px solid rgba(234,179,8,0.2);padding:8px 18px;font-size:13px;font-weight:700;color:#eab308;">
          ${d.materialName} â†’ ${d.customerName || 'Customer'} &nbsp;Â·&nbsp; Load ${d.loadNumber} of ${d.totalLoads} &nbsp;Â·&nbsp; ${d.quantity}t this load
        </div>`
      : '';

    return `<div class="stop-card ${isEnRoute ? 'enroute' : ''}">
      ${multiLoadHeader}
      <div class="stop-header">
        <div class="stop-number ${isEnRoute ? 'active' : ''}">${stopNum}</div>
        <div class="stop-info">
          <div class="stop-customer">${d.customerName || 'Customer'}</div>
          <div class="stop-material">${d.materialName || 'Material'}</div>
        </div>
        <div class="stop-tons">${(() => {
          const tons = parseFloat(d.quantity);
          if (!d.quantity || isNaN(tons)) return '?';
          const w = materialWeights[d.materialName];
          return w ? `${(tons/w).toFixed(1)}<small style="font-size:14px"> CYD</small><br>${tons.toFixed(1)}T` : `${tons.toFixed(1)}T`;
        })()}</div>
      </div>
      <div class="stop-body">
        ${hasSource ? `<div class="stop-pickup">ğŸ­ Pickup: ${isYardPickup ? 'Conroe Yard' : d.sourceName}${!isYardPickup && d.sourceAddress ? '<br><span style="font-size:13px;color:var(--text-dim);">' + d.sourceAddress + '</span>' : ''}</div>` : ''}
        <div class="stop-address">ğŸ“ ${d.deliveryAddress || ''}${d.deliveryCity ? ', ' + d.deliveryCity : ''} ${d.deliveryZip || ''}</div>
        ${d.timeWindow ? `<div class="stop-time">ğŸ• ${d.timeWindow}</div>` : ''}
        ${d.deliveryNotes ? `<div class="stop-notes">âš ï¸ ${d.deliveryNotes}</div>` : ''}
      </div>
      <div class="stop-actions">
        ${d.customerPhone ? `<button class="action-btn btn-call" onclick="callCustomer('${d.customerPhone}')">ğŸ“</button>` : ''}
        ${!isEnRoute ? `
          ${!isPickedUp ? `
            <button class="action-btn btn-pickup" onclick="navigateToPickup('${d._id}', '${encodeURIComponent(isYardPickup ? '30.3119,-95.4561' : (d.sourceAddress || ''))}', ${isYardPickup})">ğŸ­ Pickup</button>
            <button class="action-btn btn-loaded" onclick="markLoaded('${d._id}')">âœ… Loaded</button>
          ` : `
            <button class="action-btn btn-navigate" onclick="navigate('${encodeURIComponent(d.deliveryAddress + ', ' + (d.deliveryCity||'') + ' ' + (d.deliveryState||'TX') + ' ' + (d.deliveryZip||''))}', ${d.deliveryLat || 'null'}, ${d.deliveryLng || 'null'})">ğŸ§­ Deliver</button>
            <button class="action-btn btn-enroute" onclick="markEnRoute('${d._id}')">ğŸš› En Route</button>
          `}
        ` : `
          <button class="action-btn btn-navigate" onclick="navigate('${encodeURIComponent(d.deliveryAddress + ', ' + (d.deliveryCity||'') + ' ' + (d.deliveryState||'TX') + ' ' + (d.deliveryZip||''))}', ${d.deliveryLat || 'null'}, ${d.deliveryLng || 'null'})">ğŸ§­ Navigate</button>
          <button class="action-btn btn-delivered" onclick="startDeliveryPhoto('${d._id}')">ğŸ“¸ Delivered</button>
        `}
      </div>
    </div>`;
  }).join('');
}

// â”€â”€â”€ ACTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function navigate(address, lat, lng) {
  let url;
  if (lat && lng && lat !== 'null' && lng !== 'null') {
    // Use coordinates for pin-dropped deliveries â€” more accurate
    url = `https://maps.google.com/maps?daddr=${lat},${lng}`;
  } else {
    url = `https://maps.google.com/maps?daddr=${address}`;
  }
  window.open(url, '_blank');
}

// â”€â”€â”€ PICKUP NAVIGATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function navigateToPickup(deliveryId, sourceAddress, isYard) {
  let url;
  if (isYard) {
    url = 'https://maps.google.com/maps?daddr=30.3119,-95.4561';
  } else {
    url = `https://maps.google.com/maps?daddr=${sourceAddress}`;
  }
  window.open(url, '_blank');
}

function markLoaded(deliveryId) {
  if (!confirm('Confirm: Material loaded and ready for delivery?')) return;
  pickupCompleted[deliveryId] = true;
  toast('Material loaded! Navigate to delivery site.');
  renderRoute();
}

function callCustomer(phone) {
  window.location.href = `tel:${phone}`;
}

async function markEnRoute(deliveryId) {
  if (!confirm('Mark as En Route? Customer will be notified.')) return;

  try {
    // Update status + send SMS via notify function
    const [statusRes, notifyRes] = await Promise.all([
      fetch(`${API}/dispatch`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          id: deliveryId,
          status: 'EN_ROUTE',
          updatedBy: currentDriver.id
        })
      }),
      fetch(`${API}/notify`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          type: 'en_route',
          deliveryId,
          driverId: currentDriver.id,
          etaMinutes: 30 // Default â€” could calculate from GPS
        })
      })
    ]);

    toast('Customer notified â€” you\'re en route!');
    await loadMyRoute();
  } catch(e) { toast('Error updating status', true); console.error(e); }
}

// â”€â”€â”€ PHOTO DELIVERY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startDeliveryPhoto(deliveryId) {
  activeDeliveryId = deliveryId;
  capturedPhoto = null;
  capturedPhotos = [];
  document.getElementById('photoPreview').innerHTML = '<div class="photo-placeholder">Tap below to take photo</div>';
  document.getElementById('photoCount').style.display = 'none';
  document.getElementById('photoActionsInitial').style.display = 'flex';
  document.getElementById('photoActionsAfter').style.display = 'none';
  document.getElementById('photoModal').classList.add('active');
}

function takePhoto() {
  const input = document.getElementById('cameraInput');
  input.value = '';
  input.click();
}

document.getElementById('cameraInput').addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function(ev) {
    capturedPhoto = ev.target.result;
    capturedPhotos.push(ev.target.result);
    document.getElementById('photoPreview').innerHTML = `<img src="${capturedPhoto}" alt="Delivery photo">`;
    const count = capturedPhotos.length;
    const countEl = document.getElementById('photoCount');
    countEl.textContent = `${count} photo${count > 1 ? 's' : ''} captured`;
    countEl.style.display = 'block';
    document.getElementById('photoActionsInitial').style.display = 'none';
    document.getElementById('photoActionsAfter').style.display = 'flex';
  };
  reader.readAsDataURL(file);
});

function addAnotherPhoto() {
  const input = document.getElementById('cameraInput');
  input.value = '';
  input.click();
}

async function confirmDelivery() {
  if (!capturedPhotos.length || !activeDeliveryId) return;

  const confirmBtn = document.getElementById('confirmDeliverBtn');
  confirmBtn.disabled = true;

  try {
    // Step 1: Upload all captured photos to Cloudinary
    const photoUrls = [];
    for (let i = 0; i < capturedPhotos.length; i++) {
      confirmBtn.textContent = `Uploading ${i + 1}/${capturedPhotos.length}...`;
      const uploadRes = await fetch(`${API}/upload-photo`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ image: capturedPhotos[i], deliveryId: activeDeliveryId })
      });
      const uploadData = await uploadRes.json();
      if (!uploadData.success) throw new Error(uploadData.error || 'Photo upload failed');
      photoUrls.push(uploadData.url);
    }

    confirmBtn.textContent = 'Saving delivery...';

    // Step 2: Save delivery with all photo URLs
    const r = await fetch(`${API}/dispatch`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        id: activeDeliveryId,
        status: 'DELIVERED',
        deliveryPhoto: photoUrls[0],   // backward compat (single URL)
        proofPhotos: photoUrls,         // full array
        updatedBy: currentDriver.id,
        notes: 'Delivered with photo confirmation'
      })
    });
    const data = await r.json();
    if (data.success) {
      // Step 3: Send thank-you notification (fire-and-forget)
      const confirmedDeliveryId = activeDeliveryId;
      fetch(`${API}/notify`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ type: 'delivered', deliveryId: confirmedDeliveryId })
      }).catch(err => console.error('Delivered notification error:', err));

      // Step 4: Schedule Trustpilot review request â€” 5 minutes after delivery
      setTimeout(() => {
        fetch(`${API}/notify`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ type: 'review_request', deliveryId: confirmedDeliveryId })
        }).catch(err => console.error('Review request error:', err));
      }, 5 * 60 * 1000);

      // Check for next load in a multi-load fulfillment group (3G)
      const confirmedDelivery = myDeliveries.find(d => d._id === confirmedDeliveryId);
      if (confirmedDelivery && confirmedDelivery.totalLoads > 1 && confirmedDelivery.loadNumber < confirmedDelivery.totalLoads) {
        const nextNum = confirmedDelivery.loadNumber + 1;
        toast(`Load ${confirmedDelivery.loadNumber} of ${confirmedDelivery.totalLoads} complete âœ… â€” Starting Load ${nextNum}`);
      } else {
        toast('Delivery confirmed! Customer notified.');
      }
      closePhoto();
      await loadMyRoute();
    }
  } catch(e) {
    toast('Error confirming delivery', true);
    console.error(e);
    confirmBtn.disabled = false;
    confirmBtn.textContent = 'âœ“ Done';
  }
}

function closePhoto() {
  document.getElementById('photoModal').classList.remove('active');
  activeDeliveryId = null;
  capturedPhoto = null;
  capturedPhotos = [];
}

// â”€â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toast(msg, error = false) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.className = 'toast show' + (error ? ' error' : '');
  setTimeout(() => el.className = 'toast', 3000);
}
</script>
</body>
</html>
